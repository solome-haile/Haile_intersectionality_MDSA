---
title: "Intersec_R&R#2_FINAL"
author: "Solome Haile"
date: "2025-12-19"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(labelled)
library(tidyverse)
library(stargazer)
library(haven)
library(rsample)
library(readstata13)
library(naniar)
library(Amelia)
library(cluster)
library(dplyr)
library(ggplot2)
library(reshape)
library(reshape2)
library(stats)
library(TraMineR)
library(TraMineRextras)
library(mice)
library(VGAM)
library(factoextra)
library(cluster)
library(gridExtra)
library(nnet)
library(foreign)
library(table1)
library(kableExtra)
library(RColorBrewer)
library(seqhandbook)
library(seqHMM)
library(WeightedCluster)
library(modelsummary)
library(webshot2)
library(DescTools)
library(seqimpute)
library(MASS)
library(brant)
library(psych)
library(ggpubr)
set.seed(08540)
#setting working directory
# setwd("/Users/solomonaberash/Desktop/Graduate School/Intersec Paper:F22 Research App/Intersec_Haile")
```

# LOADING DATA

```{r, warning=FALSE}
## loading new data with two additional waves
FF <- read.dta13("FF_allwaves_2024v3.dta")

FF <- rowid_to_column(FF, "index")
```

# DATA PREP 

## Data Cleaning and Wrangling
```{r}
#subsetting data 
FF_adversity_FULL_0 <- FF %>%  
  subset(select = c(#whether father was in jail at time of interview (Y1-Y9) 
                    cm2finjail,cm3finjail, cm4finjail, cm5finjail,  
                    #whether of father of focal child has problems (i.e. job,  
                    #relationships) bc drugs (Y1-Y9) 
                    m2c35, m3c44, m4c39, m5b32,
                    #whether father ever in jail (Y1-Y9)
                    cm2fevjail, cm3ffevjail, cm4ffevjail,cm5ffevjail,
                    #whether telephone disconnected bc not enough money in past yr (Y1-Y9) 
                    m2h19h, m3i6a, m4i23n, m5f23k,
                    #whether evicted in past year (Y1-Y9) 
                    m2h19e, m3i23c, m4i23e, m5f23d,   
                    #whether lived in non-reg housing in past yr (Y1-Y9) 
                    m2h19k, m3i23g, m4i23j, m5f23i,  
                    #whether moved bc of financial problems (Y1-Y9) 
                    m2h19j, m3i23f, m4i23i, m5f23h, 
                    #whether gas/electric shut off bc lack of money (Y1-Y9) 
                    m2h19g, m3i6f, m4i23g, m5f23f,
                    #whether mom had emergency care-giving (Y1-Y9) 
                    m2g6c, m3h5, m4h5, m5e5, 
                    #whether mother could count on someone to loan $1000 in the  
                    #next year (Y1-Y9) 
                    m2g6a1, m3h3a, m4h3a, m5e3a,
                    #whether mother could count on someone to loan $200 in the  
                    #next year (Y1-Y9) 
                    m2g6a, m3h3, m4h3, m5e3,
                    #whether mother could count on someone to co-sign a $1000  
                    #loan in the next year (Y1-Y9) 
                    m2g6d, m3h6, m4h6, m5e6,
                    ##DEMOG VARIABLES/COVARIATES
                    #race/ethnicity of mothers
                    cm1ethrace,  
                    #mother's education (base-Y9; ordered categorical) 
                    cm1edu,cm2edu, cm3edu, cm4edu, cm5edu, 
                    #household income (Y1-Y9) 
                    cm1hhinc, cm2hhinc, cm3hhinc, cm4hhinc, cm5hhinc,
                    #mother's age at birth of focal child 
                    cm1age, 
                    #number of previous biological children born prior to focal kid 
                    m1a12a,  
                    #whether mother was married to bio dad (baseline) 
                    cm1marf, 
                    #whether mother is cohabitating with bio dad (baseline) 
                    cm1cohf))  


#renaming columns
colnames(FF_adversity_FULL_0) <- c("wave1_fjail","wave2_fjail","wave3_fjail",
                                  "wave4_fjail",
                                  "wave1_fprobs","wave2_fprobs","wave3_fprobs",
                                  "wave4_fprobs",
                                  "wave1_feverjail", "wave2_feverjail",
                                  "wave3_feverjail","wave4_feverjail",
                                  "wave1_tele","wave2_tele","wave3_tele","wave4_tele",
                                  "wave1_evict","wave2_evict","wave3_evict",
                                  "wave4_evict",
                                  "wave1_nonreghouse","wave2_nonreghouse",
                                  "wave3_nonreghouse","wave4_nonreghouse",
                                  "wave1_moneymove","wave2_moneymove","wave3_moneymove",
                                  "wave4_moneymove",
                                  "wave1_gaselec","wave2_gaselec","wave3_gaselec",
                                  "wave4_gaselec",
                                  "wave1_emcare","wave2_emcare","wave3_emcare",
                                  "wave4_emcare",
                                  "wave1_1kloan","wave2_1kloan","wave3_1kloan",
                                  "wave4_1kloan",
                                  "wave1_200loan","wave2_200loan","wave3_200loan",
                                  "wave4_200loan",
                                  "wave1_1kcosign","wave2_1kcosign","wave3_1kcosign",
                                  "wave4_1kcosign",
                                  "mo_race_eth",
                                  "mo_edu_wave0", "mo_edu_wave1", "mo_edu_wave2",
                                  "mo_edu_wave3", "mo_edu_wave4",
                                  "mo_hh_income_wave0", "mo_hh_income_wave1",
                                  "mo_hh_income_wave2","mo_hh_income_wave3",
                                  "mo_hh_income_wave4",
                                  "mo_age_wave0",
                                  "mo_prev_kids_wave0",
                                  "mo_married_wave0",
                                  "mo_cohab_wave0")

FF_adversity_FULL <- FF_adversity_FULL_0
  
#previewing data
# head(FF_adversity_FULL)

#changing class of variables for recoding
for(i in 1:48){
  FF_adversity_FULL[,i] <- to_character(FF_adversity_FULL[,i])
}

for(i in 62:63){
  FF_adversity_FULL[,i] <- to_character(FF_adversity_FULL[,i])
}

#cleaning missing data
FF_adversity_FULL[FF_adversity_FULL == "-3 Missing"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-3"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-9 Not in wave"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-9"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-6 skip"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-6 Skip"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-6"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-2 Don't know"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-10 no child(ren)/ no need for care"] <- "2 No"
FF_adversity_FULL[FF_adversity_FULL == "-1 Refuse"] <- NA 
FF_adversity_FULL[FF_adversity_FULL == "-1"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-5 Not asked"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-14 no contact"] <- "2 No"
FF_adversity_FULL[FF_adversity_FULL == "-14 No contact"] <- "2 No"
FF_adversity_FULL[FF_adversity_FULL == "-8 Out of range"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-4 Multiple ans"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "1 Never"] <- "2 No"
FF_adversity_FULL[FF_adversity_FULL == "-7"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-10 No need"] <- NA

##recoding variables
#first recoding variables where adversity is "reversed" (where yes= no adversity,
#want to change it to where the affirmative indicates adversity to match other vars)
FF_adversity_FULL$wave1_emcare <- case_when(FF_adversity_FULL$wave1_emcare %in% 
                                              c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave1_emcare %in% c("2 No") ~ "1",
                     FF_adversity_FULL$wave1_emcare %in% c(NA) ~ NA) 
 
FF_adversity_FULL$wave2_emcare <- case_when(FF_adversity_FULL$wave2_emcare %in%  
                                                c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave2_emcare %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave3_emcare <- case_when(FF_adversity_FULL$wave3_emcare %in%  
                                              c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave3_emcare %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave4_emcare <- case_when(FF_adversity_FULL$wave4_emcare %in%  
                                              c("1 yes") ~ "0", 
                     FF_adversity_FULL$wave4_emcare %in% c("2 no") ~ "1",
                     FF_adversity_FULL$wave4_emcare %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave1_1kloan <- case_when(FF_adversity_FULL$wave1_1kloan %in% 
                                              c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave1_1kloan %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave2_1kloan <- case_when(FF_adversity_FULL$wave2_1kloan %in% 
                                              c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave2_1kloan %in% c("2 No") ~ "1")  
 
FF_adversity_FULL$wave3_1kloan <- case_when(FF_adversity_FULL$wave3_1kloan %in% 
                                              c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave3_1kloan %in% c("2 No") ~ "1")  
 
FF_adversity_FULL$wave4_1kloan <- case_when(FF_adversity_FULL$wave4_1kloan %in%  
                                              c("1 yes") ~ "0", 
                     FF_adversity_FULL$wave4_1kloan %in% c("2 no") ~ "1") 
 
FF_adversity_FULL$wave1_200loan <- case_when(FF_adversity_FULL$wave1_200loan %in% 
                                               c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave1_200loan %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave2_200loan <- case_when(FF_adversity_FULL$wave2_200loan %in% 
                                               c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave2_200loan %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave3_200loan <- case_when(FF_adversity_FULL$wave3_200loan %in% 
                                               c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave3_200loan %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave4_200loan <- case_when(FF_adversity_FULL$wave4_200loan %in%  
                                               c("1 yes") ~ "0", 
                     FF_adversity_FULL$wave4_200loan %in% c("2 no") ~ "1") 
 
FF_adversity_FULL$wave1_1kcosign <- case_when(FF_adversity_FULL$wave1_1kcosign %in% 
                                                c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave1_1kcosign %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave2_1kcosign <- case_when(FF_adversity_FULL$wave2_1kcosign %in% 
                                                c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave2_1kcosign %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave3_1kcosign <- case_when(FF_adversity_FULL$wave3_1kcosign %in% 
                                                c("1 Yes") ~ "0", 
                     FF_adversity_FULL$wave3_1kcosign %in% c("2 No") ~ "1") 
 
FF_adversity_FULL$wave4_1kcosign <- case_when(FF_adversity_FULL$wave4_1kcosign %in% 
                                              c("1 yes") ~ "0", 
                     FF_adversity_FULL$wave4_1kcosign %in% c("2 no") ~ "1") 
 
#recoding all variables 
FF_adversity_FULL[FF_adversity_FULL == "0 No"] <- "0" 
FF_adversity_FULL[FF_adversity_FULL =="1 Yes"] <- "1" 
FF_adversity_FULL[FF_adversity_FULL == "1 yes"] <- "1" 
FF_adversity_FULL[FF_adversity_FULL == "2 No"] <- "0" 
FF_adversity_FULL[FF_adversity_FULL == "2 no"] <- "0" 
FF_adversity_FULL[FF_adversity_FULL == "2"] <- "0" 
FF_adversity_FULL[FF_adversity_FULL == "1"] <- "1" 

#changing class into numeric to make summative adversity score 
for(i in 1:48){ 
  FF_adversity_FULL[,i] <- as.numeric(FF_adversity_FULL[,i]) 
}

#changing hh income back to numeric
for(i in 55:59){ 
  FF_adversity_FULL[,i] <- as.numeric(FF_adversity_FULL[,i]) 
} 

#dropping observations where baseline covariates missing to get analytic sample
FF_adversity_FULL <- FF_adversity_FULL %>%
  mutate(index= FF$index) %>% 
  drop_na(mo_race_eth, mo_edu_wave0, mo_hh_income_wave0, mo_age_wave0,
          mo_married_wave0, mo_cohab_wave0)

#recoding the key demographic variables for proper imputation 
FF_adversity_FULL<- FF_adversity_FULL %>% 
  mutate(mo_edu_wave0= as.character(FF_adversity_FULL$mo_edu_wave0)) %>% 
  mutate(mo_race_eth= as.character(FF_adversity_FULL$mo_race_eth)) 
```

## Examining Missingness 

### For Reference: Demographic Distribution of Full Sample (n= 4,877)
```{r}
#race
full_samp_racedist <- FF_adversity_FULL %>% 
  group_by(mo_race_eth) %>% 
  summarise(n=n()) %>% 
  mutate(prop= round((n/4877), digits = 2))

full_samp_racedist

#education
full_samp_edudist <- FF_adversity_FULL %>% 
  group_by(mo_edu_wave0) %>% 
  summarise(n=n()) %>% 
  mutate(prop= round((n/4877), digits = 2))

full_samp_edudist

#household income (baseline)
full_samp_hhincomedist <- FF_adversity_FULL %>% 
  ggplot()+
  geom_histogram(mapping = aes(x= mo_hh_income_wave0)) + 
  labs(x= "Household Income",
       y= "Count",
       title = "Baseline Household Income Distribution of Full Sample (n= 4,877)")+
  theme_bw()

full_samp_hhincomedist

#mother's age at birth of focal child
full_samp_agedist <- FF_adversity_FULL %>% 
  ggplot()+
  geom_histogram(mapping = aes(x= mo_age_wave0)) + 
  labs(x= "Mother's Age",
       y= "Count",
       title = "Baseline Distribution of Mother's Age (n= 4,877)")+
  theme_bw()

full_samp_agedist

```

### Examining Missingness at the Individual Adversity-Wave Level (n=4,877)

```{r}
FF_missing_df <- FF_adversity_FULL[1:48] %>% 
  summarise(across(everything(), ~ sum(is.na(.)))) %>% 
  pivot_longer(cols = everything(), names_to = c("Wave-Adversity"),values_to = "count") %>% 
  # mutate(total= rep(4877, 52)) %>% 
  mutate(perc_missing= round(100*(count/4877), 2))

FF_missing_df 

#plotting
png("missing_perc_adversity_wave.png", width = 4000, height = 2000, res = 600)
FF_missing_df %>% 
  separate(`Wave-Adversity`, into= c("wave", "adversity"), sep = "_") %>% 
  ggplot()+
  geom_col(mapping = aes(x= perc_missing, y= adversity))+
  facet_wrap(~wave, labeller= as_labeller(c(wave1= "Wave 1", wave2= "Wave 2",
                                            wave3= "Wave 3", wave4= "Wave 4"))) + 
  scale_x_continuous(limits = c(0, 100)) +
  scale_y_discrete(limits = c("fjail", "feverjail", "fprobs",
                              "nonreghouse","moneymove","tele","gaselec","evict",
                              "emcare","1kcosign","1kloan","200loan"),
                   labels = c("father currently jailed",
                              "father ever jailed",
                              "father drug issues",
                              "houselessness",
                              "forced move",
                              "tele disconnect",
                              "utilities cut",
                              "evicted",
                              "lack of emergency care",
                              "$1k cosign",
                              "$1k loan",
                              "$200 loan"))+
  labs(x= "Percentage of Observations Missing", y= "Adversity")+
  theme(strip.background = element_rect(linetype = "solid", fill = "white",
                                        linewidth = 1, color = "black"),
        strip.text.x = element_text(size = 9, color = "black"))
dev.off()

```

### Examining Missingness at the Case-Wave Level
```{r}
wave1_case_na <- FF_adversity_FULL[1:48] %>% 
  dplyr::select(starts_with("wave1")) %>% 
  mutate(index= FF_adversity_FULL$index,
         na_count= rowSums(is.na(.))) %>% 
  dplyr::select(c(index, na_count))

wave2_case_na <- FF_adversity_FULL[1:48] %>% 
  dplyr::select(starts_with("wave2")) %>% 
  mutate(index= FF_adversity_FULL$index,
         na_count= rowSums(is.na(.))) %>% 
  dplyr::select(c(index, na_count))

wave3_case_na <- FF_adversity_FULL[1:48] %>% 
  dplyr::select(starts_with("wave3")) %>% 
  mutate(index= FF_adversity_FULL$index,
         na_count= rowSums(is.na(.))) %>% 
  dplyr::select(c(index, na_count))

wave4_case_na <- FF_adversity_FULL[1:48] %>% 
  dplyr::select(starts_with("wave4")) %>% 
  mutate(index= FF_adversity_FULL$index,
         na_count= rowSums(is.na(.))) %>% 
  dplyr::select(c(index, na_count))

caselevel_na <- left_join(wave1_case_na, 
                          wave2_case_na, by= "index") %>% 
  left_join(wave3_case_na, by= "index") %>% 
  left_join(wave4_case_na, by= "index")

colnames(caselevel_na) <- c("index", "Wave 1", "Wave 2", "Wave 3", "Wave 4")

#plotting mothers' missingness distribution by wave  
png("missing_case_wave.png", width = 4000, height = 2000, res = 600)
caselevel_na %>% 
  pivot_longer(cols = !index, names_to = c("wave"), 
               values_to = "num_na") %>% 
  ggplot()+
  geom_bar(mapping = aes(x= num_na))+
  facet_wrap(~ wave) +
  labs(x= "Number of Missing Observations", y= "Count")+
  theme(strip.background = element_rect(linetype = "solid", fill = "white",
                                        linewidth = 1, color = "black"),
        strip.text.x = element_text(size = 9, color = "black"))
dev.off()

## examining missingness across all four waves by case
png("missing_case_all4waves.png", width = 2000, height = 1500, res = 400)
data.frame(sum_na = c(caselevel_na %>% dplyr::select(-c(index)) %>% rowSums())) %>% 
  mutate(index= caselevel_na$index) %>% 
  relocate(index, .before = sum_na) %>% 
  ggplot()+
  geom_bar(mapping = aes(x= sum_na))+
  labs(x= "Number of Missing Observations", y= "Count")
dev.off()

```

### Examining Demographic Distribution Dropping Mothers in Highest Quartile of Missingness Across All Four Waves (3,658)
```{r}
#dropping mothers in top quartile of missingness 
caselevel_na_quart <-  data.frame(sum_na = c(caselevel_na %>% 
                                               dplyr::select(-c(index)) %>% 
                                               rowSums())) %>% 
  mutate(index= caselevel_na$index) %>% 
  relocate(index, .before = sum_na) %>% 
  mutate(quartile= ntile(sum_na, 4)) %>% 
  filter(quartile <4)

# comparing race distribution of new sample with full sample
racedist_quart <- FF_adversity_FULL %>% 
  dplyr::select(index, mo_race_eth) %>% 
  right_join(caselevel_na_quart, by= "index") %>% 
  group_by(mo_race_eth) %>% 
  summarise(n=n()) %>% 
  mutate(prop= round((n/3658), digits = 2)) %>% 
  mutate(prop_full= full_samp_racedist$prop)

racedist_quart

# comparing education distribution of new sample with full sample
edudist_quart <- FF_adversity_FULL %>% 
  dplyr::select(index, mo_edu_wave0) %>% 
  right_join(caselevel_na_quart, by= "index") %>% 
  group_by(mo_edu_wave0) %>% 
  summarise(n=n()) %>% 
  mutate(prop= round((n/3658), digits = 2)) %>% 
  mutate(prop_full= full_samp_edudist$prop)

edudist_quart

# comparing household income distribution of new sample 
hhincomedist_quart <-FF_adversity_FULL %>% 
  dplyr::select(index, mo_hh_income_wave0) %>% 
  right_join(caselevel_na_quart, by= "index") %>% 
  ggplot()+
  geom_histogram(mapping = aes(x= mo_hh_income_wave0))+
  labs(x= "Household Income",
       y= "Count",
       title = "Baseline Household Income Distribution of Mothers", 
       subtitle= "Excludes Mothers in Highest Quartile of Cumulative Missingness 
       Across All Adversities and All Waves (n= 3,658)")+
  theme_bw()

grid.arrange(full_samp_hhincomedist, hhincomedist_quart)

# comparing age at birth of focal child distribuion of sample 
agedist_quart <- FF_adversity_FULL %>% 
  dplyr::select(index, mo_age_wave0) %>% 
  right_join(caselevel_na_quart, by= "index") %>% 
  ggplot()+
  geom_histogram(mapping = aes(x= mo_age_wave0)) + 
  labs(x= "Mother's Age",
       y= "Count",
       title = "Baseline Distribution of Mother's Age (n= 2,972)")+
  theme_bw()

grid.arrange(full_samp_agedist, agedist_quart)

## examining missingness at individual adversity-wave level
FF_missing_df_quart <- FF_adversity_FULL %>% 
  dplyr::select(index, starts_with("wave")) %>% 
  right_join(caselevel_na_quart, by= "index") %>% 
  summarise(across(everything(), ~ sum(is.na(.)))) %>% 
  dplyr::select(-c(index, sum_na, quartile)) %>% 
  pivot_longer(cols = everything(), names_to = c("wave-adversity"), 
               values_to = "count") %>% 
  # mutate(total= rep(4877, 52)) %>% 
  mutate(perc_missing= round(100*(count/3658), 2))

FF_missing_df_quart
```

### Examining Demographic Distribution Dropping Mothers in Highest Quintile of Missingness Across All Four Waves (3,902)
```{r}
#dropping mothers in top quintile of missingness 
caselevel_na_quint <-  data.frame(sum_na = c(caselevel_na %>% 
                                               dplyr::select(-c(index)) %>% 
                                               rowSums())) %>% 
  mutate(index= caselevel_na$index) %>% 
  relocate(index, .before = sum_na) %>% 
  mutate(quintile= ntile(sum_na, 5)) %>% 
  filter(quintile <5)

# comparing race distribution of new sample with full sample
racedist_quint <- FF_adversity_FULL %>% 
  dplyr::select(index, mo_race_eth) %>% 
  right_join(caselevel_na_quint, by= "index") %>% 
  group_by(mo_race_eth) %>% 
  summarise(n=n()) %>% 
  mutate(prop= round((n/3902), digits = 2)) %>% 
  mutate(prop_full= full_samp_racedist$prop)

racedist_quint

# comparing education distribution of new sample with full sample
edudist_quint <- FF_adversity_FULL %>% 
  dplyr::select(index, mo_edu_wave0) %>% 
  right_join(caselevel_na_quint, by= "index") %>% 
  group_by(mo_edu_wave0) %>% 
  summarise(n=n()) %>% 
  mutate(prop= round((n/3902), digits = 2)) %>% 
  mutate(prop_full= full_samp_edudist$prop)

edudist_quint

# comparing household income distribution of new sample 
hhincomedist_quint <-FF_adversity_FULL %>% 
  dplyr::select(index, mo_hh_income_wave0) %>% 
  right_join(caselevel_na_quint, by= "index") %>% 
  ggplot()+
  geom_histogram(mapping = aes(x= mo_hh_income_wave0))+
  labs(x= "Household Income",
       y= "Count",
       title = "Baseline Household Income Distribution of Mothers", 
       subtitle= "Excludes Mothers in Highest Quintile of Cumulative Missingness 
       Across All Adversities and All Waves (n= 3,658)")+
  theme_bw()

grid.arrange(full_samp_hhincomedist, hhincomedist_quint)

# comparing age at birth of focal child distribution of sample 
agedist_quint <- FF_adversity_FULL %>% 
  dplyr::select(index, mo_age_wave0) %>% 
  right_join(caselevel_na_quint, by= "index") %>% 
  ggplot()+
  geom_histogram(mapping = aes(x= mo_age_wave0)) + 
  labs(x= "Mother's Age",
       y= "Count",
       title = "Baseline Distribution of Mother's Age (n= 2,972)")+
  theme_bw()

grid.arrange(full_samp_agedist, agedist_quint)

## examining missingness at individual adversity-wave level
FF_missing_df_quint <- FF_adversity_FULL %>% 
  dplyr::select(index, starts_with("wave")) %>% 
  right_join(caselevel_na_quint, by= "index") %>% 
  summarise(across(everything(), ~ sum(is.na(.)))) %>% 
  dplyr::select(-c(index, sum_na, quintile)) %>% 
  pivot_longer(cols = everything(), names_to = c("wave-adversity"), 
               values_to = "count") %>% 
  # mutate(total= rep(4877, 52)) %>% 
  mutate(perc_missing= round(100*(count/3902), 2))

FF_missing_df_quint
```


### Examining Demographic Distribution with Only Complete Cases
```{r}
### EXAMINING HOW DEMOGRAPHICS OF SAMPLE MAY CHANGE IF USING ONLY COMPLETE CASES ###
##RACE DISTRIBUTION -- more white
FF_adversity_FULL %>% 
  drop_na(starts_with("wave")) %>% 
  group_by(mo_race_eth) %>% 
  summarise(n=n()) %>% 
  mutate(prop= round((n/847), digits = 2)) %>% 
  mutate(prop_full= full_samp_racedist$prop)

##EDUCATION DISTRIBUTION -- biased towards more some coll/coll & grad
FF_adversity_FULL %>% 
  drop_na(starts_with("wave")) %>% 
  group_by(mo_edu_wave0) %>%  
  summarise(n=n()) %>% 
  mutate(prop= round((n/847), digits = 2)) %>% 
  mutate(prop_full= full_samp_edudist$prop)

##HOUSEHOLD INCOME--skews more to mothers with higher incomes
hh_income_completecases <- FF_adversity_FULL %>% 
  drop_na(starts_with("wave")) %>% 
  ggplot()+
  geom_histogram(mapping = aes(x= mo_hh_income_wave0)) + 
  labs(x= "Household Income",
       y= "Count",
       title = "Baseline Household Income Distribution of Only Complete Cases (n= 847)")+
  theme_bw()

grid.arrange(full_samp_hhincomedist, hh_income_completecases)

##MOTHER'S AGE-- skews a bit older 
age_completecases <- FF_adversity_FULL %>% 
  drop_na(starts_with("wave")) %>% 
  ggplot()+
  geom_histogram(mapping = aes(x= mo_age_wave0)) + 
  labs(x= "Mother's Age",
       y= "Count",
       title = "Baseline Distribution of Mother's Age (n= 847)")+
  theme_bw()

grid.arrange(full_samp_agedist, age_completecases)
```


# MAIN ANALYSIS: Full Sample Using PMM (m=10)
```{r}
set.seed(08540)
#making data frame of adversity values and imputation predictors
FF_adv_with_predictors <- FF_adversity_FULL[,c(1:60)] %>% 
  dplyr::select(-c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                   mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                   mo_hh_income_wave4))

FF_adv.comp_withpredictors<- readRDS("FF_adv_imp_car_hou_socnet_4877_withpredictors_RR#2.rds")

# #imputing missing data
# FF_adv_with_predictors.imp <- mice(data = FF_adv_with_predictors, m= 20,
#                                    method = "pmm", print= FALSE,
#                                    remove.collinear = FALSE)
# 
# #examining imputed data
# head(complete(FF_adv_with_predictors.imp))
# 
# ##creating an imputed data set
# FF_adv.comp_withpredictors <- complete(FF_adv_with_predictors.imp, "long", include = F)
# 
# FF_adv_imp_car_hou_socnet_4877_withpredictors <- saveRDS(FF_adv.comp_withpredictors,
#                                           file = "FF_adv_imp_car_hou_socnet_4877_withpredictors_RR#2.rds")

```

## [CARCERAL SYSTEM] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under carceral system domain
carceral_domain <- FF_adv.comp_withpredictors %>% 
  dplyr::select(ends_with(c("fjail", "rjail","fprobs"))) %>% 
  mutate(imp=FF_adv.comp_withpredictors$.imp) 

#wave 1
c_domain_w1 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

c_domain_w1_sums_FULL <- as.data.frame(rowSums(c_domain_w1[,c(2:4)]))

#wave 2
c_domain_w2 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

c_domain_w2_sums_FULL <- as.data.frame(rowSums(c_domain_w2[,c(2:4)]))

#wave 3
c_domain_w3 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

c_domain_w3_sums_FULL <- as.data.frame(rowSums(c_domain_w3[,c(2:4)]))

#wave 4
c_domain_w4 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

c_domain_w4_sums_FULL <- as.data.frame(rowSums(c_domain_w4[,c(2:4)]))

 
##creating a data set with the Summated scores  
c_dom_sums_FULL <- bind_cols(c_domain_w1_sums_FULL, c_domain_w2_sums_FULL, 
                             c_domain_w3_sums_FULL, c_domain_w4_sums_FULL) 

c_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 10)

colnames(c_dom_sums_FULL) <- c("wave1_cdom_sums_FULL", "wave2_cdom_sums_FULL",  
                               "wave3_cdom_sums_FULL", "wave4_cdom_sums_FULL", 
                               "index") 
 
c_dom_sums_FULL <- c_dom_sums_FULL %>%  
  relocate(index, .before= wave1_cdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors$.imp) %>%  
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
cdom_wave1avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave1_cdom_sums_FULL)")

cdom_wave2avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave2_cdom_sums_FULL)")

cdom_wave3avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave3_cdom_sums_FULL)")

cdom_wave4avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave4_cdom_sums_FULL)")

 
cdom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, cdom_wave1avg, cdom_wave2avg,  
                               cdom_wave3avg, cdom_wave4avg) 
 
colnames(cdom_allwaves_avg_FULL) <- c("index", "cdom_avg1", "cdom_avg2",  
                                      "cdom_avg3", "cdom_avg4") 
 
#converting into binary states 
cdom_allwaves_avg_cat_FULL <- cdom_allwaves_avg_FULL %>%  
  mutate(cdomw1_cat= case_when(cdom_avg1 == 0  ~ "carceral_no", 
                              cdom_avg1 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw2_cat= case_when(cdom_avg2 == 0  ~ "carceral_no",  
                              cdom_avg2 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw3_cat= case_when(cdom_avg3 == 0  ~ "carceral_no", 
                              cdom_avg3 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw4_cat= case_when(cdom_avg4 == 0  ~ "carceral_no", 
                              cdom_avg4 > 0 ~ "carceral_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
#wave 1
rel_c_domain_w1<- c_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w1_fjail= mean(wave1_fjail),
            w1_fprobs= mean(wave1_fprobs),
            w1_feverjail= mean(wave1_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w1_fjail= ifelse(w1_fjail>0, 1, 0)) %>% 
  mutate(w1_fprobs= ifelse(w1_fprobs>0, 1, 0)) %>% 
  mutate(w1_feverjail= ifelse(w1_feverjail>0, 1, 0))

#wave 2
rel_c_domain_w2<- c_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w2_fjail= mean(wave2_fjail),
            w2_fprobs= mean(wave2_fprobs),
            w2_feverjail= mean(wave2_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w2_fjail= ifelse(w2_fjail>0, 1, 0)) %>% 
  mutate(w2_fprobs= ifelse(w2_fprobs>0, 1, 0)) %>% 
  mutate(w2_feverjail= ifelse(w2_feverjail>0, 1, 0))

#wave 3
rel_c_domain_w3<- c_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w3_fjail= mean(wave3_fjail),
            w3_fprobs= mean(wave3_fprobs),
            w3_feverjail= mean(wave3_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w3_fjail= ifelse(w3_fjail>0, 1, 0)) %>% 
  mutate(w3_fprobs= ifelse(w3_fprobs>0, 1, 0)) %>% 
  mutate(w3_feverjail= ifelse(w3_feverjail>0, 1, 0))

#wave 4
rel_c_domain_w4<- c_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w4_fjail= mean(wave4_fjail),
            w4_fprobs= mean(wave4_fprobs),
            w4_feverjail= mean(wave4_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w4_fjail= ifelse(w4_fjail>0, 1, 0)) %>% 
  mutate(w4_fprobs= ifelse(w4_fprobs>0, 1, 0)) %>% 
  mutate(w4_feverjail= ifelse(w4_feverjail>0, 1, 0))


alpha_carceral_w1 <- data.frame(raw_alpha= alpha(rel_c_domain_w1)$total$raw_alpha) 
alpha_carceral_w2 <- data.frame(raw_alpha= alpha(rel_c_domain_w2)$total$raw_alpha)
alpha_carceral_w3 <- data.frame(raw_alpha= alpha(rel_c_domain_w3)$total$raw_alpha)
alpha_carceral_w4 <- data.frame(raw_alpha= alpha(rel_c_domain_w4)$total$raw_alpha)

alpha_carceral <- rbind(alpha_carceral_w1,
                      alpha_carceral_w2,
                      alpha_carceral_w3,
                      alpha_carceral_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")
```



## [HOUSING] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under housing system domain
housing_domain <- FF_adv.comp_withpredictors %>% 
  dplyr::select(ends_with(c("evict", "nonreghouse", "moneymove",
                     "gaselec", "tele"))) %>%
  mutate(imp=FF_adv.comp_withpredictors$.imp) 

#wave 1
ho_domain_w1 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

ho_domain_w1_sums_FULL <- as.data.frame(rowSums(ho_domain_w1[,c(2:6)]))

#wave 2
ho_domain_w2 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

ho_domain_w2_sums_FULL <- as.data.frame(rowSums(ho_domain_w2[,c(2:6)]))

#wave 3
ho_domain_w3 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

ho_domain_w3_sums_FULL <- as.data.frame(rowSums(ho_domain_w3[,c(2:6)]))

#wave 4
ho_domain_w4 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

ho_domain_w4_sums_FULL <- as.data.frame(rowSums(ho_domain_w4[,c(2:6)]))
 
##creating a data set with the Summatedd scores  
ho_dom_sums_FULL <- bind_cols(ho_domain_w1_sums_FULL, ho_domain_w2_sums_FULL, 
                             ho_domain_w3_sums_FULL, ho_domain_w4_sums_FULL)

ho_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 10) 
 
colnames(ho_dom_sums_FULL) <- c("wave1_hodom_sums_FULL", "wave2_hodom_sums_FULL",  
                               "wave3_hodom_sums_FULL", "wave4_hodom_sums_FULL", 
                               "index") 
 
ho_dom_sums_FULL <- ho_dom_sums_FULL %>%  
  relocate(index, .before= wave1_hodom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
hodom_wave1avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_hodom_sums_FULL)") 
 
hodom_wave2avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_hodom_sums_FULL)") 
 
hodom_wave3avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_hodom_sums_FULL)") 
 
hodom_wave4avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_hodom_sums_FULL)") 
 
hodom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, hodom_wave1avg, hodom_wave2avg,  
                               hodom_wave3avg, hodom_wave4avg) 
 
colnames(hodom_allwaves_avg_FULL) <- c("index", "hodom_avg1", "hodom_avg2",  
                                      "hodom_avg3", "hodom_avg4") 
 
#converting into binary states 
hodom_allwaves_avg_cat_FULL <- hodom_allwaves_avg_FULL %>%  
  mutate(hodomw1_cat= case_when(hodom_avg1 == 0  ~ "house_no", 
                              hodom_avg1 > 0 ~ "house_yes")) %>%  
  mutate(hodomw2_cat= case_when(hodom_avg2 == 0  ~ "house_no",  
                              hodom_avg2 > 0 ~ "house_yes")) %>%  
  mutate(hodomw3_cat= case_when(hodom_avg3 == 0  ~ "house_no", 
                              hodom_avg3 > 0 ~ "house_yes")) %>%  
  mutate(hodomw4_cat= case_when(hodom_avg4 == 0  ~ "house_no", 
                              hodom_avg4 > 0 ~ "house_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_hou_domain_w1<- ho_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave1_evict= mean(wave1_evict),
            wave1_nonreghouse= mean(wave1_nonreghouse),
            wave1_moneymove= mean(wave1_moneymove),
            wave1_gaselec= mean(wave1_gaselec),
            wave1_tele= mean(wave1_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_evict= ifelse(wave1_evict>0, 1, 0)) %>% 
  mutate(wave1_nonreghouse= ifelse(wave1_nonreghouse>0, 1, 0)) %>% 
  mutate(wave1_moneymove= ifelse(wave1_moneymove>0, 1, 0)) %>% 
  mutate(wave1_gaselec= ifelse(wave1_gaselec>0, 1, 0)) %>% 
  mutate(wave1_tele= ifelse(wave1_tele>0, 1, 0))

rel_hou_domain_w2<- ho_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave2_evict= mean(wave2_evict),
            wave2_nonreghouse= mean(wave2_nonreghouse),
            wave2_moneymove= mean(wave2_moneymove),
            wave2_gaselec= mean(wave2_gaselec),
            wave2_tele= mean(wave2_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_evict= ifelse(wave2_evict>0, 1, 0)) %>% 
  mutate(wave2_nonreghouse= ifelse(wave2_nonreghouse>0, 1, 0)) %>% 
  mutate(wave2_moneymove= ifelse(wave2_moneymove>0, 1, 0)) %>% 
  mutate(wave2_gaselec= ifelse(wave2_gaselec>0, 1, 0)) %>% 
  mutate(wave2_tele= ifelse(wave2_tele>0, 1, 0))


rel_hou_domain_w3<- ho_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave3_evict= mean(wave3_evict),
            wave3_nonreghouse= mean(wave3_nonreghouse),
            wave3_moneymove= mean(wave3_moneymove),
            wave3_gaselec= mean(wave3_gaselec),
            wave3_tele= mean(wave3_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_evict= ifelse(wave3_evict>0, 1, 0)) %>% 
  mutate(wave3_nonreghouse= ifelse(wave3_nonreghouse>0, 1, 0)) %>% 
  mutate(wave3_moneymove= ifelse(wave3_moneymove>0, 1, 0)) %>% 
  mutate(wave3_gaselec= ifelse(wave3_gaselec>0, 1, 0)) %>% 
  mutate(wave3_tele= ifelse(wave3_tele>0, 1, 0))

rel_hou_domain_w4<- ho_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave4_evict= mean(wave4_evict),
            wave4_nonreghouse= mean(wave4_nonreghouse),
            wave4_moneymove= mean(wave4_moneymove),
            wave4_gaselec= mean(wave4_gaselec),
            wave4_tele= mean(wave4_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_evict= ifelse(wave4_evict>0, 1, 0)) %>% 
  mutate(wave4_nonreghouse= ifelse(wave4_nonreghouse>0, 1, 0)) %>% 
  mutate(wave4_moneymove= ifelse(wave4_moneymove>0, 1, 0)) %>% 
  mutate(wave4_gaselec= ifelse(wave4_gaselec>0, 1, 0)) %>% 
  mutate(wave4_tele= ifelse(wave4_tele>0, 1, 0))


alpha_hou_w1 <- data.frame(raw_alpha= alpha(rel_hou_domain_w1)$total$raw_alpha) 
alpha_hou_w2 <- data.frame(raw_alpha= alpha(rel_hou_domain_w2)$total$raw_alpha)
alpha_hou_w3 <- data.frame(raw_alpha= alpha(rel_hou_domain_w3)$total$raw_alpha)
alpha_hou_w4 <- data.frame(raw_alpha= alpha(rel_hou_domain_w4)$total$raw_alpha)

alpha_hou <- rbind(alpha_hou_w1,
                      alpha_hou_w2,
                      alpha_hou_w3,
                      alpha_hou_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```


## [SOCIAL NETWORK] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under social network domain
socnet_domain <- FF_adv.comp_withpredictors %>% 
  dplyr::select(ends_with(c("emcare", "1kloan", "200loan",
                     "1kcosign"))) %>%
  mutate(imp=FF_adv.comp_withpredictors$.imp) 

#wave 1
net_domain_w1 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

net_domain_w1_sums_FULL <- as.data.frame(rowSums(net_domain_w1[,c(2:5)]))

#wave 2
net_domain_w2 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

net_domain_w2_sums_FULL <- as.data.frame(rowSums(net_domain_w2[,c(2:5)]))

#wave 3
net_domain_w3 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

net_domain_w3_sums_FULL <- as.data.frame(rowSums(net_domain_w3[,c(2:5)]))

#wave 4
net_domain_w4 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

net_domain_w4_sums_FULL <- as.data.frame(rowSums(net_domain_w4[,c(2:5)]))

 
##creating a data set with the Summatedd scores  
net_dom_sums_FULL <- bind_cols(net_domain_w1_sums_FULL, net_domain_w2_sums_FULL, 
                             net_domain_w3_sums_FULL, net_domain_w4_sums_FULL) 
net_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 10) 
 
colnames(net_dom_sums_FULL) <- c("wave1_netdom_sums_FULL", "wave2_netdom_sums_FULL",  
                               "wave3_netdom_sums_FULL", "wave4_netdom_sums_FULL",  
                               "index") 
 
net_dom_sums_FULL <- net_dom_sums_FULL %>%  
  relocate(index, .before= wave1_netdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
netdom_wave1avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_netdom_sums_FULL)") 
 
netdom_wave2avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_netdom_sums_FULL)") 
 
netdom_wave3avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_netdom_sums_FULL)") 
 
netdom_wave4avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_netdom_sums_FULL)") 
 
netdom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, netdom_wave1avg, netdom_wave2avg,  
                               netdom_wave3avg, netdom_wave4avg) 
 
colnames(netdom_allwaves_avg_FULL) <- c("index", "netdom_avg1", "netdom_avg2",  
                                      "netdom_avg3", "netdom_avg4") 
 
#converting into binary states 
netdom_allwaves_avg_cat_FULL <- netdom_allwaves_avg_FULL %>%  
  mutate(netdomw1_cat= case_when(netdom_avg1 == 0  ~ "socnetwork_no", 
                              netdom_avg1 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw2_cat= case_when(netdom_avg2 == 0  ~ "socnetwork_no",  
                              netdom_avg2 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw3_cat= case_when(netdom_avg3 == 0  ~ "socnetwork_no", 
                              netdom_avg3 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw4_cat= case_when(netdom_avg4 == 0  ~ "socnetwork_no", 
                              netdom_avg4 > 0 ~ "socnetwork_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_net_domain_w1<- net_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave1_emcare= mean(wave1_emcare),
            wave1_1kloan= mean(wave1_1kloan),
            wave1_200loan= mean(wave1_200loan),
            wave1_1kcosign= mean(wave1_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_emcare= ifelse(wave1_emcare>0, 1, 0)) %>% 
  mutate(wave1_1kloan= ifelse(wave1_1kloan>0, 1, 0)) %>% 
  mutate(wave1_200loan= ifelse(wave1_200loan>0, 1, 0)) %>% 
  mutate(wave1_1kcosign= ifelse(wave1_1kcosign>0, 1, 0)) 


rel_net_domain_w2<- net_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave2_emcare= mean(wave2_emcare),
            wave2_1kloan= mean(wave2_1kloan),
            wave2_200loan= mean(wave2_200loan),
            wave2_1kcosign= mean(wave2_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_emcare= ifelse(wave2_emcare>0, 1, 0)) %>% 
  mutate(wave2_1kloan= ifelse(wave2_1kloan>0, 1, 0)) %>% 
  mutate(wave2_200loan= ifelse(wave2_200loan>0, 1, 0)) %>% 
  mutate(wave2_1kcosign= ifelse(wave2_1kcosign>0, 1, 0)) 


rel_net_domain_w3<- net_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave3_emcare= mean(wave3_emcare),
            wave3_1kloan= mean(wave3_1kloan),
            wave3_200loan= mean(wave3_200loan),
            wave3_1kcosign= mean(wave3_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_emcare= ifelse(wave3_emcare>0, 1, 0)) %>% 
  mutate(wave3_1kloan= ifelse(wave3_1kloan>0, 1, 0)) %>% 
  mutate(wave3_200loan= ifelse(wave3_200loan>0, 1, 0)) %>% 
  mutate(wave3_1kcosign= ifelse(wave3_1kcosign>0, 1, 0)) 

rel_net_domain_w4<- net_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave4_emcare= mean(wave4_emcare),
            wave4_1kloan= mean(wave4_1kloan),
            wave4_200loan= mean(wave4_200loan),
            wave4_1kcosign= mean(wave4_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_emcare= ifelse(wave4_emcare>0, 1, 0)) %>% 
  mutate(wave4_1kloan= ifelse(wave4_1kloan>0, 1, 0)) %>% 
  mutate(wave4_200loan= ifelse(wave4_200loan>0, 1, 0)) %>% 
  mutate(wave4_1kcosign= ifelse(wave4_1kcosign>0, 1, 0)) 

# alpha(rel_net_domain_w1)
# alpha(rel_net_domain_w2)
# alpha(rel_net_domain_w3)
# alpha(rel_net_domain_w4)

alpha_net_w1 <- data.frame(raw_alpha= alpha(rel_net_domain_w1)$total$raw_alpha) 
alpha_net_w2 <- data.frame(raw_alpha= alpha(rel_net_domain_w2)$total$raw_alpha)
alpha_net_w3 <- data.frame(raw_alpha= alpha(rel_net_domain_w3)$total$raw_alpha)
alpha_net_w4 <- data.frame(raw_alpha= alpha(rel_net_domain_w4)$total$raw_alpha)

alpha_socnet <- rbind(alpha_net_w1,
                      alpha_net_w2,
                      alpha_net_w3,
                      alpha_net_w4) %>% 
  mutate(Wave= c("Wave 1(Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```

## Table of Alphas for All Three Domains
```{r}
alpha_all_domains <- cbind(alpha_carceral, alpha_hou$raw_alpha, alpha_socnet$raw_alpha) 

colnames(alpha_all_domains) <- c("Wave" ,"Carceral", "Housing", "Social Network")

alpha_all_domains %>% 
  summarise_all(mean)

alpha_all_domains <- alpha_all_domains %>% 
  mutate_if(is.numeric, round, digits= 2)

alpha_all_domains

# png("MD_alphas_table.png", width = 550, height = 550)  
# #dev.off() 

# kable(alpha_all_domains) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "alpha_all_domain.html")

```


## Creating Sequences with Composite Scores
```{r}
## cleaning dataframes for defining  
carceral_traj <- cdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("cdomw")) 

housing_traj <- hodom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("hodomw")) 
 
socnet_traj <- netdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("netdomw")) 
 
##defining sequence objects for each domain 
 
#carceral system 
cdom_alphabet <- c("carceral_yes", "carceral_no") 
cdom_labs <- c("carceral_yes", "carceral_no") 
 
colnames(carceral_traj)[1] <- "Wave 1 (Y1)" 
colnames(carceral_traj)[2] <- "Wave 2 (Y3)" 
colnames(carceral_traj)[3] <- "Wave 3 (Y5)" 
colnames(carceral_traj)[4] <- "Wave 4 (Y9)" 

seqcar <- seqdef(carceral_traj, 
                 var = 1:4, 
                 alphabet = cdom_alphabet, 
                 labels=cdom_labs, 
                 xstep= 1 ) 

#housing system 
hodom_alphabet <- c("house_yes", "house_no") 
hodom_labs <- c("house_yes", "house_no") 
 
colnames(housing_traj)[1] <- "Wave 1 (Y1)" 
colnames(housing_traj)[2] <- "Wave 2 (Y3)" 
colnames(housing_traj)[3] <- "Wave 3 (Y5)" 
colnames(housing_traj)[4] <- "Wave 4 (Y9)" 

seqhou <- seqdef(housing_traj, 
                 var = 1:4, 
                 alphabet = hodom_alphabet, 
                 labels=hodom_labs, 
                 xstep= 1) 
 
#social network 
netdom_alphabet <- c("socnetwork_yes", "socnetwork_no") 
netdom_labs <- c("socnetwork_yes", "socnetwork_no") 
 
colnames(socnet_traj)[1] <- "Wave 1 (Y1)" 
colnames(socnet_traj)[2] <- "Wave 2 (Y3)" 
colnames(socnet_traj)[3] <- "Wave 3 (Y5)" 
colnames(socnet_traj)[4] <- "Wave 4 (Y9)" 

seqsocnet <- seqdef(socnet_traj, 
                 var = 1:4, 
                 alphabet = netdom_alphabet, 
                 labels=netdom_labs, 
                 xstep= 1) 

 
## Calculating Distance/Dissimilarity Matrix [OM] 
 
#carceral system 
carceral_distOM <- seqdist(seqcar, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#housing 
housing_distOM <- seqdist(seqhou, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#social network 
socnet_distOM <- seqdist(seqsocnet, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
```


## Measuring Strength of Association at Domain & State Levels
```{r}
##at state level (testing whether CAT could be used) 
state_assoc <- seqdomassoc(list(seqcar, seqhou, seqsocnet), 
            rep.method = "overall", 
            assoc = "V", 
            p.value = T, 
            struct.zero = F, 
            cross.table = T, 
            with.missing = F, 
            weighted = F, 
            dnames = c("Carceral", "Housing", "Soc Network")) 
state_assoc

state_assoc_df <- state_assoc[,c(2, 3)] %>% 
  as.data.frame() 

 
##at sequence level (testing whether DAT could be used) 
dom_assoc <- dissdomassoc(list(carceral_distOM, housing_distOM, socnet_distOM), 
             what = "pearson", 
             dnames = c("Carceral", "Housing", "Soc Network")) 
dom_assoc$p.pearson

state_dom_assoc_table <- state_assoc_df %>% 
  mutate(`Pearson's r`= c(dom_assoc$Pearson[1,2], dom_assoc$Pearson[1,3],
                          dom_assoc$Pearson[3,2])) %>% 
  mutate(`p(r)`= c(dom_assoc$p.pearson[1,2], dom_assoc$p.pearson[1,3],
                          dom_assoc$p.pearson[3,2])) %>% 
  mutate_all(round, digits=3)%>% 
  rownames_to_column("Domain Pairs") %>% 
  mutate(`Domain Pairs` = c("Carceral with Housing", "Carceral with Social Network",
                            "Housing with Social Network"))

state_dom_assoc_table

# kable(state_dom_assoc_table) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "state_dom_assoc_table.html")


```


## Creating/Plotting Multidomain Sequences
```{r}
#creating MD sequence df (to ensure proper alphabet)
MDseq <- list(seqcar, seqhou, seqsocnet) %>% 
  as.data.frame() 

colnames(MDseq) <- c("wave1_car", "wave2_car", "wave3_car", "wave4_car",
                     "wave1_hou", "wave2_hou", "wave3_hou", "wave4_hou",
                     "wave1_socnet", "wave2_socnet", "wave3_socnet", "wave4_socnet")
  
MDseq$wave1 <- paste(MDseq$wave1_car, "+", MDseq$wave1_hou, "+", MDseq$wave1_socnet)
MDseq$wave2 <- paste(MDseq$wave2_car, "+", MDseq$wave2_hou, "+", MDseq$wave2_socnet)
MDseq$wave3 <- paste(MDseq$wave3_car, "+", MDseq$wave3_hou, "+", MDseq$wave3_socnet)
MDseq$wave4 <- paste(MDseq$wave4_car, "+", MDseq$wave4_hou, "+", MDseq$wave4_socnet)

MDseq <- MDseq[, c(13:16)]

MDseq <- seqdef(MDseq,
       alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"),
       xtstep = 1)
 
#png("basic_MD_plot_R&R.png", width = 2000, height = 2000, res = 600)
seq_plot_MD <- seqplot(MDseq, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"), ylab = NA, border = NA, cex.legend = .5)
#dev.off()
```


## Cluster Analysis (IDCD Approach)

### Clustering MD sequences
```{r}
# Setting MD Costs/Distances 
MD_dist <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELSLOG") 
 
# conducting hierarchical cluster analysis (ward-d2) 
MD_clus <- agnes(MD_dist, diss = T, method = "ward") 

# storing clustering solution
# MD_clus_car_hou_socnet_4877 <- saveRDS(MD_clus, 
#                                           file = "MD_clus_car_hou_socnet_4877_RR#2.rds")

# png("dendrogram_final.png", width=7000, height=4000, res = 800)
# plot(MD_clus)
# rect.hclust(MD_clus, k= 3)
# #dev.off()
```

### Determining Number of Clusters: Cluster Quality Metrics
```{r}
clus_quality_table <- as.clustrange(MD_clus, diss = MD_dist, ncluster = 6) 

#generating evaluation plot
# png("MD_Eval_plots.png",width=8000, height=5000, res = 800, pointsize = 14)
clus_plot <- plot(clus_quality_table, stat = c("ASW", "HC", "CH", "PBC"), 
     norm= "zscore", legendpos= "topright", lwd=2) 
abline(v= 4,col= "red")
# dev.off()
```

### Determining Number of Clusters: Visualizing Different Numbers of Clusters
```{r}
## FOR SIX GROUPS ##  
MD_cut6 <- cutree(MD_clus, k= 6)  
MD_cut_fac6 <- factor(MD_cut6, levels = c(3, 2, 5, 6, 1, 4),
                     labels = paste("Type", 1:6))
 
 
#png("MDcluster_plot6.png", width=7000, height=5000, res = 900, pointsize = 9)  
seqplot(MDseq, group = MD_cut6, type="I",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1.2, 
        rows = 2, 
        cols = 3)  
#dev.off()  
 
## FOR FIVE GROUPS ##  
MD_cut5 <- cutree(MD_clus, k= 5)  
MD_cut_fac5 <- factor(MD_cut5, levels = c(3, 2, 5, 1, 4), 
                      labels = paste("Type", 1:5))

 
#png("MDcluster_plot5.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut5, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8,
        rows = 2,
        cols = 3)  
#dev.off()  
 
## FOR FOUR GROUPS ##  
MD_cut4 <- cutree(MD_clus, k= 4)  
# MD_cut_fac4 <- factor(MD_cut4, labels = paste("Type", 1:4))  
MD_cut_fac4 <- factor(MD_cut4, levels = c(3, 2, 4, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"),
                                 ordered = TRUE)
 
 
#png("MDcluster_plot4.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut4, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8, rows = 2, cols = 4)  
#dev.off()  

## FOR THREE GROUPS ##  
MD_cut3 <- cutree(MD_clus, k= 3)  
#MD_cut_fac3 <- factor(MD_cut3, labels = paste("Type", 1:3))
MD_cut_fac3 <- factor(MD_cut3, levels= c(3, 2, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Progressively Worsening Adversity (1-2 Domains)",
                                 "Consistently Moderate to High Adversity (2-3 Domains)"),
                      ordered = TRUE)
 
#png("MDcluster_plot3.png", width = 6500, height = 4000, res = 800)  
seqplot(MDseq, group = MD_cut3, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1,
        rows = 1,
        cols = 3)  
#dev.off()  
```


### Primary Visualization: Sequence Index and State Distribution Plots (4 clusters)
```{r}
##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_main.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1.1,
        rows = 2,
        cols = 2) 
dev.off()

#SEQUENCE INDEX PLOT
png("MDcluster_plot4_seqindex_main.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="I",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()
```


### Additional Visualization: Representative Plots (4 clusters)
```{r}
#FREQUENCY

png("MDcluster_plot4_freq.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="r",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1.1,
        diss= MD_dist,
        criterion= "freq",
        coverage= .30,
        rows = 2,
        cols = 2)
dev.off()

#NEIGHBORHOOD DENSITY

png("MDcluster_plot4_neigh.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="r",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1.1,
        diss= MD_dist,
        criterion= "density",
        pradius= 0.2,
        coverage= .30,
        rows = 2,
        cols = 2)
dev.off()
```

## Robustness Check: Clustering w/ Alt Sub Cost Matrices 
```{r}
#### CONSTANT ####
MD_dist_constant <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "CONSTANT") 
 
#conducting hierarchical cluster analysis (ward-d2) 
MD_clus_constant <- agnes(MD_dist_constant, diss = T, method = "ward") 
#plot(MD_clus_constant) 
MD_cut_constant <- cutree(MD_clus_constant, k=4)  
MD_cut_fac_constant <- factor(MD_cut_constant, levels = c(3, 2, 4, 1),
                              labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"))

#Plotting

##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_constant.png", width=4000, height=4000, res = 800, pointsize = 7)  
seqplot(MDseq, group = MD_cut_fac_constant, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",  
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1, 
        rows = 2, 
        cols = 2)  
dev.off()
```

```{r}
#### TRANSITION ####
MD_dist_trate <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "TRATE") 
 
#conducting hierarchical cluster analysis (ward-d2) 
MD_clus_trate <- agnes(MD_dist_trate, diss = T, method = "ward") 
#plot(MD_clus_trate) 
MD_cut_trate <- cutree(MD_clus_trate, k=4)  
MD_cut_fac_trate <- factor(MD_cut_trate, levels = c(3, 2, 4, 1),
                              labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"))

#Plotting

##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_trate.png", width=4000, height=4000, res = 800, pointsize = 7)  
seqplot(MDseq, group = MD_cut_fac_trate, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",  
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1, 
        rows = 2, 
        cols = 2)  
dev.off()  
```

```{r}
#### INDELS ####
MD_dist_indel <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELS") 
 
#conducting hierarchical cluster analysis (ward-d2) 
MD_clus_indel <- agnes(MD_dist_indel, diss = T, method = "ward") 
#plot(MD_clus_indel) 
MD_cut_indel <- cutree(MD_clus_indel, k=4)  
MD_cut_fac_indel <- factor(MD_cut_indel, levels = c(3, 2, 4, 1),
                              labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"))

#Plotting

##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_indel.png", width=4000, height=4000, res = 800, pointsize = 7)  
seqplot(MDseq, group = MD_cut_fac_indel, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",  
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1, 
        rows = 2, 
        cols = 2)  
dev.off()  
```


## MODELING W/ MD CLUSTERS

### Data Cleaning, Imputing, and Wrangling
```{r}
set.seed(08540)
##PREPPING DATA
#creating outcome variable with the cluster assignments for each observation/sequence
clusterdf_MD <- data.frame(cluster_MD4= MD_cut_fac4) 
  
#adding demographic variables to data frame
clusterdf_demo_MD_0 <- bind_cols(clusterdf_MD, FF_adversity_FULL[49:64])

#cleaning up new demo variables
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3 Missing"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9 Not in wave"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 Skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -1.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -2.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -5.00] <- NA

 
#re-coding some of the categorical variables 
clusterdf_demo_MD_0 <- clusterdf_demo_MD_0 %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c("1 less hs") ~ 1,
                     mo_edu_wave0 %in% c("2 hs or equiv") ~ 2,
                     mo_edu_wave0 %in% c("3 some coll, tech") ~ 3,
                     mo_edu_wave0 %in% c("4 coll or grad") ~ 4)) %>% 
  mutate(mo_edu_wave1 =
           case_when(mo_edu_wave1 %in% c("1") ~ 1,
                     mo_edu_wave1 %in% c("2") ~ 2,
                     mo_edu_wave1 %in% c("3") ~ 3,
                     mo_edu_wave1 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave2 =
           case_when(mo_edu_wave2 %in% c("1") ~ 1,
                     mo_edu_wave2 %in% c("2") ~ 2,
                     mo_edu_wave2 %in% c("3") ~ 3,
                     mo_edu_wave2 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave3 =
           case_when(mo_edu_wave3 %in% c("1") ~ 1,
                     mo_edu_wave3 %in% c("2") ~ 2,
                     mo_edu_wave3 %in% c("3") ~ 3,
                     mo_edu_wave3 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave4 =
           case_when(mo_edu_wave4 %in% c("1") ~ 1,
                     mo_edu_wave4 %in% c("2") ~ 2,
                     mo_edu_wave4 %in% c("3") ~ 3,
                     mo_edu_wave4 %in% c("4") ~ 4)) 

clusterdf_demo_MD <- clusterdf_demo_MD_0

##IMPUTING SELECT MISSING DEMO DATA (only those that will be used in modeling)
#selecting variables to impute 
clusdf_select_MD <- bind_cols(clusterdf_demo_MD[4:7], clusterdf_demo_MD[9:12])

#imputing missing data for select demo/control variables
clusdf_select_MD_imp <- mice(data=clusdf_select_MD, m= 10, method = "pmm", 
                             print= F)

#examining imputed data
#head(complete(clusdf_select_MD_imp))

#creating an imputed data set
clusdf_select_MD_imp_comp <- complete(clusdf_select_MD_imp, "long", include = F)

#adding index for later grouping and generating avgs across imputed data sets
clusdf_select_MD_imp_comp$index <- rep(clusterdf_demo_MD$index, times= 10)

clusdf_select_MD_imp_comp <- clusdf_select_MD_imp_comp %>% 
  relocate(index, .before= .id)

#generating average value of imputed variables across the imputed data sets
demoMD_imp_avgs <- clusdf_select_MD_imp_comp %>% 
  group_by(index) %>% 
  summarise(round(mean(mo_edu_wave1)),
            round(mean(mo_edu_wave2)),
            round(mean(mo_edu_wave3)),
            round(mean(mo_edu_wave4)),
            round(mean(mo_hh_income_wave1)),
            round(mean(mo_hh_income_wave2)),
            round(mean(mo_hh_income_wave3)),
            round(mean(mo_hh_income_wave4)))
            
colnames(demoMD_imp_avgs) <- c("index","mo_edu_wave1", "mo_edu_wave2","mo_edu_wave3", 
                               "mo_edu_wave4", "mo_hh_income_wave1", "mo_hh_income_wave2",
                               "mo_hh_income_wave3", "mo_hh_income_wave4")

#creating new complete data set with imputed demographic/control variables
FF_MD_clus0 <- clusterdf_demo_MD %>% 
  subset(select = -c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                     mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                     mo_hh_income_wave4)) %>% 
  left_join(demoMD_imp_avgs, by= "index") 
  

#transforming education variable back to categorical and adding substantive labels 
FF_MD_clus <- FF_MD_clus0 %>% 
  mutate(mo_edu_wave0= case_when(mo_edu_wave0 %in% c(1) ~ "less hs",
                                 mo_edu_wave0 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave0 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave0 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave1= case_when(mo_edu_wave1 %in% c(1) ~ "less hs",
                                 mo_edu_wave1 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave1 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave1 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave2= case_when(mo_edu_wave2 %in% c(1) ~ "less hs",
                                 mo_edu_wave2 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave2 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave2 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave3= case_when(mo_edu_wave3 %in% c(1) ~ "less hs",
                                 mo_edu_wave3 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave3 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave3 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave4= case_when(mo_edu_wave4 %in% c(1) ~ "less hs",
                                 mo_edu_wave4 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave4 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave4 %in% c(4) ~ "coll or grad")) 

#logging hh income variable for modeling (adding one to address zeros)
FF_MD_clus <- FF_MD_clus %>% 
  mutate(hh_income_log= log(FF_MD_clus$mo_hh_income_wave0 +1)) 

#recoding education at baseline as ordinal factor for modeling
FF_MD_clus$mo_edu_wave0 <- factor(FF_MD_clus$mo_edu_wave0,
                                     levels=c("less hs",
                                              "hs or equiv",
                                              "some coll, tech",
                                              "coll or grad"))

#adding unordered version of cluster variables for multinomial regression & turning
#mother's race/ethnicity into unordered factor variable to set reference level
FF_MD_clus <- FF_MD_clus %>% 
  mutate(cluster_MD4_m= factor(FF_MD_clus$cluster_MD4, ordered = F)) %>%
  mutate(mo_race_eth= factor(FF_MD_clus$mo_race_eth, ordered = F))
```

### Robustness Check: Examining Covariates Over Time
```{r}
##checking to make sure education and income variables stay largely the same over time
png("education_dist_overwaves.png", width=4000, height=2000, res = 600, pointsize = 7)
FF_MD_clus %>% 
  dplyr::select(mo_edu_wave0, mo_edu_wave1,mo_edu_wave2, mo_edu_wave3, 
                mo_edu_wave4) %>%
  pivot_longer(cols = everything(), names_to = c("wave"), 
               values_to = "edu_level") %>% 
  mutate(edu_level= factor(edu_level, levels = c("less hs",
                                      "hs or equiv","some coll, tech",
                                      "coll or grad"))) %>% 
  ggplot(aes(x= wave, fill=edu_level)) +
  geom_bar(position = "dodge") +
  theme(axis.text= element_text(size = 10, colour = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  scale_fill_manual(name= "Education Level",
                    values = c("#b3de69","#8dd3c7", "#bebada", "#80b1d3"),
                    labels= c("Less than High School", "High School or Equiv", 
                              "Some College/Technical School",
                             "College or Graduate School")) +
  labs(x= "Wave", y= "Number of Mothers") +
  scale_x_discrete(labels= c("baseline" ,"wave 1", "wave 2", "wave 3", "wave 4"))
dev.off()


png("hhincome_dist_overwaves.png", width=4000, height=2000, res = 600, pointsize = 7)
FF_MD_clus0 %>% 
  dplyr::select(mo_hh_income_wave0, mo_hh_income_wave1, mo_hh_income_wave2, 
                mo_hh_income_wave3, mo_hh_income_wave4) %>%
  pivot_longer(cols = everything(), names_to = c("wave"), 
               values_to = "hh_income") %>% 
  ggplot(aes(y= hh_income, x=wave)) +
  geom_jitter(aes(color=wave), show.legend = F)+
  theme(axis.text= element_text(size = 10, colour = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  scale_x_discrete(labels= c("baseline" ,"wave 1", "wave 2", "wave 3", "wave 4")) +
  labs(x= "Wave", y= "Household Income (dollars)")+
  ylim(0,700000)
dev.off()

```

### Generating Descriptive Table of Analytic Sample
```{r}
clusterdf_demo_MD_descrip <- clusterdf_demo_MD %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c(1) ~ "Less Than High School",
                     mo_edu_wave0 %in% c(2) ~ "High School or Equivalent",
                     mo_edu_wave0 %in% c(3) ~ "Some College/Technical School",
                     mo_edu_wave0 %in% c(4) ~ "College or Graduate School")) %>% 
  mutate(mo_race_eth =
           case_when(mo_race_eth %in% c("1 white, non-hispanic") ~ "White, Non-Hispanic",
                     mo_race_eth %in% c("2 black, non-hispanic") ~ "Black, Non-Hispanic",
                     mo_race_eth %in% c("3 hispanic") ~ "Hispanic",
                     mo_race_eth %in% c("4 other") ~ "Other Race/Ethnicity"))

descripMD <-  clusterdf_demo_MD_descrip %>% 
  dplyr::select(mo_race_eth, mo_edu_wave0, mo_hh_income_wave0, 
         mo_age_wave0, mo_married_wave0, mo_cohab_wave0)

descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "0"] <- "Not married"
descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "1"] <- "Married"

descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "0"] <- "Not Cohabitating"
descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "1"] <- "Cohabitating"

label(descripMD$mo_hh_income_wave0) <- "Mother's Annual Household Income at Baseline"
label(descripMD$mo_race_eth) <- "Race/Ethnicity"
label(descripMD$mo_edu_wave0) <- "Education at Baseline"
label(descripMD$mo_married_wave0) <- "Mother Married to Bio Dad at Baseline"
label(descripMD$mo_cohab_wave0) <- "Mother Cohabitating w/ Bio Dad at Baseline"
label(descripMD$mo_age_wave0) <- "Age at Birth of Focal Child"

descripMD_table <- table1(~mo_race_eth + 
                          mo_edu_wave0 + mo_age_wave0 + mo_hh_income_wave0 +
                          mo_married_wave0 + mo_cohab_wave0, 
                        data = descripMD)
descripMD_table
# png("Sample_Table.png", width = 550, height = 550)
# tableGrob(descripMD_table)
# dev.off()

# #png("Sample_Table.png", width = 550, height = 550)
# apa_table(descripMD_table)
# #dev.off()

```

### Multinomial Regression Modeling w/ IDCD Clusters 
```{r}
##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the very low adversity cluster [3 clusters]
FF_MD_clus$cluster_MD4_m <- relevel(FF_MD_clus$cluster_MD4_m,
                                      ref = "Consistently Very Low Adversity (0-1 Domains)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

## MODEL 1
# mother's race as sole predictor model
mod1_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD4)

z_mod1_MD4 <- summary(mod1_MD4)$coefficients/summary(mod1_MD4)$standard.errors
p_mod1_MD4 <- (1 - pnorm(abs(z_mod1_MD4), 0, 1)) * 2
p_mod1_MD4

## MODEL 2
# mother's race as predictor w/ education, income, and age of mother at focal child's
# birth as covariates
mod2_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth +
                                     hh_income_log + mo_edu_wave0 +
                                     mo_age_wave0,
                                   data = FF_MD_clus)

summary(mod2_MD4)

z_mod2_MD4 <- summary(mod2_MD4)$coefficients/summary(mod2_MD4)$standard.errors
p_mod2_MD4 <- (1 - pnorm(abs(z_mod2_MD4), 0, 1)) * 2
p_mod2_MD4
```

#### Multinomial Regression Table
```{r, results='asis', warning=FALSE}
stargazer(mod1_MD4, mod2_MD4,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          dep.var.labels = c("Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity",
                             "Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity"),
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Household Income (Logged)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "-10pt",
          notes.append = F,
          type = "html")
```


# EXAMINING WHAT IS DRIVING THE CLUSTERING PATTERNS & MODEL RESULTS

## Examining State Distribution by Race (Mean Time)
```{r}
## Preparing Sequences of Each Racial/Ethnic Group
## Sequence Plots of Black Mothers Only
black_seq_viz <- bind_cols(index= FF_adversity_FULL$index, 
                        mo_race_eth = FF_adversity_FULL$mo_race_eth, 
                        clus_assign= MD_cut_fac4) %>% 
  as.data.frame() %>% 
  mutate(seq_num= row_number()) %>% 
  filter(mo_race_eth == "2 black, non-hispanic")

MD_seq_black <- MDseq %>% 
  as.data.frame() %>% 
  mutate(seq_num= row_number()) %>% 
  relocate(seq_num, .before = "wave1") %>% 
  right_join(black_seq_viz, by= "seq_num") %>% 
  dplyr::select(c(2:5)) %>% 
  seqdef(alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"))
  

## Sequence Plots of White Mothers
white_seq_viz <- bind_cols(index= FF_adversity_FULL$index, 
                        mo_race_eth = FF_adversity_FULL$mo_race_eth, 
                        clus_assign= MD_cut_fac4) %>% 
  as.data.frame() %>% 
  mutate(seq_num= row_number()) %>% 
  filter(mo_race_eth == "1 white, non-hispanic")

MD_seq_white <- MDseq %>% 
  as.data.frame() %>% 
  mutate(seq_num= row_number()) %>% 
  relocate(seq_num, .before = "wave1") %>% 
  right_join(white_seq_viz, by= "seq_num") %>% 
  dplyr::select(c(2:5)) %>% 
  seqdef(alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"))

## Sequence Plots of Hispanic Mothers
hispanic_seq_viz <- bind_cols(index= FF_adversity_FULL$index, 
                        mo_race_eth = FF_adversity_FULL$mo_race_eth, 
                        clus_assign= MD_cut_fac4) %>% 
  as.data.frame() %>% 
  mutate(seq_num= row_number()) %>% 
  filter(mo_race_eth == "3 hispanic")

MD_seq_hispanic <- MDseq %>% 
  as.data.frame() %>% 
  mutate(seq_num= row_number()) %>% 
  relocate(seq_num, .before = "wave1") %>% 
  right_join(hispanic_seq_viz, by= "seq_num") %>% 
  dplyr::select(c(2:5)) %>% 
  seqdef(alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"))

## Sequence Plots of Mothers of Other Races/Ethnicities
other_seq_viz <- bind_cols(index= FF_adversity_FULL$index, 
                        mo_race_eth = FF_adversity_FULL$mo_race_eth, 
                        clus_assign= MD_cut_fac4) %>% 
  as.data.frame() %>% 
  mutate(seq_num= row_number()) %>% 
  filter(mo_race_eth == "4 other")

MD_seq_other <- MDseq %>% 
  as.data.frame() %>% 
  mutate(seq_num= row_number()) %>% 
  relocate(seq_num, .before = "wave1") %>% 
  right_join(other_seq_viz, by= "seq_num") %>% 
  dplyr::select(c(2:5)) %>% 
  seqdef(alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"))

## Calculating Mean Time Spent in Each State
seq_mean_black <-  data.frame(seqmeant(MD_seq_black)) %>% 
  rownames_to_column(var = "mdsa_state") 

seq_mean_white <-  data.frame(seqmeant(MD_seq_white)) %>% 
  rownames_to_column(var = "mdsa_state") 

seq_mean_hispanic <-  data.frame(seqmeant(MD_seq_hispanic)) %>% 
  rownames_to_column(var = "mdsa_state") 

seq_mean_other <-  data.frame(seqmeant(MD_seq_other)) %>% 
  rownames_to_column(var = "mdsa_state") 

seq_mean_all <- seq_mean_black %>% 
  mutate(white_mean=  round(seq_mean_white$Mean, digits = 2),
         hispanic_mean=  round(seq_mean_hispanic$Mean, digits = 2),
         other_mean=  round(seq_mean_other$Mean, digits = 2)) %>% 
  mutate(Mean= round(seq_mean_black$Mean, digits = 2)) %>% 
  mutate(mdsa_state= factor(seq_mean_black$mdsa_state,
                            levels = c("carceral_no + house_no + socnetwork_no", 
                                       "carceral_no + house_no + socnetwork_yes",
                                       "carceral_no + house_yes + socnetwork_no", 
                                       "carceral_yes + house_no + socnetwork_no",
                                       "carceral_no + house_yes + socnetwork_yes", 
                                       "carceral_yes + house_no + socnetwork_yes",
                                       "carceral_yes + house_yes + socnetwork_no", 
                                       "carceral_yes + house_yes + socnetwork_yes")))
  

colnames(seq_mean_all) <- c("mdsa_state", 
                            "black_mean",
                            "white_mean",
                            "hispanic_mean",
                            "other_mean")

## Plotting

# Black Mothers' Mean Time in Each State
seq_mean_black_plot <- seq_mean_all %>% 
  ggplot()+
  geom_col(mapping = aes(x= mdsa_state, y= black_mean, fill = mdsa_state))+
  geom_text(aes(x= mdsa_state, y= black_mean, label = black_mean), vjust= -1.5)+
  labs(title = "Black, non-Hispanic Mothers",
       x= NULL, y= NULL)+
  theme(axis.text.x = element_blank(),
        title= element_text(face = "bold"),
        panel.background = element_rect(fill = "white"),
        panel.grid.major.y = element_line(colour = "lightgray"),
        panel.grid.minor.y = element_line(colour = "lightgray"))+
  ylim(0,3)+
  scale_fill_manual(limits= c("carceral_no + house_no + socnetwork_no", 
                                       "carceral_no + house_no + socnetwork_yes",
                                       "carceral_no + house_yes + socnetwork_no", 
                                       "carceral_yes + house_no + socnetwork_no",
                                       "carceral_no + house_yes + socnetwork_yes", 
                                       "carceral_yes + house_no + socnetwork_yes",
                                       "carceral_yes + house_yes + socnetwork_no", 
                                       "carceral_yes + house_yes + socnetwork_yes"),
                    values = c("forestgreen","yellow", "yellow2", "yellow4", 
                                  "orange","darkorange1", "orange4", "red"),
                    guide= guide_legend("MDSA Sequence State"))

# White Mothers' Mean Time in Each State
seq_mean_white_plot <- seq_mean_all %>% 
  ggplot()+
  geom_col(mapping = aes(x= mdsa_state, y= white_mean, fill = mdsa_state))+
  geom_text(aes(x= mdsa_state, y= white_mean, label = white_mean), vjust= -1.5)+
  labs(title = "White, non-Hispanic Mothers",
       x= NULL, y= NULL)+
  theme(axis.text.x = element_blank(),
        title= element_text(face = "bold"),
        panel.background = element_rect(fill = "white"),
        panel.grid.major.y = element_line(colour = "lightgray"),
        panel.grid.minor.y = element_line(colour = "lightgray"))+
  ylim(0,3)+
  scale_fill_manual(limits= c("carceral_no + house_no + socnetwork_no", 
                                       "carceral_no + house_no + socnetwork_yes",
                                       "carceral_no + house_yes + socnetwork_no", 
                                       "carceral_yes + house_no + socnetwork_no",
                                       "carceral_no + house_yes + socnetwork_yes", 
                                       "carceral_yes + house_no + socnetwork_yes",
                                       "carceral_yes + house_yes + socnetwork_no", 
                                       "carceral_yes + house_yes + socnetwork_yes"),
                    values = c("forestgreen","yellow", "yellow2", "yellow4", 
                                  "orange","darkorange1", "orange4", "red"),
                    guide= guide_legend("MDSA Sequence State"))

# Hispanic Mothers' Mean Time in Each State
seq_mean_hispanic_plot <- seq_mean_all %>% 
  ggplot()+
  geom_col(mapping = aes(x= mdsa_state, y= hispanic_mean, fill = mdsa_state))+
  geom_text(aes(x= mdsa_state, y= hispanic_mean, label = hispanic_mean), vjust= -1.5)+
  labs(title = "Hispanic Mothers",
       x= NULL, y= NULL)+
  theme(axis.text.x = element_blank(),
        title= element_text(face = "bold"),
        panel.background = element_rect(fill = "white"),
        panel.grid.major.y = element_line(colour = "lightgray"),
        panel.grid.minor.y = element_line(colour = "lightgray"))+
  ylim(0,3)+
  scale_fill_manual(limits= c("carceral_no + house_no + socnetwork_no", 
                                       "carceral_no + house_no + socnetwork_yes",
                                       "carceral_no + house_yes + socnetwork_no", 
                                       "carceral_yes + house_no + socnetwork_no",
                                       "carceral_no + house_yes + socnetwork_yes", 
                                       "carceral_yes + house_no + socnetwork_yes",
                                       "carceral_yes + house_yes + socnetwork_no", 
                                       "carceral_yes + house_yes + socnetwork_yes"),
                    values = c("forestgreen","yellow", "yellow2", "yellow4", 
                                  "orange","darkorange1", "orange4", "red"),
                    guide= guide_legend("MDSA Sequence State"))

# Mothers of Other Races/Ethnicities' Mean Time in Each State
seq_mean_other_plot <- seq_mean_all %>% 
  ggplot()+
  geom_col(mapping = aes(x= mdsa_state, y= other_mean, fill = mdsa_state))+
  geom_text(aes(x= mdsa_state, y= other_mean, label = other_mean), vjust= -1.5)+
  labs(title = "Mothers of Other Races/Ethnicities",
       x= NULL, y= NULL)+
  theme(axis.text.x = element_blank(),
        title= element_text(face = "bold"),
        panel.background = element_rect(fill = "white"),
        panel.grid.major.y = element_line(colour = "lightgray"),
        panel.grid.minor.y = element_line(colour = "lightgray"))+
  ylim(0,3)+
  scale_fill_manual(limits= c("carceral_no + house_no + socnetwork_no", 
                                       "carceral_no + house_no + socnetwork_yes",
                                       "carceral_no + house_yes + socnetwork_no", 
                                       "carceral_yes + house_no + socnetwork_no",
                                       "carceral_no + house_yes + socnetwork_yes", 
                                       "carceral_yes + house_no + socnetwork_yes",
                                       "carceral_yes + house_yes + socnetwork_no", 
                                       "carceral_yes + house_yes + socnetwork_yes"),
                    values = c("forestgreen","yellow", "yellow2", "yellow4", 
                                  "orange","darkorange1", "orange4", "red"),
                    guide= guide_legend("MDSA Sequence State"))


MD_race_meantime <- ggarrange(seq_mean_black_plot, seq_mean_white_plot, seq_mean_hispanic_plot,
             seq_mean_other_plot, nrow= 4, left= "Mean Time", 
             bottom= "Multidomain Sequence State", legend = "bottom",
          legend.grob = get_legend(seq_mean_black_plot, position = "bottom"))


png("MD_race_meantime.png", width=8500, height=5000, res = 650, pointsize = 10) 
MD_race_meantime$`1`
dev.off()
```


## Examining Cluster Distributions: By Race (Bar Plots)
```{r}
FF_MD_clus_race_counts <- FF_MD_clus %>% 
  dplyr::select(mo_race_eth) %>% 
  count(mo_race_eth) %>% 
  mutate(mo_race_eth= c("White, Non-Hispanic", "Black, Non-Hispanic",
                        "Hispanic", "Other"))

FF_MD_clus_select_race <- FF_MD_clus %>% 
  dplyr::select(cluster_MD4, mo_race_eth) %>% 
  count(mo_race_eth, cluster_MD4) %>% 
  group_by(mo_race_eth, cluster_MD4) %>% 
  summarise(count= sum(n)) %>% 
  ungroup %>% 
  mutate(total= case_when(mo_race_eth %in% c("1 white, non-hispanic") ~ 1030,
                          mo_race_eth %in% c("2 black, non-hispanic") ~ 2323,
                          mo_race_eth %in% c("3 hispanic") ~ 1332,
                          mo_race_eth %in% c("4 other") ~ 192)) %>% 
  mutate(prop_clus= round(count/total, digits = 2)) 


##plotting proportions##
MD_clus_race_bar_prop <- ggplot(FF_MD_clus_select_race, aes(x= mo_race_eth, y= prop_clus, 
                                                 fill= cluster_MD4,
                                                 label = prop_clus)) +
  geom_col() +
  labs(x= "Mothers' Race/Ethnicity",
       y= "Proportion of Mothers of that Race/Ethnicity")+
  geom_text(size = 4, position = position_stack(vjust = 0.5), color= "black") +
  theme(axis.text= element_text(size = 10, colour = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  coord_flip() +
  scale_x_discrete(labels= c("White, Non-Hispanic (n=1030)", "Black, Non-Hispanic (n=2323)",
                             "Hispanic (n=1332)", "Other Race/Ethnicity (n=192)")) +
  scale_fill_manual(name= "Cluster Assignment",
                    values = c("forestgreen","yellow2","orange","red")) 

#ggsave(file="Dist_MD_Clus_Race_prop.png", MD_clus_race_bar_prop, width = 12,height = 7, units = "in", dpi = 800)
MD_clus_race_bar_prop
```

## Examining Cummulative Adversity Scores by Race/Cluster 
```{r}
#wrangling/cleaning data
FF_adv.comp_withpredictors$index <- rep(FF_adversity_FULL$index, times= 10) 

col_names_FF <- colnames(FF_adv.comp_withpredictors)

FF_test <- FF_adv.comp_withpredictors %>% 
  relocate(index, .before = wave1_fjail) %>% 
  subset(select = -c(.imp, .id)) %>% 
  group_by(index) %>% 
  summarise_all(mean) 


FF_MD_adv <- as.data.frame(ifelse(FF_test[2:49] >0, 1, 0)) %>% 
  mutate(index= FF_test$index,
       mo_race_eth= clusterdf_demo_MD$mo_race_eth,
       cluster_assign4= clusterdf_demo_MD$cluster_MD4) %>% 
  relocate(c(index, cluster_assign4, mo_race_eth), .before = wave1_fjail)

# getting cumulative adversity scores for each mother for each wave
w1_sums_all <- FF_MD_adv %>% 
  dplyr::select(starts_with("wave1")) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "wave1_sums"))

w2_sums_all <- FF_MD_adv %>% 
  dplyr::select(starts_with("wave2")) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "wave2_sums"))

w3_sums_all <- FF_MD_adv %>% 
  dplyr::select(starts_with("wave3")) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "wave3_sums"))

w4_sums_all <- FF_MD_adv %>% 
  dplyr::select(starts_with("wave4")) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "wave4_sums"))

#getting cumulative adversity across all four waves for each mother
all_waves_sums <- cbind(w1_sums_all , w2_sums_all,w3_sums_all, w4_sums_all) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "allwaves_sums"))

#creating a data frame with all five cummulative adversity scores (total & each wave)
sums_df <-cbind(w1_sums_all , w2_sums_all,w3_sums_all ,w4_sums_all, all_waves_sums) %>%  
  mutate(index= FF_MD_adv$index,
         mo_race_eth= FF_MD_adv$mo_race_eth,
         cluster_assign4 = FF_MD_adv$cluster_assign4) %>% 
  relocate(c(index, mo_race_eth, cluster_assign4), .before = everything()) 

#re-labeling variables for plotting
sums_df_factor <- sums_df

sums_df_factor$mo_race_eth <- factor(sums_df_factor$mo_race_eth,
                                     levels = c("1 white, non-hispanic", 
                                                   "2 black, non-hispanic",
                                                   "3 hispanic", "4 other"),
                                     labels = c("White, Non-Hispanic", 
                                                   "Black, Non-Hispanic",
                                                   "Hispanic", "Other Race/Ethnicity"))

#plotting cummulative adversity scores across all four waves faceted by cluster and race

# png("all_adv_sums_hist_bycluster_race4.png", width=13000, height=8000, res = 900, pointsize = 7)
sums_df_factor %>%
  ggplot(aes(x=allwaves_sums, fill=mo_race_eth)) +
  geom_histogram(position = "identity", col=I("black"), bins = 20) +
  # geom_vline(aes(xintercept=20), color="black", linetype="dashed") + 
  scale_fill_manual(values = c("#e41a1c","#4daf4a", "#984ea3","#e6ab02"),
                    guide= "none")+
  facet_wrap(~ cluster_assign4 + mo_race_eth,
             nrow= 4) +
  labs(x= "Total Number of Adverse Experiences", y= "Number of Mothers")+
  theme(strip.text.x = element_text(
        size = 9, color = "black", face = "bold"),
        strip.background.x = element_rect(linetype = "solid", fill = "white",
                                          linewidth = 1, color = "black"),
        panel.background = element_rect(fill = "white"),
        axis.title = element_text(colour = "black", face = "bold"))
# dev.off()
```


## Examining Clusters at Individual Adverse Event Level 

### Consistently Very High Adversity (3 Domains) Cluster 
```{r}
#black medium-high cluster mothers
MD_adv_long_very_high_black <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very High Adversity (3 Domains)",
         mo_race_eth== "2 black, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_black= round(num_yes/1198, digits = 2))

#hispanic medium-high cluster mothers
MD_adv_long_very_high_hisp <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very High Adversity (3 Domains)",
         mo_race_eth== "3 hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_hisp= round(num_yes/552, digits = 2))

#'other' medium-high cluster mothers
MD_adv_long_very_high_other <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very High Adversity (3 Domains)",
         mo_race_eth== "4 other") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_other= round(num_yes/64, digits = 2))

#white medium-high cluster mothers
MD_adv_long_very_high_white <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very High Adversity (3 Domains)",
         mo_race_eth== "1 white, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_white= round(num_yes/304, digits = 2))

#all mothers (full data set)
MD_adv_long_very_high <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very High Adversity (3 Domains)") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_all= round(num_yes/2118, digits = 2)) %>% 
  mutate(prop_black = MD_adv_long_very_high_black$prop_black) %>% 
  mutate(prop_hispanic = MD_adv_long_very_high_hisp$prop_hisp) %>%
  mutate(prop_other = MD_adv_long_very_high_other$prop_other) %>% 
  mutate(prop_white = MD_adv_long_very_high_white$prop_white) 

MD_longer_very_high <- MD_adv_long_very_high %>% 
  pivot_longer(cols = c(prop_black, prop_hispanic, prop_other, prop_white), 
               names_to = c("category"), 
               values_to = "props") %>% 
  mutate(category= case_when(category== "prop_black" ~ "Black, non-Hispanic",
                             category== "prop_hispanic" ~ "Hispanic",
                             category== "prop_other" ~ "Other",
                             category== "prop_white" ~ "White, non-Hispanic"))
```

```{r, fig.height=9, fig.width=9}
#plotting 
w1_MD <-MD_longer_very_high %>% 
  filter(str_detect(adversity, "wave1")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x=props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL, title = "Wave 1 (Y1)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave1_fjail",
                              "wave1_feverjail",
                              "wave1_fprobs",
                              "wave1_nonreghouse",
                              "wave1_moneymove",
                              "wave1_tele",
                              "wave1_gaselec",
                              "wave1_evict",
                              "wave1_emcare",
                              "wave1_1kcosign",
                              "wave1_1kloan",
                              "wave1_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w2_MD <-MD_longer_very_high %>% 
  filter(str_detect(adversity, "wave2")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 2 (Y3)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave2_fjail",
                              "wave2_feverjail",
                              "wave2_fprobs",
                              "wave2_nonreghouse",
                              "wave2_moneymove",
                              "wave2_tele",
                              "wave2_gaselec",
                              "wave2_evict",
                              "wave2_emcare",
                              "wave2_1kcosign",
                              "wave2_1kloan",
                              "wave2_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w3_MD <-MD_longer_very_high %>% 
  filter(str_detect(adversity, "wave3")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 3 (Y5)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave3_fjail",
                              "wave3_feverjail",
                              "wave3_fprobs",
                              "wave3_nonreghouse",
                              "wave3_moneymove",
                              "wave3_tele",
                              "wave3_gaselec",
                              "wave3_evict",
                              "wave3_emcare",
                              "wave3_1kcosign",
                              "wave3_1kloan",
                              "wave3_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w4_MD <-MD_longer_very_high %>% 
  filter(str_detect(adversity, "wave4")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 4 (Y9)") +
  scale_x_continuous(limits = c(0, 1))+
  scale_y_discrete(limits = c("wave4_fjail",
                              "wave4_feverjail",
                              "wave4_fprobs",
                              "wave4_nonreghouse",
                              "wave4_moneymove",
                              "wave4_tele",
                              "wave4_gaselec",
                              "wave4_evict",
                              "wave4_emcare",
                              "wave4_1kcosign",
                              "wave4_1kloan",
                              "wave4_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

prop_grid_very_high <- grid.arrange(w1_MD, w2_MD, w3_MD, w4_MD,
                          left= "Adverse Event",
                          bottom= "Proportion of Racial/Ethnic Group")
prop_grid_very_high

ggsave(file="Bar_Adv_Prop_byRace_very_high.png", prop_grid_very_high, width = 10, height = 5.43, units = "in")

```

### Enduring Carceral Adversity (1-3 Domains) Cluster 
```{r}
#black carceral cluster mothers
MD_adv_long_car_black <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Carceral Adversity (1-3 Domains)",
         mo_race_eth== "2 black, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_black= round(num_yes/246, digits = 2))

#hispanic carceral cluster mothers
MD_adv_long_car_hisp <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Carceral Adversity (1-3 Domains)",
         mo_race_eth== "3 hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_hisp= round(num_yes/133, digits = 2))

#'other' carceral cluster mothers
MD_adv_long_car_other <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Carceral Adversity (1-3 Domains)",
         mo_race_eth== "4 other") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_other= round(num_yes/16, digits = 2))

#white carceral cluster mothers
MD_adv_long_car_white <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Carceral Adversity (1-3 Domains)",
         mo_race_eth== "1 white, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_white= round(num_yes/128, digits = 2))

#all mothers (full data set)
MD_adv_long_car <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Carceral Adversity (1-3 Domains)") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_all= round(num_yes/523, digits = 2)) %>% 
  mutate(prop_black = MD_adv_long_car_black$prop_black) %>% 
  mutate(prop_hispanic = MD_adv_long_car_hisp$prop_hisp) %>%
  mutate(prop_other = MD_adv_long_car_other$prop_other) %>% 
  mutate(prop_white = MD_adv_long_car_white$prop_white) 

MD_longer_car <- MD_adv_long_car %>% 
  pivot_longer(cols = c(prop_black, prop_hispanic, prop_other, prop_white), 
               names_to = c("category"), 
               values_to = "props") %>% 
  mutate(category= case_when(category== "prop_black" ~ "Black, non-Hispanic",
                             category== "prop_hispanic" ~ "Hispanic",
                             category== "prop_other" ~ "Other",
                             category== "prop_white" ~ "White, non-Hispanic"))
```

```{r, fig.height=9, fig.width=9}
#plotting 
w1_MD <-MD_longer_car %>% 
  filter(str_detect(adversity, "wave1")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x=props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL, title = "Wave 1 (Y1)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave1_fjail",
                              "wave1_feverjail",
                              "wave1_fprobs",
                              "wave1_nonreghouse",
                              "wave1_moneymove",
                              "wave1_tele",
                              "wave1_gaselec",
                              "wave1_evict",
                              "wave1_emcare",
                              "wave1_1kcosign",
                              "wave1_1kloan",
                              "wave1_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w2_MD <-MD_longer_car %>% 
  filter(str_detect(adversity, "wave2")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 2 (Y3)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave2_fjail",
                              "wave2_feverjail",
                              "wave2_fprobs",
                              "wave2_nonreghouse",
                              "wave2_moneymove",
                              "wave2_tele",
                              "wave2_gaselec",
                              "wave2_evict",
                              "wave2_emcare",
                              "wave2_1kcosign",
                              "wave2_1kloan",
                              "wave2_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w3_MD <-MD_longer_car %>% 
  filter(str_detect(adversity, "wave3")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 3 (Y5)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave3_fjail",
                              "wave3_feverjail",
                              "wave3_fprobs",
                              "wave3_nonreghouse",
                              "wave3_moneymove",
                              "wave3_tele",
                              "wave3_gaselec",
                              "wave3_evict",
                              "wave3_emcare",
                              "wave3_1kcosign",
                              "wave3_1kloan",
                              "wave3_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w4_MD <-MD_longer_car %>% 
  filter(str_detect(adversity, "wave4")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 4 (Y9)") +
  scale_x_continuous(limits = c(0, 1))+
  scale_y_discrete(limits = c("wave4_fjail",
                              "wave4_feverjail",
                              "wave4_fprobs",
                              "wave4_nonreghouse",
                              "wave4_moneymove",
                              "wave4_tele",
                              "wave4_gaselec",
                              "wave4_evict",
                              "wave4_emcare",
                              "wave4_1kcosign",
                              "wave4_1kloan",
                              "wave4_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

prop_grid_car <- grid.arrange(w1_MD, w2_MD, w3_MD, w4_MD,
                          left= "Adverse Event",
                          bottom= "Proportion of Racial/Ethnic Group")
prop_grid_car

ggsave(file="Bar_Adv_Prop_byRace_car.png", prop_grid_car, width = 10, height = 5.43, units = "in")

```


### Enduring Material Social Network Adversity (1 Domain) Cluster 
```{r}
#black social network cluster mothers
MD_adv_long_sn_black <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Material Social Network Adversity (1 Domain)",
         mo_race_eth== "2 black, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_black= round(num_yes/506, digits = 2))

#hispanic social network cluster mothers
MD_adv_long_sn_hisp <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Material Social Network Adversity (1 Domain)",
         mo_race_eth== "3 hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_hisp= round(num_yes/355, digits = 2))

#'other' social network cluster mothers
MD_adv_long_sn_other <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Material Social Network Adversity (1 Domain)",
         mo_race_eth== "4 other") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_other= round(num_yes/50, digits = 2))

#white social network cluster mothers
MD_adv_long_sn_white <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Material Social Network Adversity (1 Domain)",
         mo_race_eth== "1 white, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_white= round(num_yes/150, digits = 2))

#all mothers (full data set)
MD_adv_long_sn <- FF_MD_adv %>% 
  filter(cluster_assign4== "Enduring Material Social Network Adversity (1 Domain)") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_all= round(num_yes/1061, digits = 2)) %>% 
  mutate(prop_black = MD_adv_long_sn_black$prop_black) %>% 
  mutate(prop_hispanic = MD_adv_long_sn_hisp$prop_hisp) %>%
  mutate(prop_other = MD_adv_long_sn_other$prop_other) %>% 
  mutate(prop_white = MD_adv_long_sn_white$prop_white) 

MD_longer_sn <- MD_adv_long_sn %>% 
  pivot_longer(cols = c(prop_black, prop_hispanic, prop_other, prop_white), 
               names_to = c("category"), 
               values_to = "props") %>% 
  mutate(category= case_when(category== "prop_black" ~ "Black, non-Hispanic",
                             category== "prop_hispanic" ~ "Hispanic",
                             category== "prop_other" ~ "Other",
                             category== "prop_white" ~ "White, non-Hispanic"))
```

```{r, fig.height=9, fig.width=9}
#plotting 
w1_MD <-MD_longer_sn %>% 
  filter(str_detect(adversity, "wave1")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x=props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL, title = "Wave 1 (Y1)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave1_fjail",
                              "wave1_feverjail",
                              "wave1_fprobs",
                              "wave1_nonreghouse",
                              "wave1_moneymove",
                              "wave1_tele",
                              "wave1_gaselec",
                              "wave1_evict",
                              "wave1_emcare",
                              "wave1_1kcosign",
                              "wave1_1kloan",
                              "wave1_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w2_MD <-MD_longer_sn %>% 
  filter(str_detect(adversity, "wave2")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 2 (Y3)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave2_fjail",
                              "wave2_feverjail",
                              "wave2_fprobs",
                              "wave2_nonreghouse",
                              "wave2_moneymove",
                              "wave2_tele",
                              "wave2_gaselec",
                              "wave2_evict",
                              "wave2_emcare",
                              "wave2_1kcosign",
                              "wave2_1kloan",
                              "wave2_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w3_MD <-MD_longer_sn %>% 
  filter(str_detect(adversity, "wave3")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 3 (Y5)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave3_fjail",
                              "wave3_feverjail",
                              "wave3_fprobs",
                              "wave3_nonreghouse",
                              "wave3_moneymove",
                              "wave3_tele",
                              "wave3_gaselec",
                              "wave3_evict",
                              "wave3_emcare",
                              "wave3_1kcosign",
                              "wave3_1kloan",
                              "wave3_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w4_MD <-MD_longer_sn %>% 
  filter(str_detect(adversity, "wave4")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 4 (Y9)") +
  scale_x_continuous(limits = c(0, 1))+
  scale_y_discrete(limits = c("wave4_fjail",
                              "wave4_feverjail",
                              "wave4_fprobs",
                              "wave4_nonreghouse",
                              "wave4_moneymove",
                              "wave4_tele",
                              "wave4_gaselec",
                              "wave4_evict",
                              "wave4_emcare",
                              "wave4_1kcosign",
                              "wave4_1kloan",
                              "wave4_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

prop_grid_sn <- grid.arrange(w1_MD, w2_MD, w3_MD, w4_MD,
                          left= "Adverse Event",
                          bottom= "Proportion of Racial/Ethnic Group")
prop_grid_sn

ggsave(file="Bar_Adv_Prop_byRace_sn.png", prop_grid_sn, width = 10, height = 5.43, units = "in")

```


### Consistently Very Low Adversity (0-1 Domains) Cluster 
```{r}
#black very low cluster mothers
MD_adv_long_very_low_black <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very Low Adversity (0-1 Domains)",
         mo_race_eth== "2 black, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_black= round(num_yes/373, digits = 2))

#hispanic very low cluster mothers
MD_adv_long_very_low_hisp <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very Low Adversity (0-1 Domains)",
         mo_race_eth== "3 hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_hisp= round(num_yes/292, digits = 2))

#'other' very low cluster mothers
MD_adv_long_very_low_other <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very Low Adversity (0-1 Domains)",
         mo_race_eth== "4 other") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_other= round(num_yes/62, digits = 2))

#white very low cluster mothers
MD_adv_long_very_low_white <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very Low Adversity (0-1 Domains)",
         mo_race_eth== "1 white, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_white= round(num_yes/448, digits = 2))

#all mothers (full data set)
MD_adv_long_very_low <- FF_MD_adv %>% 
  filter(cluster_assign4== "Consistently Very Low Adversity (0-1 Domains)") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign4)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_all= round(num_yes/1175, digits = 2)) %>% 
  mutate(prop_black = MD_adv_long_very_low_black$prop_black) %>% 
  mutate(prop_hispanic = MD_adv_long_very_low_hisp$prop_hisp) %>%
  mutate(prop_other = MD_adv_long_very_low_other$prop_other) %>% 
  mutate(prop_white = MD_adv_long_very_low_white$prop_white) 

MD_longer_very_low <- MD_adv_long_very_low %>% 
  pivot_longer(cols = c(prop_black, prop_hispanic, prop_other, prop_white), 
               names_to = c("category"), 
               values_to = "props") %>% 
  mutate(category= case_when(category== "prop_black" ~ "Black, non-Hispanic",
                             category== "prop_hispanic" ~ "Hispanic",
                             category== "prop_other" ~ "Other",
                             category== "prop_white" ~ "White, non-Hispanic"))
```

```{r, fig.height=9, fig.width=9}
#plotting 
w1_MD <-MD_longer_very_low %>% 
  filter(str_detect(adversity, "wave1")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x=props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL, title = "Wave 1 (Y1)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave1_fjail",
                              "wave1_feverjail",
                              "wave1_fprobs",
                              "wave1_nonreghouse",
                              "wave1_moneymove",
                              "wave1_tele",
                              "wave1_gaselec",
                              "wave1_evict",
                              "wave1_emcare",
                              "wave1_1kcosign",
                              "wave1_1kloan",
                              "wave1_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w2_MD <-MD_longer_very_low %>% 
  filter(str_detect(adversity, "wave2")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 2 (Y3)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave2_fjail",
                              "wave2_feverjail",
                              "wave2_fprobs",
                              "wave2_nonreghouse",
                              "wave2_moneymove",
                              "wave2_tele",
                              "wave2_gaselec",
                              "wave2_evict",
                              "wave2_emcare",
                              "wave2_1kcosign",
                              "wave2_1kloan",
                              "wave2_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w3_MD <-MD_longer_very_low %>% 
  filter(str_detect(adversity, "wave3")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 3 (Y5)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(limits = c("wave3_fjail",
                              "wave3_feverjail",
                              "wave3_fprobs",
                              "wave3_nonreghouse",
                              "wave3_moneymove",
                              "wave3_tele",
                              "wave3_gaselec",
                              "wave3_evict",
                              "wave3_emcare",
                              "wave3_1kcosign",
                              "wave3_1kloan",
                              "wave3_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w4_MD <-MD_longer_very_low %>% 
  filter(str_detect(adversity, "wave4")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 4 (Y9)") +
  scale_x_continuous(limits = c(0, 1))+
  scale_y_discrete(limits = c("wave4_fjail",
                              "wave4_feverjail",
                              "wave4_fprobs",
                              "wave4_nonreghouse",
                              "wave4_moneymove",
                              "wave4_tele",
                              "wave4_gaselec",
                              "wave4_evict",
                              "wave4_emcare",
                              "wave4_1kcosign",
                              "wave4_1kloan",
                              "wave4_200loan"),
                   labels = c("father currently jailed",
                            "father ever jailed",
                            "father drug issues",
                            "houselessness",
                            "forced move",
                            "tele disconnect",
                            "utilities cut",
                            "evicted",
                            "lack of emergency care",
                            "$1k cosign",
                            "$1k loan",
                            "$200 loan"))+
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

prop_grid_vlow <- grid.arrange(w1_MD, w2_MD, w3_MD, w4_MD,
                          left= "Adverse Event",
                          bottom= "Proportion of Racial/Ethnic Group")
prop_grid_vlow
ggsave(file="Bar_Adv_Prop_byRace_very_low.png", prop_grid_vlow, width = 10, height = 5.43, units = "in")

```


## SECONDARY ANALYSIS: Examining Clusters Against Conventional Poverty Measure

### Data Cleaning & Wrangling
```{r}
#extracting relevant variables 
FF_MD_POV <- FF %>% 
  subset(select= c(index,
                   cm1povca, cm2povca, cm3povca, cm4povca, cm5povca))

FF_MD_POV <- data.frame(index= FF_MD_clus$index) %>% 
  left_join(FF_MD_POV, by= "index")

#renaming to more intuitive variable names
colnames(FF_MD_POV)[2:6] <- c("mo_pov_wave0","mo_pov_wave1","mo_pov_wave2", 
                            "mo_pov_wave3", "mo_pov_wave4")

#cleaning missing data
FF_MD_POV[FF_MD_POV == "-3 Missing"] <- NA
FF_MD_POV[FF_MD_POV == "-9 Not in wave"] <- NA
FF_MD_POV[FF_MD_POV == "-6 skip"] <- NA
FF_MD_POV[FF_MD_POV == "-6 Skip"] <- NA
FF_MD_POV[FF_MD_POV == "-2 Don't know"] <- NA
FF_MD_POV[FF_MD_POV == "-1 Refuse"] <- NA
FF_MD_POV[FF_MD_POV == "-7 N/A"] <- NA
FF_MD_POV[FF_MD_POV == "-8 Out of range"] <- NA
FF_MD_POV[FF_MD_POV == "-1"] <- NA
FF_MD_POV[FF_MD_POV == "-2"] <- NA
FF_MD_POV[FF_MD_POV == "-3"] <- NA
FF_MD_POV[FF_MD_POV == "-4"] <- NA
FF_MD_POV[FF_MD_POV == "-5"] <- NA
FF_MD_POV[FF_MD_POV == "-6"] <- NA
FF_MD_POV[FF_MD_POV == "-7"] <- NA
FF_MD_POV[FF_MD_POV == "-8"] <- NA
FF_MD_POV[FF_MD_POV == "-9"] <- NA

#changing class of variables for recoding
for(i in 2:6){
  FF_MD_POV[,i] <- to_character(FF_MD_POV[,i])
}

#recoding variables
FF_MD_POV <- FF_MD_POV %>% 
  mutate(mo_pov_wave0=
           case_when(mo_pov_wave0 %in% c("1 0-49%") ~ 1,
                     mo_pov_wave0 %in% c("2 50-99%") ~ 2,
                     mo_pov_wave0 %in% c("3 100-199%") ~ 3,
                     mo_pov_wave0 %in% c("4 200-299%") ~ 4,
                     mo_pov_wave0 %in% c("300%+") ~ 5)) %>%
  mutate(mo_pov_wave1=
           case_when(mo_pov_wave1 %in% c("1 0-49%") ~ 1,
                     mo_pov_wave1 %in% c("2 50-99%") ~ 2,
                     mo_pov_wave1 %in% c("3 100-199%") ~ 3,
                     mo_pov_wave1 %in% c("4 200-299%") ~ 4,
                     mo_pov_wave1 %in% c("5 300%+") ~ 5)) %>% 
  mutate(mo_pov_wave2=
           case_when(mo_pov_wave2 %in% c("1 0-49%") ~ 1,
                     mo_pov_wave2 %in% c("2 50-99%") ~ 2,
                     mo_pov_wave2 %in% c("3 100-199%") ~ 3,
                     mo_pov_wave2 %in% c("4 200-299%") ~ 4,
                     mo_pov_wave2 %in% c("5 300%+") ~ 5)) %>% 
  mutate(mo_pov_wave3=
           case_when(mo_pov_wave3 %in% c("1 0-49%") ~ 1,
                     mo_pov_wave3 %in% c("2 50-99%") ~ 2,
                     mo_pov_wave3 %in% c("3 100-199%") ~ 3,
                     mo_pov_wave3 %in% c("4 200-299%") ~ 4,
                     mo_pov_wave3 %in% c("5 300%+") ~ 5))

#changing class into numeric for imputation
for(i in 6){
  FF_MD_POV[,i] <- as.numeric(FF_MD_POV[,i])
}
```

### Imputing Missing Data
```{r, warning=FALSE}
set.seed(08540)

FF_MD_POV_ONLY <- FF_MD_POV[,c(2:6)]

#imputing missing data
FF_MD_POV_ONLY_imp <- mice(data=FF_MD_POV_ONLY, m= 10, method = "pmm",
                           print= F)

#creating imputed data set
FF_MD_POV_comp <- complete(FF_MD_POV_ONLY_imp) %>% 
  mutate(index= FF_MD_POV$index) %>% 
  relocate(index, .before = mo_pov_wave0)
```

### Plotting
```{r}
#recoding poverty variables into three levels (0-99%=3 // 100%-199$=2 // 200%+=1)
FF_MD_POV_base <- FF_MD_POV_comp %>% 
  mutate(mo_pov_wave0=
           case_when(mo_pov_wave0 %in% c(1,2) ~ 3,
                     mo_pov_wave0 %in% c(3) ~ 2,
                     mo_pov_wave0 %in% c(4, 5) ~ 1)) 

#getting poverty distribution of sample
FF_MD_POV_counts <-FF_MD_POV_base %>% 
  dplyr::select(mo_pov_wave0) %>% 
  count(mo_pov_wave0) %>% 
  mutate(mo_pov_wave0= c("200%+ pov level", "100%-199% pov level", 
                         "<100% pov level"))

FF_MD_clus <- FF_MD_clus %>% 
  mutate(mo_pov_wave0= FF_MD_POV_base$mo_pov_wave0) %>% 
  mutate(mo_pov_wave0= 
           case_when(mo_pov_wave0 %in% c(3) ~ "<100% pov level",
                     mo_pov_wave0 %in% c(2) ~ "100%-199% pov level",
                     mo_pov_wave0 %in% c(1) ~ "200%+ pov level"))

FF_MD_clus_select_pov <- FF_MD_clus %>% 
  dplyr::select(cluster_MD4, mo_pov_wave0) %>% 
  count(mo_pov_wave0, cluster_MD4) %>% 
  group_by(mo_pov_wave0, cluster_MD4) %>% 
  summarise(count= sum(n)) %>% 
  ungroup %>% 
  mutate(total= case_when(mo_pov_wave0 %in% c("<100% pov level") ~ 1760,
                          mo_pov_wave0 %in% c("100%-199% pov level") ~ 1256,
                          mo_pov_wave0 %in% c("200%+ pov level") ~ 1861)) %>% 
  mutate(prop_clus= round(count/total, digits = 3)) 


#plotting as bar graph--proportions
MD_clus_pov_bar_prop <- ggplot(FF_MD_clus_select_pov, aes(x= mo_pov_wave0, 
                                                           y= prop_clus, 
                                                           fill= cluster_MD4,
                                                           label = prop_clus)) +
  geom_col() +
  labs(title = "Distribution of MD Clusters by Poverty Status by Proportion (n=4,877)",
       x= "Poverty Status",
       y= "Proportion of Mothers of that Poverty Status")+
  geom_text(size = 3, position = position_stack(vjust = 0.5), color= "white") +
  theme_bw() +
  scale_fill_manual(name= "Cluster Assigment", 
                    values= c("#4daf4a","#377eb8","#984ea3","#e41a1c")) +
  coord_flip() 
MD_clus_pov_bar_prop

#plotting with clusters on y axis
FF_MD_POV_counts_y <- FF_MD_POV_base %>% 
  mutate(cluster_MD4 = FF_MD_clus$cluster_MD4) %>% 
  dplyr::select(cluster_MD4) %>% 
  count(cluster_MD4) 

FF_MD_clus_select_pov_y <- FF_MD_clus %>% 
  dplyr::select(cluster_MD4, mo_pov_wave0) %>% 
  count(mo_pov_wave0, cluster_MD4) %>% 
  group_by(mo_pov_wave0, cluster_MD4) %>% 
  summarise(count= sum(n)) %>% 
  ungroup %>% 
  mutate(total= case_when(cluster_MD4 %in% c("Consistently Very Low Adversity (0-1 Domains)") ~ 1175,
                          cluster_MD4 %in% c("Enduring Material Social Network Adversity (1 Domain)") ~ 1061,
                          cluster_MD4 %in% c("Enduring Carceral Adversity (1-3 Domains)") ~ 523,
                          cluster_MD4 %in% c("Consistently Very High Adversity (3 Domains)") ~ 2118)) %>% 
  mutate(prop_clus= round(count/total, digits = 3)) 


#plotting as bar graph--proportions
MD_clus_pov_bar_prop_y <- ggplot(FF_MD_clus_select_pov_y, aes(x= prop_clus, 
                                                       y= cluster_MD4, 
                                                 fill= mo_pov_wave0,
                                                 label = prop_clus)) +
  geom_col() +
  labs(x= "Proportion of Mothers of that Cluster",
       y= "Cluster Assignment")+
  geom_text(size = 4, position = position_stack(vjust = 0.5), color= "white") +
  theme(axis.text= element_text(size = 10, colour = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  scale_fill_manual(name= "Poverty Status", 
                    values= c("#d95f02","#7570b3","#1b9e77"))
MD_clus_pov_bar_prop_y

ggsave(file="Dist_MD_clus_pov_bar_prop-y.png", MD_clus_pov_bar_prop_y,width = 14, height = 7, units = "in", dpi = 800)
```


# SENSITIVITY ANALYSIS: Assessing Robustness of Results to the Addition of Domain Weights

## Domain Weights: 0.50, 0.30, 0.20 (carceral, housing, material social networks)

### Clustering MD sequences
```{r}
# Setting MD Costs/Distances 
MD_dist <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELSLOG",
                     cweight= c(0.50, 0.30, 0.20)) 
 
# conducting hierarchical cluster analysis (ward-d2) 
MD_clus <- agnes(MD_dist, diss = T, method = "ward") 

# png("dendrogram_final.png", width=7000, height=4000, res = 800)
# plot(MD_clus)
# rect.hclust(MD_clus, k= 3)
# dev.off()
```


### Visualizing Clusters
```{r}
MD_cut4 <- cutree(MD_clus, k= 4)  
# MD_cut_fac4 <- factor(MD_cut4, labels = paste("Type", 1:4))  
MD_cut_fac4 <- factor(MD_cut4, levels = c(2, 4, 3, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"),
                                 ordered = TRUE)

##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_0.5.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()

#SEQUENCE INDEX PLOT
png("MDcluster_plot4_seqindex_0.5.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="I",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()
```

### Multinomial Regression Modeling w/ IDCD Clusters 
```{r}
#adding unordered version of cluster variables for multinomial regression
FF_MD_clus$cluster_MD4 <- MD_cut_fac4

FF_MD_clus <- FF_MD_clus %>% 
  mutate(cluster_MD4_m= factor(FF_MD_clus$cluster_MD4, ordered = F))

##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the very low adversity cluster [3 clusters]
FF_MD_clus$cluster_MD4_m <- relevel(FF_MD_clus$cluster_MD4_m,
                                      ref = "Consistently Very Low Adversity (0-1 Domains)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

## MODEL 1
# mother's race as sole predictor model
mod1_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD4)

z_mod1_MD4 <- summary(mod1_MD4)$coefficients/summary(mod1_MD4)$standard.errors
p_mod1_MD4 <- (1 - pnorm(abs(z_mod1_MD4), 0, 1)) * 2
p_mod1_MD4

## MODEL 2
# mother's race as predictor w/ education, income, and age of mother at focal child's
# birth as covariates
mod2_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth +
                                     hh_income_log + mo_edu_wave0 +
                                     mo_age_wave0,
                                   data = FF_MD_clus)

summary(mod2_MD4)

z_mod2_MD4 <- summary(mod2_MD4)$coefficients/summary(mod2_MD4)$standard.errors
p_mod2_MD4 <- (1 - pnorm(abs(z_mod2_MD4), 0, 1)) * 2
p_mod2_MD4
```

#### Multinomial Regression Table
```{r, results='asis', warning=FALSE}
stargazer(mod1_MD4, mod2_MD4,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          dep.var.labels = c("Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity",
                             "Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity"),
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Household Income (Logged)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "-10pt",
          notes.append = F,
          type = "html")
```


## Domain Weights: 0.6, 0.25, 0.15 (carceral, housing, material social networks)

### Clustering MD sequences
```{r}
# Setting MD Costs/Distances 
MD_dist <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELSLOG",
                     cweight= c(0.6, 0.25, 0.15)) 
 
# conducting hierarchical cluster analysis (ward-d2) 
MD_clus <- agnes(MD_dist, diss = T, method = "ward") 

# png("dendrogram_final.png", width=7000, height=4000, res = 800)
# plot(MD_clus)
# rect.hclust(MD_clus, k= 3)
# dev.off()
```


### Visualizing Clusters
```{r}
MD_cut4 <- cutree(MD_clus, k= 4)  
# MD_cut_fac4 <- factor(MD_cut4, labels = paste("Type", 1:4))  
MD_cut_fac4 <- factor(MD_cut4, levels = c(2, 4, 3, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"),
                                 ordered = TRUE)

##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_0.6.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()

#SEQUENCE INDEX PLOT
png("MDcluster_plot4_seqindex_0.6.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="I",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()
```

### Multinomial Regression Modeling w/ IDCD Clusters 
```{r}
#adding unordered version of cluster variables for multinomial regression
FF_MD_clus$cluster_MD4 <- MD_cut_fac4

FF_MD_clus <- FF_MD_clus %>% 
  mutate(cluster_MD4_m= factor(FF_MD_clus$cluster_MD4, ordered = F))

##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the very low adversity cluster [3 clusters]
FF_MD_clus$cluster_MD4_m <- relevel(FF_MD_clus$cluster_MD4_m,
                                      ref = "Consistently Very Low Adversity (0-1 Domains)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

## MODEL 1
# mother's race as sole predictor model
mod1_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD4)

z_mod1_MD4 <- summary(mod1_MD4)$coefficients/summary(mod1_MD4)$standard.errors
p_mod1_MD4 <- (1 - pnorm(abs(z_mod1_MD4), 0, 1)) * 2
p_mod1_MD4

## MODEL 2
# mother's race as predictor w/ education, income, and age of mother at focal child's
# birth as covariates
mod2_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth +
                                     hh_income_log + mo_edu_wave0 +
                                     mo_age_wave0,
                                   data = FF_MD_clus)

summary(mod2_MD4)

z_mod2_MD4 <- summary(mod2_MD4)$coefficients/summary(mod2_MD4)$standard.errors
p_mod2_MD4 <- (1 - pnorm(abs(z_mod2_MD4), 0, 1)) * 2
p_mod2_MD4
```

#### Multinomial Regression Table
```{r, results='asis', warning=FALSE}
stargazer(mod1_MD4, mod2_MD4,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          dep.var.labels = c("Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity",
                             "Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity"),
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Household Income (Logged)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "-10pt",
          notes.append = F,
          type = "html")
```


## Domain Weights: 0.70, 0.20, 0.10 (carceral, housing, material social networks)

### Clustering MD sequences
```{r}
# Setting MD Costs/Distances 
MD_dist <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELSLOG",
                     cweight= c(0.70, 0.20, 0.10)) 
 
# conducting hierarchical cluster analysis (ward-d2) 
MD_clus <- agnes(MD_dist, diss = T, method = "ward") 

# png("dendrogram_final.png", width=7000, height=4000, res = 800)
# plot(MD_clus)
# rect.hclust(MD_clus, k= 3)
# dev.off()
```


### Visualizing Clusters
```{r}
MD_cut4 <- cutree(MD_clus, k= 4)  
# MD_cut_fac4 <- factor(MD_cut4, labels = paste("Type", 1:4))  
MD_cut_fac4 <- factor(MD_cut4, levels = c(2, 4, 3 , 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"),
                                 ordered = TRUE)

##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_0.7.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()

#SEQUENCE INDEX PLOT
png("MDcluster_plot4_seqindex_0.7.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="I",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()
```

### Multinomial Regression Modeling w/ IDCD Clusters 
```{r}
#adding unordered version of cluster variables for multinomial regression
FF_MD_clus$cluster_MD4 <- MD_cut_fac4

FF_MD_clus <- FF_MD_clus %>% 
  mutate(cluster_MD4_m= factor(FF_MD_clus$cluster_MD4, ordered = F))

##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the very low adversity cluster [3 clusters]
FF_MD_clus$cluster_MD4_m <- relevel(FF_MD_clus$cluster_MD4_m,
                                      ref = "Consistently Very Low Adversity (0-1 Domains)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

## MODEL 1
# mother's race as sole predictor model
mod1_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD4)

z_mod1_MD4 <- summary(mod1_MD4)$coefficients/summary(mod1_MD4)$standard.errors
p_mod1_MD4 <- (1 - pnorm(abs(z_mod1_MD4), 0, 1)) * 2
p_mod1_MD4

## MODEL 2
# mother's race as predictor w/ education, income, and age of mother at focal child's
# birth as covariates
mod2_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth +
                                     hh_income_log + mo_edu_wave0 +
                                     mo_age_wave0,
                                   data = FF_MD_clus)

summary(mod2_MD4)

z_mod2_MD4 <- summary(mod2_MD4)$coefficients/summary(mod2_MD4)$standard.errors
p_mod2_MD4 <- (1 - pnorm(abs(z_mod2_MD4), 0, 1)) * 2
p_mod2_MD4
```

#### Multinomial Regression Table
```{r, results='asis', warning=FALSE}
stargazer(mod1_MD4, mod2_MD4,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          dep.var.labels = c("Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity",
                             "Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity"),
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Household Income (Logged)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "-10pt",
          notes.append = F,
          type = "html")
```


# SENSITIVITY CHECK: Full Sample Using PMM (m=5)
```{r}
set.seed(08540)
#making data frame of adversity values and imputation predictors
FF_adv_with_predictors <- FF_adversity_FULL[,c(1:60)] %>% 
  dplyr::select(-c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                   mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                   mo_hh_income_wave4))

FF_adv.comp_withpredictors5<- readRDS("FF_adv_imp_car_hou_socnet_4877_withpredictors5_RR#2.rds")

# #imputing missing data
# FF_adv_with_predictors5.imp <- mice(data = FF_adv_with_predictors, m= 20,
#                                    method = "pmm", print= FALSE,
#                                    remove.collinear = FALSE)
# 
# #examining imputed data
# head(complete(FF_adv_with_predictors5.imp))
# 
# ##creating an imputed data set
# FF_adv.comp_withpredictors5 <- complete(FF_adv_with_predictors5.imp, "long", include = F)
# 
# FF_adv_imp_car_hou_socnet_4877_withpredictors5 <- saveRDS(FF_adv.comp_withpredictors5,
#                                           file = "FF_adv_imp_car_hou_socnet_4877_withpredictors5_RR#2.rds")

```

## [CARCERAL SYSTEM] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under carceral system domain
carceral_domain <- FF_adv.comp_withpredictors5 %>% 
  dplyr::select(ends_with(c("fjail", "rjail","fprobs"))) %>% 
  mutate(imp=FF_adv.comp_withpredictors5$.imp) 

#wave 1
c_domain_w1 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

c_domain_w1_sums_FULL <- as.data.frame(rowSums(c_domain_w1[,c(2:4)]))

#wave 2
c_domain_w2 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

c_domain_w2_sums_FULL <- as.data.frame(rowSums(c_domain_w2[,c(2:4)]))

#wave 3
c_domain_w3 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

c_domain_w3_sums_FULL <- as.data.frame(rowSums(c_domain_w3[,c(2:4)]))

#wave 4
c_domain_w4 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

c_domain_w4_sums_FULL <- as.data.frame(rowSums(c_domain_w4[,c(2:4)]))

 
##creating a data set with the Summated scores  
c_dom_sums_FULL <- bind_cols(c_domain_w1_sums_FULL, c_domain_w2_sums_FULL, 
                             c_domain_w3_sums_FULL, c_domain_w4_sums_FULL) 

c_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 5)

colnames(c_dom_sums_FULL) <- c("wave1_cdom_sums_FULL", "wave2_cdom_sums_FULL",  
                               "wave3_cdom_sums_FULL", "wave4_cdom_sums_FULL", 
                               "index") 
 
c_dom_sums_FULL <- c_dom_sums_FULL %>%  
  relocate(index, .before= wave1_cdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors5$.imp) %>%  
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
cdom_wave1avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave1_cdom_sums_FULL)")

cdom_wave2avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave2_cdom_sums_FULL)")

cdom_wave3avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave3_cdom_sums_FULL)")

cdom_wave4avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave4_cdom_sums_FULL)")

 
cdom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, cdom_wave1avg, cdom_wave2avg,  
                               cdom_wave3avg, cdom_wave4avg) 
 
colnames(cdom_allwaves_avg_FULL) <- c("index", "cdom_avg1", "cdom_avg2",  
                                      "cdom_avg3", "cdom_avg4") 
 
#converting into binary states 
cdom_allwaves_avg_cat_FULL <- cdom_allwaves_avg_FULL %>%  
  mutate(cdomw1_cat= case_when(cdom_avg1 == 0  ~ "carceral_no", 
                              cdom_avg1 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw2_cat= case_when(cdom_avg2 == 0  ~ "carceral_no",  
                              cdom_avg2 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw3_cat= case_when(cdom_avg3 == 0  ~ "carceral_no", 
                              cdom_avg3 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw4_cat= case_when(cdom_avg4 == 0  ~ "carceral_no", 
                              cdom_avg4 > 0 ~ "carceral_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
#wave 1
rel_c_domain_w1<- c_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w1_fjail= mean(wave1_fjail),
            w1_fprobs= mean(wave1_fprobs),
            w1_feverjail= mean(wave1_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w1_fjail= ifelse(w1_fjail>0, 1, 0)) %>% 
  mutate(w1_fprobs= ifelse(w1_fprobs>0, 1, 0)) %>% 
  mutate(w1_feverjail= ifelse(w1_feverjail>0, 1, 0))

#wave 2
rel_c_domain_w2<- c_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w2_fjail= mean(wave2_fjail),
            w2_fprobs= mean(wave2_fprobs),
            w2_feverjail= mean(wave2_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w2_fjail= ifelse(w2_fjail>0, 1, 0)) %>% 
  mutate(w2_fprobs= ifelse(w2_fprobs>0, 1, 0)) %>% 
  mutate(w2_feverjail= ifelse(w2_feverjail>0, 1, 0))

#wave 3
rel_c_domain_w3<- c_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w3_fjail= mean(wave3_fjail),
            w3_fprobs= mean(wave3_fprobs),
            w3_feverjail= mean(wave3_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w3_fjail= ifelse(w3_fjail>0, 1, 0)) %>% 
  mutate(w3_fprobs= ifelse(w3_fprobs>0, 1, 0)) %>% 
  mutate(w3_feverjail= ifelse(w3_feverjail>0, 1, 0))

#wave 4
rel_c_domain_w4<- c_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w4_fjail= mean(wave4_fjail),
            w4_fprobs= mean(wave4_fprobs),
            w4_feverjail= mean(wave4_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w4_fjail= ifelse(w4_fjail>0, 1, 0)) %>% 
  mutate(w4_fprobs= ifelse(w4_fprobs>0, 1, 0)) %>% 
  mutate(w4_feverjail= ifelse(w4_feverjail>0, 1, 0))


alpha_carceral_w1 <- data.frame(raw_alpha= alpha(rel_c_domain_w1)$total$raw_alpha) 
alpha_carceral_w2 <- data.frame(raw_alpha= alpha(rel_c_domain_w2)$total$raw_alpha)
alpha_carceral_w3 <- data.frame(raw_alpha= alpha(rel_c_domain_w3)$total$raw_alpha)
alpha_carceral_w4 <- data.frame(raw_alpha= alpha(rel_c_domain_w4)$total$raw_alpha)

alpha_carceral <- rbind(alpha_carceral_w1,
                      alpha_carceral_w2,
                      alpha_carceral_w3,
                      alpha_carceral_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")
```



## [HOUSING] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under housing system domain
housing_domain <- FF_adv.comp_withpredictors5 %>% 
  dplyr::select(ends_with(c("evict", "nonreghouse", "moneymove",
                     "gaselec", "tele"))) %>%
  mutate(imp=FF_adv.comp_withpredictors5$.imp) 

#wave 1
ho_domain_w1 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

ho_domain_w1_sums_FULL <- as.data.frame(rowSums(ho_domain_w1[,c(2:6)]))

#wave 2
ho_domain_w2 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

ho_domain_w2_sums_FULL <- as.data.frame(rowSums(ho_domain_w2[,c(2:6)]))

#wave 3
ho_domain_w3 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

ho_domain_w3_sums_FULL <- as.data.frame(rowSums(ho_domain_w3[,c(2:6)]))

#wave 4
ho_domain_w4 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

ho_domain_w4_sums_FULL <- as.data.frame(rowSums(ho_domain_w4[,c(2:6)]))
 
##creating a data set with the Summatedd scores  
ho_dom_sums_FULL <- bind_cols(ho_domain_w1_sums_FULL, ho_domain_w2_sums_FULL, 
                             ho_domain_w3_sums_FULL, ho_domain_w4_sums_FULL)

ho_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 5) 
 
colnames(ho_dom_sums_FULL) <- c("wave1_hodom_sums_FULL", "wave2_hodom_sums_FULL",  
                               "wave3_hodom_sums_FULL", "wave4_hodom_sums_FULL", 
                               "index") 
 
ho_dom_sums_FULL <- ho_dom_sums_FULL %>%  
  relocate(index, .before= wave1_hodom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors5$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
hodom_wave1avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_hodom_sums_FULL)") 
 
hodom_wave2avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_hodom_sums_FULL)") 
 
hodom_wave3avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_hodom_sums_FULL)") 
 
hodom_wave4avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_hodom_sums_FULL)") 
 
hodom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, hodom_wave1avg, hodom_wave2avg,  
                               hodom_wave3avg, hodom_wave4avg) 
 
colnames(hodom_allwaves_avg_FULL) <- c("index", "hodom_avg1", "hodom_avg2",  
                                      "hodom_avg3", "hodom_avg4") 
 
#converting into binary states 
hodom_allwaves_avg_cat_FULL <- hodom_allwaves_avg_FULL %>%  
  mutate(hodomw1_cat= case_when(hodom_avg1 == 0  ~ "house_no", 
                              hodom_avg1 > 0 ~ "house_yes")) %>%  
  mutate(hodomw2_cat= case_when(hodom_avg2 == 0  ~ "house_no",  
                              hodom_avg2 > 0 ~ "house_yes")) %>%  
  mutate(hodomw3_cat= case_when(hodom_avg3 == 0  ~ "house_no", 
                              hodom_avg3 > 0 ~ "house_yes")) %>%  
  mutate(hodomw4_cat= case_when(hodom_avg4 == 0  ~ "house_no", 
                              hodom_avg4 > 0 ~ "house_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_hou_domain_w1<- ho_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave1_evict= mean(wave1_evict),
            wave1_nonreghouse= mean(wave1_nonreghouse),
            wave1_moneymove= mean(wave1_moneymove),
            wave1_gaselec= mean(wave1_gaselec),
            wave1_tele= mean(wave1_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_evict= ifelse(wave1_evict>0, 1, 0)) %>% 
  mutate(wave1_nonreghouse= ifelse(wave1_nonreghouse>0, 1, 0)) %>% 
  mutate(wave1_moneymove= ifelse(wave1_moneymove>0, 1, 0)) %>% 
  mutate(wave1_gaselec= ifelse(wave1_gaselec>0, 1, 0)) %>% 
  mutate(wave1_tele= ifelse(wave1_tele>0, 1, 0))

rel_hou_domain_w2<- ho_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave2_evict= mean(wave2_evict),
            wave2_nonreghouse= mean(wave2_nonreghouse),
            wave2_moneymove= mean(wave2_moneymove),
            wave2_gaselec= mean(wave2_gaselec),
            wave2_tele= mean(wave2_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_evict= ifelse(wave2_evict>0, 1, 0)) %>% 
  mutate(wave2_nonreghouse= ifelse(wave2_nonreghouse>0, 1, 0)) %>% 
  mutate(wave2_moneymove= ifelse(wave2_moneymove>0, 1, 0)) %>% 
  mutate(wave2_gaselec= ifelse(wave2_gaselec>0, 1, 0)) %>% 
  mutate(wave2_tele= ifelse(wave2_tele>0, 1, 0))


rel_hou_domain_w3<- ho_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave3_evict= mean(wave3_evict),
            wave3_nonreghouse= mean(wave3_nonreghouse),
            wave3_moneymove= mean(wave3_moneymove),
            wave3_gaselec= mean(wave3_gaselec),
            wave3_tele= mean(wave3_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_evict= ifelse(wave3_evict>0, 1, 0)) %>% 
  mutate(wave3_nonreghouse= ifelse(wave3_nonreghouse>0, 1, 0)) %>% 
  mutate(wave3_moneymove= ifelse(wave3_moneymove>0, 1, 0)) %>% 
  mutate(wave3_gaselec= ifelse(wave3_gaselec>0, 1, 0)) %>% 
  mutate(wave3_tele= ifelse(wave3_tele>0, 1, 0))

rel_hou_domain_w4<- ho_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave4_evict= mean(wave4_evict),
            wave4_nonreghouse= mean(wave4_nonreghouse),
            wave4_moneymove= mean(wave4_moneymove),
            wave4_gaselec= mean(wave4_gaselec),
            wave4_tele= mean(wave4_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_evict= ifelse(wave4_evict>0, 1, 0)) %>% 
  mutate(wave4_nonreghouse= ifelse(wave4_nonreghouse>0, 1, 0)) %>% 
  mutate(wave4_moneymove= ifelse(wave4_moneymove>0, 1, 0)) %>% 
  mutate(wave4_gaselec= ifelse(wave4_gaselec>0, 1, 0)) %>% 
  mutate(wave4_tele= ifelse(wave4_tele>0, 1, 0))


alpha_hou_w1 <- data.frame(raw_alpha= alpha(rel_hou_domain_w1)$total$raw_alpha) 
alpha_hou_w2 <- data.frame(raw_alpha= alpha(rel_hou_domain_w2)$total$raw_alpha)
alpha_hou_w3 <- data.frame(raw_alpha= alpha(rel_hou_domain_w3)$total$raw_alpha)
alpha_hou_w4 <- data.frame(raw_alpha= alpha(rel_hou_domain_w4)$total$raw_alpha)

alpha_hou <- rbind(alpha_hou_w1,
                      alpha_hou_w2,
                      alpha_hou_w3,
                      alpha_hou_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```


## [SOCIAL NETWORK] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under social network domain
socnet_domain <- FF_adv.comp_withpredictors5 %>% 
  dplyr::select(ends_with(c("emcare", "1kloan", "200loan",
                     "1kcosign"))) %>%
  mutate(imp=FF_adv.comp_withpredictors5$.imp) 

#wave 1
net_domain_w1 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

net_domain_w1_sums_FULL <- as.data.frame(rowSums(net_domain_w1[,c(2:5)]))

#wave 2
net_domain_w2 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

net_domain_w2_sums_FULL <- as.data.frame(rowSums(net_domain_w2[,c(2:5)]))

#wave 3
net_domain_w3 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

net_domain_w3_sums_FULL <- as.data.frame(rowSums(net_domain_w3[,c(2:5)]))

#wave 4
net_domain_w4 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

net_domain_w4_sums_FULL <- as.data.frame(rowSums(net_domain_w4[,c(2:5)]))

 
##creating a data set with the Summatedd scores  
net_dom_sums_FULL <- bind_cols(net_domain_w1_sums_FULL, net_domain_w2_sums_FULL, 
                             net_domain_w3_sums_FULL, net_domain_w4_sums_FULL) 
net_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 5) 
 
colnames(net_dom_sums_FULL) <- c("wave1_netdom_sums_FULL", "wave2_netdom_sums_FULL",  
                               "wave3_netdom_sums_FULL", "wave4_netdom_sums_FULL",  
                               "index") 
 
net_dom_sums_FULL <- net_dom_sums_FULL %>%  
  relocate(index, .before= wave1_netdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors5$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
netdom_wave1avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_netdom_sums_FULL)") 
 
netdom_wave2avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_netdom_sums_FULL)") 
 
netdom_wave3avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_netdom_sums_FULL)") 
 
netdom_wave4avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_netdom_sums_FULL)") 
 
netdom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, netdom_wave1avg, netdom_wave2avg,  
                               netdom_wave3avg, netdom_wave4avg) 
 
colnames(netdom_allwaves_avg_FULL) <- c("index", "netdom_avg1", "netdom_avg2",  
                                      "netdom_avg3", "netdom_avg4") 
 
#converting into binary states 
netdom_allwaves_avg_cat_FULL <- netdom_allwaves_avg_FULL %>%  
  mutate(netdomw1_cat= case_when(netdom_avg1 == 0  ~ "socnetwork_no", 
                              netdom_avg1 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw2_cat= case_when(netdom_avg2 == 0  ~ "socnetwork_no",  
                              netdom_avg2 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw3_cat= case_when(netdom_avg3 == 0  ~ "socnetwork_no", 
                              netdom_avg3 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw4_cat= case_when(netdom_avg4 == 0  ~ "socnetwork_no", 
                              netdom_avg4 > 0 ~ "socnetwork_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_net_domain_w1<- net_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave1_emcare= mean(wave1_emcare),
            wave1_1kloan= mean(wave1_1kloan),
            wave1_200loan= mean(wave1_200loan),
            wave1_1kcosign= mean(wave1_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_emcare= ifelse(wave1_emcare>0, 1, 0)) %>% 
  mutate(wave1_1kloan= ifelse(wave1_1kloan>0, 1, 0)) %>% 
  mutate(wave1_200loan= ifelse(wave1_200loan>0, 1, 0)) %>% 
  mutate(wave1_1kcosign= ifelse(wave1_1kcosign>0, 1, 0)) 


rel_net_domain_w2<- net_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave2_emcare= mean(wave2_emcare),
            wave2_1kloan= mean(wave2_1kloan),
            wave2_200loan= mean(wave2_200loan),
            wave2_1kcosign= mean(wave2_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_emcare= ifelse(wave2_emcare>0, 1, 0)) %>% 
  mutate(wave2_1kloan= ifelse(wave2_1kloan>0, 1, 0)) %>% 
  mutate(wave2_200loan= ifelse(wave2_200loan>0, 1, 0)) %>% 
  mutate(wave2_1kcosign= ifelse(wave2_1kcosign>0, 1, 0)) 


rel_net_domain_w3<- net_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave3_emcare= mean(wave3_emcare),
            wave3_1kloan= mean(wave3_1kloan),
            wave3_200loan= mean(wave3_200loan),
            wave3_1kcosign= mean(wave3_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_emcare= ifelse(wave3_emcare>0, 1, 0)) %>% 
  mutate(wave3_1kloan= ifelse(wave3_1kloan>0, 1, 0)) %>% 
  mutate(wave3_200loan= ifelse(wave3_200loan>0, 1, 0)) %>% 
  mutate(wave3_1kcosign= ifelse(wave3_1kcosign>0, 1, 0)) 

rel_net_domain_w4<- net_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave4_emcare= mean(wave4_emcare),
            wave4_1kloan= mean(wave4_1kloan),
            wave4_200loan= mean(wave4_200loan),
            wave4_1kcosign= mean(wave4_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_emcare= ifelse(wave4_emcare>0, 1, 0)) %>% 
  mutate(wave4_1kloan= ifelse(wave4_1kloan>0, 1, 0)) %>% 
  mutate(wave4_200loan= ifelse(wave4_200loan>0, 1, 0)) %>% 
  mutate(wave4_1kcosign= ifelse(wave4_1kcosign>0, 1, 0)) 

# alpha(rel_net_domain_w1)
# alpha(rel_net_domain_w2)
# alpha(rel_net_domain_w3)
# alpha(rel_net_domain_w4)

alpha_net_w1 <- data.frame(raw_alpha= alpha(rel_net_domain_w1)$total$raw_alpha) 
alpha_net_w2 <- data.frame(raw_alpha= alpha(rel_net_domain_w2)$total$raw_alpha)
alpha_net_w3 <- data.frame(raw_alpha= alpha(rel_net_domain_w3)$total$raw_alpha)
alpha_net_w4 <- data.frame(raw_alpha= alpha(rel_net_domain_w4)$total$raw_alpha)

alpha_socnet <- rbind(alpha_net_w1,
                      alpha_net_w2,
                      alpha_net_w3,
                      alpha_net_w4) %>% 
  mutate(Wave= c("Wave 1(Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```

## Table of Alphas for All Three Domains
```{r}
alpha_all_domains <- cbind(alpha_carceral, alpha_hou$raw_alpha, alpha_socnet$raw_alpha) 

colnames(alpha_all_domains) <- c("Wave" ,"Carceral", "Housing", "Social Network")

alpha_all_domains %>% 
  summarise_all(mean)

alpha_all_domains <- alpha_all_domains %>% 
  mutate_if(is.numeric, round, digits= 2)

alpha_all_domains

# png("MD_alphas_table.png", width = 550, height = 550)  
# #dev.off() 

# kable(alpha_all_domains) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "alpha_all_domain.html")

```


## Creating Sequences with Composite Scores
```{r}
## cleaning dataframes for defining  
carceral_traj <- cdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("cdomw")) 

housing_traj <- hodom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("hodomw")) 
 
socnet_traj <- netdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("netdomw")) 
 
##defining sequence objects for each domain 
 
#carceral system 
cdom_alphabet <- c("carceral_yes", "carceral_no") 
cdom_labs <- c("carceral_yes", "carceral_no") 
 
colnames(carceral_traj)[1] <- "Wave 1 (Y1)" 
colnames(carceral_traj)[2] <- "Wave 2 (Y3)" 
colnames(carceral_traj)[3] <- "Wave 3 (Y5)" 
colnames(carceral_traj)[4] <- "Wave 4 (Y9)" 

seqcar <- seqdef(carceral_traj, 
                 var = 1:4, 
                 alphabet = cdom_alphabet, 
                 labels=cdom_labs, 
                 xstep= 1 ) 

#housing system 
hodom_alphabet <- c("house_yes", "house_no") 
hodom_labs <- c("house_yes", "house_no") 
 
colnames(housing_traj)[1] <- "Wave 1 (Y1)" 
colnames(housing_traj)[2] <- "Wave 2 (Y3)" 
colnames(housing_traj)[3] <- "Wave 3 (Y5)" 
colnames(housing_traj)[4] <- "Wave 4 (Y9)" 

seqhou <- seqdef(housing_traj, 
                 var = 1:4, 
                 alphabet = hodom_alphabet, 
                 labels=hodom_labs, 
                 xstep= 1) 
 
#social network 
netdom_alphabet <- c("socnetwork_yes", "socnetwork_no") 
netdom_labs <- c("socnetwork_yes", "socnetwork_no") 
 
colnames(socnet_traj)[1] <- "Wave 1 (Y1)" 
colnames(socnet_traj)[2] <- "Wave 2 (Y3)" 
colnames(socnet_traj)[3] <- "Wave 3 (Y5)" 
colnames(socnet_traj)[4] <- "Wave 4 (Y9)" 

seqsocnet <- seqdef(socnet_traj, 
                 var = 1:4, 
                 alphabet = netdom_alphabet, 
                 labels=netdom_labs, 
                 xstep= 1) 

 
## Calculating Distance/Dissimilarity Matrix [OM] 
 
#carceral system 
carceral_distOM <- seqdist(seqcar, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#housing 
housing_distOM <- seqdist(seqhou, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#social network 
socnet_distOM <- seqdist(seqsocnet, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
```


## Measuring Strength of Association at Domain & State Levels
```{r}
##at state level (testing whether CAT could be used) 
state_assoc <- seqdomassoc(list(seqcar, seqhou, seqsocnet), 
            rep.method = "overall", 
            assoc = "V", 
            p.value = T, 
            struct.zero = F, 
            cross.table = T, 
            with.missing = F, 
            weighted = F, 
            dnames = c("Carceral", "Housing", "Soc Network")) 
state_assoc

state_assoc_df <- state_assoc[,c(2, 3)] %>% 
  as.data.frame() 

 
##at sequence level (testing whether DAT could be used) 
dom_assoc <- dissdomassoc(list(carceral_distOM, housing_distOM, socnet_distOM), 
             what = "pearson", 
             dnames = c("Carceral", "Housing", "Soc Network")) 
dom_assoc$p.pearson

state_dom_assoc_table <- state_assoc_df %>% 
  mutate(`Pearson's r`= c(dom_assoc$Pearson[1,2], dom_assoc$Pearson[1,3],
                          dom_assoc$Pearson[3,2])) %>% 
  mutate(`p(r)`= c(dom_assoc$p.pearson[1,2], dom_assoc$p.pearson[1,3],
                          dom_assoc$p.pearson[3,2])) %>% 
  mutate_all(round, digits=3)%>% 
  rownames_to_column("Domain Pairs") %>% 
  mutate(`Domain Pairs` = c("Carceral with Housing", "Carceral with Social Network",
                            "Housing with Social Network"))

state_dom_assoc_table

# kable(state_dom_assoc_table) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "state_dom_assoc_table.html")


```


## Creating/Plotting Multidomain Sequences
```{r}
#creating MD sequence df (to ensure proper alphabet)
MDseq <- list(seqcar, seqhou, seqsocnet) %>% 
  as.data.frame() 

colnames(MDseq) <- c("wave1_car", "wave2_car", "wave3_car", "wave4_car",
                     "wave1_hou", "wave2_hou", "wave3_hou", "wave4_hou",
                     "wave1_socnet", "wave2_socnet", "wave3_socnet", "wave4_socnet")
  
MDseq$wave1 <- paste(MDseq$wave1_car, "+", MDseq$wave1_hou, "+", MDseq$wave1_socnet)
MDseq$wave2 <- paste(MDseq$wave2_car, "+", MDseq$wave2_hou, "+", MDseq$wave2_socnet)
MDseq$wave3 <- paste(MDseq$wave3_car, "+", MDseq$wave3_hou, "+", MDseq$wave3_socnet)
MDseq$wave4 <- paste(MDseq$wave4_car, "+", MDseq$wave4_hou, "+", MDseq$wave4_socnet)

MDseq <- MDseq[, c(13:16)]

MDseq <- seqdef(MDseq,
       alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"),
       xtstep = 1)
 
#png("basic_MD_plot_R&R.png", width = 2000, height = 2000, res = 600)
seq_plot_MD <- seqplot(MDseq, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"), ylab = NA, border = NA, cex.legend = .5)
#dev.off()
```


## Cluster Analysis (IDCD Approach)

### Clustering MD sequences
```{r}
# Setting MD Costs/Distances 
MD_dist <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELSLOG") 
 
# conducting hierarchical cluster analysis (ward-d2) 
MD_clus <- agnes(MD_dist, diss = T, method = "ward") 

# storing clustering solution
# MD_clus_car_hou_socnet_4877 <- saveRDS(MD_clus, 
#                                           file = "MD_clus_car_hou_socnet_4877_RR#2.rds")

# png("dendrogram_final.png", width=7000, height=4000, res = 800)
# plot(MD_clus)
# rect.hclust(MD_clus, k= 3)
# #dev.off()
```


### Determining Number of Clusters: Cluster Quality Metrics
```{r}
clus_quality_table <- as.clustrange(MD_clus, diss = MD_dist, ncluster = 6) 

#generating evaluation plot
# png("MD_Eval_plots.png",width=8000, height=5000, res = 800, pointsize = 14)
clus_plot <- plot(clus_quality_table, stat = c("ASW", "HC", "CH", "PBC"), 
     norm= "zscore", legendpos= "topright", lwd=2) 
abline(v= 4,col= "red")
# dev.off()
```

### Determining Number of Clusters: Visualizing Different Numbers of Clusters
```{r}
## FOR SIX GROUPS ##  
MD_cut6 <- cutree(MD_clus, k= 6)  
MD_cut_fac6 <- factor(MD_cut6, levels = c(3, 2, 5, 6, 1, 4),
                     labels = paste("Type", 1:6))
 
 
#png("MDcluster_plot6.png", width=7000, height=5000, res = 900, pointsize = 9)  
seqplot(MDseq, group = MD_cut6, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1.2, 
        rows = 2, 
        cols = 3)  
#dev.off()  
 
## FOR FIVE GROUPS ##  
MD_cut5 <- cutree(MD_clus, k= 5)  
MD_cut_fac5 <- factor(MD_cut5, levels = c(3, 2, 5, 1, 4), 
                      labels = paste("Type", 1:5))

 
#png("MDcluster_plot5.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut5, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8,
        rows = 2,
        cols = 3)  
#dev.off()  
 
## FOR FOUR GROUPS ##  
MD_cut4 <- cutree(MD_clus, k= 4)  
# MD_cut_fac4 <- factor(MD_cut4, labels = paste("Type", 1:4))  
MD_cut_fac4 <- factor(MD_cut4, levels = c(3, 2, 4, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"),
                                 ordered = TRUE)
 
 
#png("MDcluster_plot4.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut4, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8, rows = 1, cols = 4)  
#dev.off()  

## FOR THREE GROUPS ##  
MD_cut3 <- cutree(MD_clus, k= 3)  
#MD_cut_fac3 <- factor(MD_cut3, labels = paste("Type", 1:3))
MD_cut_fac3 <- factor(MD_cut3, levels= c(3, 2, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Progressively Worsening Adversity (1-2 Domains)",
                                 "Consistently Moderate to High Adversity (2-3 Domains)"),
                      ordered = TRUE)


 
#png("MDcluster_plot3.png", width = 6500, height = 4000, res = 800)  
seqplot(MDseq, group = MD_cut3, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1,
        rows = 1,
        cols = 3)  
#dev.off()  
```

### Cluster Visualization (4 clusters)
```{r}
##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_m5.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1.1,
        rows = 2,
        cols = 2)
dev.off()

##REPRESENTATIVE PLOTS

#FREQUENCY

#png("MDcluster_plot4_freq.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="r",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        diss= MD_dist,
        criterion= "freq",
        coverage= .30,
        rows = 2,
        cols = 2)
#dev.off()

#NEIGHBORHOOD DENSITY

#png("MDcluster_plot4_neigh.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="r",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        diss= MD_dist,
        criterion= "density",
        pradius= 0.2,
        coverage= .30,
        rows = 2,
        cols = 2)
#dev.off()

#SEQUENCE INDEX PLOT
png("MDcluster_plot4_seqindex_m5.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="I",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1.1,
        rows = 2,
        cols = 2)
dev.off()
```

## MODELING W/ MD CLUSTERS

### Data Cleaning, Imputing, and Wrangling
```{r}
set.seed(08540)
##PREPPING DATA
#creating outcome variable with the cluster assignments for each observation/sequence
clusterdf_MD <- data.frame(cluster_MD4= MD_cut_fac4) 
  
#adding demographic variables to data frame
clusterdf_demo_MD_0 <- bind_cols(clusterdf_MD, FF_adversity_FULL[49:64])

#cleaning up new demo variables
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3 Missing"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9 Not in wave"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 Skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -1.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -2.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -5.00] <- NA

 
#re-coding some of the categorical variables 
clusterdf_demo_MD_0 <- clusterdf_demo_MD_0 %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c("1 less hs") ~ 1,
                     mo_edu_wave0 %in% c("2 hs or equiv") ~ 2,
                     mo_edu_wave0 %in% c("3 some coll, tech") ~ 3,
                     mo_edu_wave0 %in% c("4 coll or grad") ~ 4)) %>% 
  mutate(mo_edu_wave1 =
           case_when(mo_edu_wave1 %in% c("1") ~ 1,
                     mo_edu_wave1 %in% c("2") ~ 2,
                     mo_edu_wave1 %in% c("3") ~ 3,
                     mo_edu_wave1 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave2 =
           case_when(mo_edu_wave2 %in% c("1") ~ 1,
                     mo_edu_wave2 %in% c("2") ~ 2,
                     mo_edu_wave2 %in% c("3") ~ 3,
                     mo_edu_wave2 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave3 =
           case_when(mo_edu_wave3 %in% c("1") ~ 1,
                     mo_edu_wave3 %in% c("2") ~ 2,
                     mo_edu_wave3 %in% c("3") ~ 3,
                     mo_edu_wave3 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave4 =
           case_when(mo_edu_wave4 %in% c("1") ~ 1,
                     mo_edu_wave4 %in% c("2") ~ 2,
                     mo_edu_wave4 %in% c("3") ~ 3,
                     mo_edu_wave4 %in% c("4") ~ 4)) 

clusterdf_demo_MD <- clusterdf_demo_MD_0

##IMPUTING SELECT MISSING DEMO DATA (only those that will be used in modeling)
#selecting variables to impute 
clusdf_select_MD <- bind_cols(clusterdf_demo_MD[4:7], clusterdf_demo_MD[9:12])

#imputing missing data for select demo/control variables
clusdf_select_MD_imp <- mice(data=clusdf_select_MD, m= 10, method = "pmm", 
                             print= F)

#examining imputed data
#head(complete(clusdf_select_MD_imp))

#creating an imputed data set
clusdf_select_MD_imp_comp <- complete(clusdf_select_MD_imp, "long", include = F)

#adding index for later grouping and generating avgs across imputed data sets
clusdf_select_MD_imp_comp$index <- rep(clusterdf_demo_MD$index, times= 10)

clusdf_select_MD_imp_comp <- clusdf_select_MD_imp_comp %>% 
  relocate(index, .before= .id)

#generating average value of imputed variables across the imputed data sets
demoMD_imp_avgs <- clusdf_select_MD_imp_comp %>% 
  group_by(index) %>% 
  summarise(round(mean(mo_edu_wave1)),
            round(mean(mo_edu_wave2)),
            round(mean(mo_edu_wave3)),
            round(mean(mo_edu_wave4)),
            round(mean(mo_hh_income_wave1)),
            round(mean(mo_hh_income_wave2)),
            round(mean(mo_hh_income_wave3)),
            round(mean(mo_hh_income_wave4)))
            
colnames(demoMD_imp_avgs) <- c("index","mo_edu_wave1", "mo_edu_wave2","mo_edu_wave3", 
                               "mo_edu_wave4", "mo_hh_income_wave1", "mo_hh_income_wave2",
                               "mo_hh_income_wave3", "mo_hh_income_wave4")

#creating new complete data set with imputed demographic/control variables
FF_MD_clus0 <- clusterdf_demo_MD %>% 
  subset(select = -c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                     mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                     mo_hh_income_wave4)) %>% 
  left_join(demoMD_imp_avgs, by= "index") 
  

#transforming education variable back to categorical and adding substantive labels 
FF_MD_clus <- FF_MD_clus0 %>% 
  mutate(mo_edu_wave0= case_when(mo_edu_wave0 %in% c(1) ~ "less hs",
                                 mo_edu_wave0 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave0 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave0 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave1= case_when(mo_edu_wave1 %in% c(1) ~ "less hs",
                                 mo_edu_wave1 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave1 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave1 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave2= case_when(mo_edu_wave2 %in% c(1) ~ "less hs",
                                 mo_edu_wave2 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave2 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave2 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave3= case_when(mo_edu_wave3 %in% c(1) ~ "less hs",
                                 mo_edu_wave3 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave3 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave3 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave4= case_when(mo_edu_wave4 %in% c(1) ~ "less hs",
                                 mo_edu_wave4 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave4 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave4 %in% c(4) ~ "coll or grad")) 

#logging hh income variable for modeling (adding one to address zeros)
FF_MD_clus <- FF_MD_clus %>% 
  mutate(hh_income_log= log(FF_MD_clus$mo_hh_income_wave0 +1)) 

#recoding education at baseline as ordinal factor for modeling
FF_MD_clus$mo_edu_wave0 <- factor(FF_MD_clus$mo_edu_wave0,
                                     levels=c("less hs",
                                              "hs or equiv",
                                              "some coll, tech",
                                              "coll or grad"))

#adding unordered version of cluster variables for multinomial regression & turning
#mother's race/ethnicity into unordered factor variable to set reference level
FF_MD_clus <- FF_MD_clus %>% 
  mutate(cluster_MD4_m= factor(FF_MD_clus$cluster_MD4, ordered = F)) %>%
  mutate(mo_race_eth= factor(FF_MD_clus$mo_race_eth, ordered = F))
```

### Generating Descriptive Table of Analytic Sample
```{r}
clusterdf_demo_MD_descrip <- clusterdf_demo_MD %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c(1) ~ "Less Than High School",
                     mo_edu_wave0 %in% c(2) ~ "High School or Equivalent",
                     mo_edu_wave0 %in% c(3) ~ "Some College/Technical School",
                     mo_edu_wave0 %in% c(4) ~ "College or Graduate School")) %>% 
  mutate(mo_race_eth =
           case_when(mo_race_eth %in% c("1 white, non-hispanic") ~ "White, Non-Hispanic",
                     mo_race_eth %in% c("2 black, non-hispanic") ~ "Black, Non-Hispanic",
                     mo_race_eth %in% c("3 hispanic") ~ "Hispanic",
                     mo_race_eth %in% c("4 other") ~ "Other Race/Ethnicity"))

descripMD <-  clusterdf_demo_MD_descrip %>% 
  dplyr::select(mo_race_eth, mo_edu_wave0, mo_hh_income_wave0, 
         mo_age_wave0, mo_married_wave0, mo_cohab_wave0)

descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "0"] <- "Not married"
descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "1"] <- "Married"

descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "0"] <- "Not Cohabitating"
descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "1"] <- "Cohabitating"

label(descripMD$mo_hh_income_wave0) <- "Mother's Annual Household Income at Baseline"
label(descripMD$mo_race_eth) <- "Race/Ethnicity"
label(descripMD$mo_edu_wave0) <- "Education at Baseline"
label(descripMD$mo_married_wave0) <- "Mother Married to Bio Dad at Baseline"
label(descripMD$mo_cohab_wave0) <- "Mother Cohabitating w/ Bio Dad at Baseline"
label(descripMD$mo_age_wave0) <- "Age at Birth of Focal Child"

descripMD_table <- table1(~mo_race_eth + 
                          mo_edu_wave0 + mo_age_wave0 + mo_hh_income_wave0 +
                          mo_married_wave0 + mo_cohab_wave0, 
                        data = descripMD)
descripMD_table
# png("Sample_Table.png", width = 550, height = 550)
# tableGrob(descripMD_table)
# dev.off()

# #png("Sample_Table.png", width = 550, height = 550)
# apa_table(descripMD_table)
# #dev.off()

```

### Modeling w/ IDCD Clusters (MULTINOMINAL)
```{r}
##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the very low adversity cluster [3 clusters]
FF_MD_clus$cluster_MD4_m <- relevel(FF_MD_clus$cluster_MD4_m,
                                      ref = "Consistently Very Low Adversity (0-1 Domains)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

## MODEL 1
# mother's race as sole predictor model
mod1_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD4)

z_mod1_MD4 <- summary(mod1_MD4)$coefficients/summary(mod1_MD4)$standard.errors
p_mod1_MD4 <- (1 - pnorm(abs(z_mod1_MD4), 0, 1)) * 2
p_mod1_MD4

## MODEL 2
# mother's race as predictor w/ education, income, and age of mother at focal child's
# birth as covariates
mod2_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth +
                                     hh_income_log + mo_edu_wave0 +
                                     mo_age_wave0,
                                   data = FF_MD_clus)

summary(mod2_MD4)

z_mod2_MD4 <- summary(mod2_MD4)$coefficients/summary(mod2_MD4)$standard.errors
p_mod2_MD4 <- (1 - pnorm(abs(z_mod2_MD4), 0, 1)) * 2
p_mod2_MD4
```

#### Multinomial Regression Table
```{r, results='asis', warning=FALSE}
stargazer(mod1_MD4, mod2_MD4,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          dep.var.labels = c("Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity",
                             "Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity"),
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Household Income (Logged)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "-10pt",
          notes.append = F,
          type = "html")
```


# SENSITIVITY CHECK: Full Sample With Covariates Using PMM (m=20)
```{r}
set.seed(08540)
#making data frame of adversity values and imputation predictors
FF_adv_with_predictors <- FF_adversity_FULL[,c(1:60)] %>% 
  dplyr::select(-c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                   mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                   mo_hh_income_wave4))

FF_adv.comp_withpredictors20<- readRDS("FF_adv_imp_car_hou_socnet_4877_withpredictors20_RR#2.rds")

# #imputing missing data
# FF_adv_with_predictors20.imp <- mice(data = FF_adv_with_predictors, m= 20,
#                                    method = "pmm", print= FALSE,
#                                    remove.collinear = FALSE)
# 
# #examining imputed data
# head(complete(FF_adv_with_predictors20.imp))
# 
# ##creating an imputed data set
# FF_adv.comp_withpredictors20 <- complete(FF_adv_with_predictors20.imp, "long", include = F)
# 
# FF_adv_imp_car_hou_socnet_4877_withpredictors20 <- saveRDS(FF_adv.comp_withpredictors20,
#                                           file = "FF_adv_imp_car_hou_socnet_4877_withpredictors20_RR#2.rds")

```

## [CARCERAL SYSTEM] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under carceral system domain
carceral_domain <- FF_adv.comp_withpredictors20 %>% 
  dplyr::select(ends_with(c("fjail", "rjail","fprobs"))) %>% 
  mutate(imp=FF_adv.comp_withpredictors20$.imp) 

#wave 1
c_domain_w1 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

c_domain_w1_sums_FULL <- as.data.frame(rowSums(c_domain_w1[,c(2:4)]))

#wave 2
c_domain_w2 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

c_domain_w2_sums_FULL <- as.data.frame(rowSums(c_domain_w2[,c(2:4)]))

#wave 3
c_domain_w3 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

c_domain_w3_sums_FULL <- as.data.frame(rowSums(c_domain_w3[,c(2:4)]))

#wave 4
c_domain_w4 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

c_domain_w4_sums_FULL <- as.data.frame(rowSums(c_domain_w4[,c(2:4)]))

 
##creating a data set with the Summated scores  
c_dom_sums_FULL <- bind_cols(c_domain_w1_sums_FULL, c_domain_w2_sums_FULL, 
                             c_domain_w3_sums_FULL, c_domain_w4_sums_FULL) 

c_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 20)

colnames(c_dom_sums_FULL) <- c("wave1_cdom_sums_FULL", "wave2_cdom_sums_FULL",  
                               "wave3_cdom_sums_FULL", "wave4_cdom_sums_FULL", 
                               "index") 
 
c_dom_sums_FULL <- c_dom_sums_FULL %>%  
  relocate(index, .before= wave1_cdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors20$.imp) %>%  
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
cdom_wave1avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave1_cdom_sums_FULL)")

cdom_wave2avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave2_cdom_sums_FULL)")

cdom_wave3avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave3_cdom_sums_FULL)")

cdom_wave4avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave4_cdom_sums_FULL)")

 
cdom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, cdom_wave1avg, cdom_wave2avg,  
                               cdom_wave3avg, cdom_wave4avg) 
 
colnames(cdom_allwaves_avg_FULL) <- c("index", "cdom_avg1", "cdom_avg2",  
                                      "cdom_avg3", "cdom_avg4") 
 
#converting into binary states 
cdom_allwaves_avg_cat_FULL <- cdom_allwaves_avg_FULL %>%  
  mutate(cdomw1_cat= case_when(cdom_avg1 == 0  ~ "carceral_no", 
                              cdom_avg1 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw2_cat= case_when(cdom_avg2 == 0  ~ "carceral_no",  
                              cdom_avg2 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw3_cat= case_when(cdom_avg3 == 0  ~ "carceral_no", 
                              cdom_avg3 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw4_cat= case_when(cdom_avg4 == 0  ~ "carceral_no", 
                              cdom_avg4 > 0 ~ "carceral_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
#wave 1
rel_c_domain_w1<- c_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w1_fjail= mean(wave1_fjail),
            w1_fprobs= mean(wave1_fprobs),
            w1_feverjail= mean(wave1_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w1_fjail= ifelse(w1_fjail>0, 1, 0)) %>% 
  mutate(w1_fprobs= ifelse(w1_fprobs>0, 1, 0)) %>% 
  mutate(w1_feverjail= ifelse(w1_feverjail>0, 1, 0))

#wave 2
rel_c_domain_w2<- c_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w2_fjail= mean(wave2_fjail),
            w2_fprobs= mean(wave2_fprobs),
            w2_feverjail= mean(wave2_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w2_fjail= ifelse(w2_fjail>0, 1, 0)) %>% 
  mutate(w2_fprobs= ifelse(w2_fprobs>0, 1, 0)) %>% 
  mutate(w2_feverjail= ifelse(w2_feverjail>0, 1, 0))

#wave 3
rel_c_domain_w3<- c_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w3_fjail= mean(wave3_fjail),
            w3_fprobs= mean(wave3_fprobs),
            w3_feverjail= mean(wave3_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w3_fjail= ifelse(w3_fjail>0, 1, 0)) %>% 
  mutate(w3_fprobs= ifelse(w3_fprobs>0, 1, 0)) %>% 
  mutate(w3_feverjail= ifelse(w3_feverjail>0, 1, 0))

#wave 4
rel_c_domain_w4<- c_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(w4_fjail= mean(wave4_fjail),
            w4_fprobs= mean(wave4_fprobs),
            w4_feverjail= mean(wave4_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w4_fjail= ifelse(w4_fjail>0, 1, 0)) %>% 
  mutate(w4_fprobs= ifelse(w4_fprobs>0, 1, 0)) %>% 
  mutate(w4_feverjail= ifelse(w4_feverjail>0, 1, 0))


alpha_carceral_w1 <- data.frame(raw_alpha= alpha(rel_c_domain_w1)$total$raw_alpha) 
alpha_carceral_w2 <- data.frame(raw_alpha= alpha(rel_c_domain_w2)$total$raw_alpha)
alpha_carceral_w3 <- data.frame(raw_alpha= alpha(rel_c_domain_w3)$total$raw_alpha)
alpha_carceral_w4 <- data.frame(raw_alpha= alpha(rel_c_domain_w4)$total$raw_alpha)

alpha_carceral <- rbind(alpha_carceral_w1,
                      alpha_carceral_w2,
                      alpha_carceral_w3,
                      alpha_carceral_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")
```



## [HOUSING] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under housing system domain
housing_domain <- FF_adv.comp_withpredictors20 %>% 
  dplyr::select(ends_with(c("evict", "nonreghouse", "moneymove",
                     "gaselec", "tele"))) %>%
  mutate(imp=FF_adv.comp_withpredictors20$.imp) 

#wave 1
ho_domain_w1 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

ho_domain_w1_sums_FULL <- as.data.frame(rowSums(ho_domain_w1[,c(2:6)]))

#wave 2
ho_domain_w2 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

ho_domain_w2_sums_FULL <- as.data.frame(rowSums(ho_domain_w2[,c(2:6)]))

#wave 3
ho_domain_w3 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

ho_domain_w3_sums_FULL <- as.data.frame(rowSums(ho_domain_w3[,c(2:6)]))

#wave 4
ho_domain_w4 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

ho_domain_w4_sums_FULL <- as.data.frame(rowSums(ho_domain_w4[,c(2:6)]))
 
##creating a data set with the Summatedd scores  
ho_dom_sums_FULL <- bind_cols(ho_domain_w1_sums_FULL, ho_domain_w2_sums_FULL, 
                             ho_domain_w3_sums_FULL, ho_domain_w4_sums_FULL)

ho_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 20) 
 
colnames(ho_dom_sums_FULL) <- c("wave1_hodom_sums_FULL", "wave2_hodom_sums_FULL",  
                               "wave3_hodom_sums_FULL", "wave4_hodom_sums_FULL", 
                               "index") 
 
ho_dom_sums_FULL <- ho_dom_sums_FULL %>%  
  relocate(index, .before= wave1_hodom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors20$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
hodom_wave1avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_hodom_sums_FULL)") 
 
hodom_wave2avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_hodom_sums_FULL)") 
 
hodom_wave3avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_hodom_sums_FULL)") 
 
hodom_wave4avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_hodom_sums_FULL)") 
 
hodom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, hodom_wave1avg, hodom_wave2avg,  
                               hodom_wave3avg, hodom_wave4avg) 
 
colnames(hodom_allwaves_avg_FULL) <- c("index", "hodom_avg1", "hodom_avg2",  
                                      "hodom_avg3", "hodom_avg4") 
 
#converting into binary states 
hodom_allwaves_avg_cat_FULL <- hodom_allwaves_avg_FULL %>%  
  mutate(hodomw1_cat= case_when(hodom_avg1 == 0  ~ "house_no", 
                              hodom_avg1 > 0 ~ "house_yes")) %>%  
  mutate(hodomw2_cat= case_when(hodom_avg2 == 0  ~ "house_no",  
                              hodom_avg2 > 0 ~ "house_yes")) %>%  
  mutate(hodomw3_cat= case_when(hodom_avg3 == 0  ~ "house_no", 
                              hodom_avg3 > 0 ~ "house_yes")) %>%  
  mutate(hodomw4_cat= case_when(hodom_avg4 == 0  ~ "house_no", 
                              hodom_avg4 > 0 ~ "house_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_hou_domain_w1<- ho_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave1_evict= mean(wave1_evict),
            wave1_nonreghouse= mean(wave1_nonreghouse),
            wave1_moneymove= mean(wave1_moneymove),
            wave1_gaselec= mean(wave1_gaselec),
            wave1_tele= mean(wave1_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_evict= ifelse(wave1_evict>0, 1, 0)) %>% 
  mutate(wave1_nonreghouse= ifelse(wave1_nonreghouse>0, 1, 0)) %>% 
  mutate(wave1_moneymove= ifelse(wave1_moneymove>0, 1, 0)) %>% 
  mutate(wave1_gaselec= ifelse(wave1_gaselec>0, 1, 0)) %>% 
  mutate(wave1_tele= ifelse(wave1_tele>0, 1, 0))

rel_hou_domain_w2<- ho_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave2_evict= mean(wave2_evict),
            wave2_nonreghouse= mean(wave2_nonreghouse),
            wave2_moneymove= mean(wave2_moneymove),
            wave2_gaselec= mean(wave2_gaselec),
            wave2_tele= mean(wave2_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_evict= ifelse(wave2_evict>0, 1, 0)) %>% 
  mutate(wave2_nonreghouse= ifelse(wave2_nonreghouse>0, 1, 0)) %>% 
  mutate(wave2_moneymove= ifelse(wave2_moneymove>0, 1, 0)) %>% 
  mutate(wave2_gaselec= ifelse(wave2_gaselec>0, 1, 0)) %>% 
  mutate(wave2_tele= ifelse(wave2_tele>0, 1, 0))


rel_hou_domain_w3<- ho_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave3_evict= mean(wave3_evict),
            wave3_nonreghouse= mean(wave3_nonreghouse),
            wave3_moneymove= mean(wave3_moneymove),
            wave3_gaselec= mean(wave3_gaselec),
            wave3_tele= mean(wave3_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_evict= ifelse(wave3_evict>0, 1, 0)) %>% 
  mutate(wave3_nonreghouse= ifelse(wave3_nonreghouse>0, 1, 0)) %>% 
  mutate(wave3_moneymove= ifelse(wave3_moneymove>0, 1, 0)) %>% 
  mutate(wave3_gaselec= ifelse(wave3_gaselec>0, 1, 0)) %>% 
  mutate(wave3_tele= ifelse(wave3_tele>0, 1, 0))

rel_hou_domain_w4<- ho_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave4_evict= mean(wave4_evict),
            wave4_nonreghouse= mean(wave4_nonreghouse),
            wave4_moneymove= mean(wave4_moneymove),
            wave4_gaselec= mean(wave4_gaselec),
            wave4_tele= mean(wave4_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_evict= ifelse(wave4_evict>0, 1, 0)) %>% 
  mutate(wave4_nonreghouse= ifelse(wave4_nonreghouse>0, 1, 0)) %>% 
  mutate(wave4_moneymove= ifelse(wave4_moneymove>0, 1, 0)) %>% 
  mutate(wave4_gaselec= ifelse(wave4_gaselec>0, 1, 0)) %>% 
  mutate(wave4_tele= ifelse(wave4_tele>0, 1, 0))


alpha_hou_w1 <- data.frame(raw_alpha= alpha(rel_hou_domain_w1)$total$raw_alpha) 
alpha_hou_w2 <- data.frame(raw_alpha= alpha(rel_hou_domain_w2)$total$raw_alpha)
alpha_hou_w3 <- data.frame(raw_alpha= alpha(rel_hou_domain_w3)$total$raw_alpha)
alpha_hou_w4 <- data.frame(raw_alpha= alpha(rel_hou_domain_w4)$total$raw_alpha)

alpha_hou <- rbind(alpha_hou_w1,
                      alpha_hou_w2,
                      alpha_hou_w3,
                      alpha_hou_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```


## [SOCIAL NETWORK] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under social network domain
socnet_domain <- FF_adv.comp_withpredictors20 %>% 
  dplyr::select(ends_with(c("emcare", "1kloan", "200loan",
                     "1kcosign"))) %>%
  mutate(imp=FF_adv.comp_withpredictors20$.imp) 

#wave 1
net_domain_w1 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

net_domain_w1_sums_FULL <- as.data.frame(rowSums(net_domain_w1[,c(2:5)]))

#wave 2
net_domain_w2 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

net_domain_w2_sums_FULL <- as.data.frame(rowSums(net_domain_w2[,c(2:5)]))

#wave 3
net_domain_w3 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

net_domain_w3_sums_FULL <- as.data.frame(rowSums(net_domain_w3[,c(2:5)]))

#wave 4
net_domain_w4 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

net_domain_w4_sums_FULL <- as.data.frame(rowSums(net_domain_w4[,c(2:5)]))

 
##creating a data set with the Summatedd scores  
net_dom_sums_FULL <- bind_cols(net_domain_w1_sums_FULL, net_domain_w2_sums_FULL, 
                             net_domain_w3_sums_FULL, net_domain_w4_sums_FULL) 
net_dom_sums_FULL$index <- rep(FF_adversity_FULL$index, rep= 20) 
 
colnames(net_dom_sums_FULL) <- c("wave1_netdom_sums_FULL", "wave2_netdom_sums_FULL",  
                               "wave3_netdom_sums_FULL", "wave4_netdom_sums_FULL",  
                               "index") 
 
net_dom_sums_FULL <- net_dom_sums_FULL %>%  
  relocate(index, .before= wave1_netdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_withpredictors20$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
netdom_wave1avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_netdom_sums_FULL)") 
 
netdom_wave2avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_netdom_sums_FULL)") 
 
netdom_wave3avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_netdom_sums_FULL)") 
 
netdom_wave4avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_netdom_sums_FULL)") 
 
netdom_allwaves_avg_FULL <- bind_cols(FF_adversity_FULL$index, netdom_wave1avg, netdom_wave2avg,  
                               netdom_wave3avg, netdom_wave4avg) 
 
colnames(netdom_allwaves_avg_FULL) <- c("index", "netdom_avg1", "netdom_avg2",  
                                      "netdom_avg3", "netdom_avg4") 
 
#converting into binary states 
netdom_allwaves_avg_cat_FULL <- netdom_allwaves_avg_FULL %>%  
  mutate(netdomw1_cat= case_when(netdom_avg1 == 0  ~ "socnetwork_no", 
                              netdom_avg1 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw2_cat= case_when(netdom_avg2 == 0  ~ "socnetwork_no",  
                              netdom_avg2 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw3_cat= case_when(netdom_avg3 == 0  ~ "socnetwork_no", 
                              netdom_avg3 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw4_cat= case_when(netdom_avg4 == 0  ~ "socnetwork_no", 
                              netdom_avg4 > 0 ~ "socnetwork_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_net_domain_w1<- net_domain_w1 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave1_emcare= mean(wave1_emcare),
            wave1_1kloan= mean(wave1_1kloan),
            wave1_200loan= mean(wave1_200loan),
            wave1_1kcosign= mean(wave1_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_emcare= ifelse(wave1_emcare>0, 1, 0)) %>% 
  mutate(wave1_1kloan= ifelse(wave1_1kloan>0, 1, 0)) %>% 
  mutate(wave1_200loan= ifelse(wave1_200loan>0, 1, 0)) %>% 
  mutate(wave1_1kcosign= ifelse(wave1_1kcosign>0, 1, 0)) 


rel_net_domain_w2<- net_domain_w2 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave2_emcare= mean(wave2_emcare),
            wave2_1kloan= mean(wave2_1kloan),
            wave2_200loan= mean(wave2_200loan),
            wave2_1kcosign= mean(wave2_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_emcare= ifelse(wave2_emcare>0, 1, 0)) %>% 
  mutate(wave2_1kloan= ifelse(wave2_1kloan>0, 1, 0)) %>% 
  mutate(wave2_200loan= ifelse(wave2_200loan>0, 1, 0)) %>% 
  mutate(wave2_1kcosign= ifelse(wave2_1kcosign>0, 1, 0)) 


rel_net_domain_w3<- net_domain_w3 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave3_emcare= mean(wave3_emcare),
            wave3_1kloan= mean(wave3_1kloan),
            wave3_200loan= mean(wave3_200loan),
            wave3_1kcosign= mean(wave3_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_emcare= ifelse(wave3_emcare>0, 1, 0)) %>% 
  mutate(wave3_1kloan= ifelse(wave3_1kloan>0, 1, 0)) %>% 
  mutate(wave3_200loan= ifelse(wave3_200loan>0, 1, 0)) %>% 
  mutate(wave3_1kcosign= ifelse(wave3_1kcosign>0, 1, 0)) 

rel_net_domain_w4<- net_domain_w4 %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  group_by(index) %>%  
  summarise(wave4_emcare= mean(wave4_emcare),
            wave4_1kloan= mean(wave4_1kloan),
            wave4_200loan= mean(wave4_200loan),
            wave4_1kcosign= mean(wave4_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_emcare= ifelse(wave4_emcare>0, 1, 0)) %>% 
  mutate(wave4_1kloan= ifelse(wave4_1kloan>0, 1, 0)) %>% 
  mutate(wave4_200loan= ifelse(wave4_200loan>0, 1, 0)) %>% 
  mutate(wave4_1kcosign= ifelse(wave4_1kcosign>0, 1, 0)) 

# alpha(rel_net_domain_w1)
# alpha(rel_net_domain_w2)
# alpha(rel_net_domain_w3)
# alpha(rel_net_domain_w4)

alpha_net_w1 <- data.frame(raw_alpha= alpha(rel_net_domain_w1)$total$raw_alpha) 
alpha_net_w2 <- data.frame(raw_alpha= alpha(rel_net_domain_w2)$total$raw_alpha)
alpha_net_w3 <- data.frame(raw_alpha= alpha(rel_net_domain_w3)$total$raw_alpha)
alpha_net_w4 <- data.frame(raw_alpha= alpha(rel_net_domain_w4)$total$raw_alpha)

alpha_socnet <- rbind(alpha_net_w1,
                      alpha_net_w2,
                      alpha_net_w3,
                      alpha_net_w4) %>% 
  mutate(Wave= c("Wave 1(Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```

## Table of Alphas for All Three Domains
```{r}
alpha_all_domains <- cbind(alpha_carceral, alpha_hou$raw_alpha, alpha_socnet$raw_alpha) 

colnames(alpha_all_domains) <- c("Wave" ,"Carceral", "Housing", "Social Network")

alpha_all_domains %>% 
  summarise_all(mean)

alpha_all_domains <- alpha_all_domains %>% 
  mutate_if(is.numeric, round, digits= 2)

alpha_all_domains

# png("MD_alphas_table.png", width = 550, height = 550)  
# #dev.off() 

# kable(alpha_all_domains) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "alpha_all_domain.html")

```


## Creating Sequences with Composite Scores
```{r}
## cleaning dataframes for defining  
carceral_traj <- cdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("cdomw")) 

housing_traj <- hodom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("hodomw")) 
 
socnet_traj <- netdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("netdomw")) 
 
##defining sequence objects for each domain 
 
#carceral system 
cdom_alphabet <- c("carceral_yes", "carceral_no") 
cdom_labs <- c("carceral_yes", "carceral_no") 
 
colnames(carceral_traj)[1] <- "Wave 1 (Y1)" 
colnames(carceral_traj)[2] <- "Wave 2 (Y3)" 
colnames(carceral_traj)[3] <- "Wave 3 (Y5)" 
colnames(carceral_traj)[4] <- "Wave 4 (Y9)" 

seqcar <- seqdef(carceral_traj, 
                 var = 1:4, 
                 alphabet = cdom_alphabet, 
                 labels=cdom_labs, 
                 xstep= 1 ) 

#housing system 
hodom_alphabet <- c("house_yes", "house_no") 
hodom_labs <- c("house_yes", "house_no") 
 
colnames(housing_traj)[1] <- "Wave 1 (Y1)" 
colnames(housing_traj)[2] <- "Wave 2 (Y3)" 
colnames(housing_traj)[3] <- "Wave 3 (Y5)" 
colnames(housing_traj)[4] <- "Wave 4 (Y9)" 

seqhou <- seqdef(housing_traj, 
                 var = 1:4, 
                 alphabet = hodom_alphabet, 
                 labels=hodom_labs, 
                 xstep= 1) 
 
#social network 
netdom_alphabet <- c("socnetwork_yes", "socnetwork_no") 
netdom_labs <- c("socnetwork_yes", "socnetwork_no") 
 
colnames(socnet_traj)[1] <- "Wave 1 (Y1)" 
colnames(socnet_traj)[2] <- "Wave 2 (Y3)" 
colnames(socnet_traj)[3] <- "Wave 3 (Y5)" 
colnames(socnet_traj)[4] <- "Wave 4 (Y9)" 

seqsocnet <- seqdef(socnet_traj, 
                 var = 1:4, 
                 alphabet = netdom_alphabet, 
                 labels=netdom_labs, 
                 xstep= 1) 

 
## Calculating Distance/Dissimilarity Matrix [OM] 
 
#carceral system 
carceral_distOM <- seqdist(seqcar, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#housing 
housing_distOM <- seqdist(seqhou, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#social network 
socnet_distOM <- seqdist(seqsocnet, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
```


## Measuring Strength of Association at Domain & State Levels
```{r}
##at state level (testing whether CAT could be used) 
state_assoc <- seqdomassoc(list(seqcar, seqhou, seqsocnet), 
            rep.method = "overall", 
            assoc = "V", 
            p.value = T, 
            struct.zero = F, 
            cross.table = T, 
            with.missing = F, 
            weighted = F, 
            dnames = c("Carceral", "Housing", "Soc Network")) 
state_assoc

state_assoc_df <- state_assoc[,c(2, 3)] %>% 
  as.data.frame() 

 
##at sequence level (testing whether DAT could be used) 
dom_assoc <- dissdomassoc(list(carceral_distOM, housing_distOM, socnet_distOM), 
             what = "pearson", 
             dnames = c("Carceral", "Housing", "Soc Network")) 
dom_assoc$p.pearson

state_dom_assoc_table <- state_assoc_df %>% 
  mutate(`Pearson's r`= c(dom_assoc$Pearson[1,2], dom_assoc$Pearson[1,3],
                          dom_assoc$Pearson[3,2])) %>% 
  mutate(`p(r)`= c(dom_assoc$p.pearson[1,2], dom_assoc$p.pearson[1,3],
                          dom_assoc$p.pearson[3,2])) %>% 
  mutate_all(round, digits=3)%>% 
  rownames_to_column("Domain Pairs") %>% 
  mutate(`Domain Pairs` = c("Carceral with Housing", "Carceral with Social Network",
                            "Housing with Social Network"))

state_dom_assoc_table

# kable(state_dom_assoc_table) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "state_dom_assoc_table.html")


```


## Creating/Plotting Multidomain Sequences
```{r}
#creating MD sequence df (to ensure proper alphabet)
MDseq <- list(seqcar, seqhou, seqsocnet) %>% 
  as.data.frame() 

colnames(MDseq) <- c("wave1_car", "wave2_car", "wave3_car", "wave4_car",
                     "wave1_hou", "wave2_hou", "wave3_hou", "wave4_hou",
                     "wave1_socnet", "wave2_socnet", "wave3_socnet", "wave4_socnet")
  
MDseq$wave1 <- paste(MDseq$wave1_car, "+", MDseq$wave1_hou, "+", MDseq$wave1_socnet)
MDseq$wave2 <- paste(MDseq$wave2_car, "+", MDseq$wave2_hou, "+", MDseq$wave2_socnet)
MDseq$wave3 <- paste(MDseq$wave3_car, "+", MDseq$wave3_hou, "+", MDseq$wave3_socnet)
MDseq$wave4 <- paste(MDseq$wave4_car, "+", MDseq$wave4_hou, "+", MDseq$wave4_socnet)

MDseq <- MDseq[, c(13:16)]

MDseq <- seqdef(MDseq,
       alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"),
       xtstep = 1)
 
#png("basic_MD_plot_R&R.png", width = 2000, height = 2000, res = 600)
seq_plot_MD <- seqplot(MDseq, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"), ylab = NA, border = NA, cex.legend = .5)
#dev.off()
```


## Cluster Analysis (IDCD Approach)

### Clustering MD sequences
```{r}
# Setting MD Costs/Distances 
MD_dist <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELSLOG") 
 
# conducting hierarchical cluster analysis (ward-d2) 
MD_clus <- agnes(MD_dist, diss = T, method = "ward") 

# storing clustering solution
# MD_clus_car_hou_socnet_4877 <- saveRDS(MD_clus, 
#                                           file = "MD_clus_car_hou_socnet_4877_RR#2.rds")

# png("dendrogram_final.png", width=7000, height=4000, res = 800)
# plot(MD_clus)
# rect.hclust(MD_clus, k= 3)
# #dev.off()
```


### Determining Number of Clusters: Cluster Quality Metrics
```{r}
clus_quality_table <- as.clustrange(MD_clus, diss = MD_dist, ncluster = 6) 

#generating evaluation plot
# png("MD_Eval_plots.png",width=8000, height=5000, res = 800, pointsize = 14)
clus_plot <- plot(clus_quality_table, stat = c("ASW", "HC", "CH", "PBC"), 
     norm= "zscore", legendpos= "topright", lwd=2) 
abline(v= 4,col= "red")
# dev.off()
```

### Determining Number of Clusters: Visualizing Different Numbers of Clusters
```{r}
## FOR SIX GROUPS ##  
MD_cut6 <- cutree(MD_clus, k= 6)  
MD_cut_fac6 <- factor(MD_cut6, levels = c(3, 2, 5, 6, 1, 4),
                     labels = paste("Type", 1:6))
 
 
#png("MDcluster_plot6.png", width=7000, height=5000, res = 900, pointsize = 9)  
seqplot(MDseq, group = MD_cut6, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1.2, 
        rows = 2, 
        cols = 3)  
#dev.off()  
 
## FOR FIVE GROUPS ##  
MD_cut5 <- cutree(MD_clus, k= 5)  
MD_cut_fac5 <- factor(MD_cut5, levels = c(3, 2, 5, 1, 4), 
                      labels = paste("Type", 1:5))

 
#png("MDcluster_plot5.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut5, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8,
        rows = 2,
        cols = 3)  
#dev.off()  
 
## FOR FOUR GROUPS ##  
MD_cut4 <- cutree(MD_clus, k= 4)  
# MD_cut_fac4 <- factor(MD_cut4, labels = paste("Type", 1:4))  
MD_cut_fac4 <- factor(MD_cut4, levels = c(3, 2, 4, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"),
                                 ordered = TRUE)
 
 
#png("MDcluster_plot4.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut4, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8, rows = 2, cols = 4)  
#dev.off()  

## FOR THREE GROUPS ##  
MD_cut3 <- cutree(MD_clus, k= 3)  
#MD_cut_fac3 <- factor(MD_cut3, labels = paste("Type", 1:3))
MD_cut_fac3 <- factor(MD_cut3, levels= c(3, 2, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Progressively Worsening Adversity (1-2 Domains)",
                                 "Consistently Moderate to High Adversity (2-3 Domains)"),
                      ordered = TRUE)


 
#png("MDcluster_plot3.png", width = 6500, height = 4000, res = 800)  
seqplot(MDseq, group = MD_cut3, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1,
        rows = 1,
        cols = 3)  
#dev.off()  
```

### Cluster Visualization (4 clusters)
```{r}
##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_m20.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1.1,
        rows = 2,
        cols = 2)
dev.off()

##REPRESENTATIVE PLOTS

#FREQUENCY

#png("MDcluster_plot4_freq.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="r",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        diss= MD_dist,
        criterion= "freq",
        coverage= .30,
        rows = 2,
        cols = 2)
#dev.off()

#NEIGHBORHOOD DENSITY

#png("MDcluster_plot4_neigh.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="r",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        diss= MD_dist,
        criterion= "density",
        pradius= 0.2,
        coverage= .30,
        rows = 2,
        cols = 2)
#dev.off()

#SEQUENCE INDEX PLOT
png("MDcluster_plot4_seqindex_m20.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="I",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()
```

## MODELING W/ MD CLUSTERS

### Data Cleaning, Imputing, and Wrangling
```{r}
set.seed(08540)
##PREPPING DATA
#creating outcome variable with the cluster assignments for each observation/sequence
clusterdf_MD <- data.frame(cluster_MD4= MD_cut_fac4) 
  
#adding demographic variables to data frame
clusterdf_demo_MD_0 <- bind_cols(clusterdf_MD, FF_adversity_FULL[49:64])

#cleaning up new demo variables
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3 Missing"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9 Not in wave"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 Skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -1.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -2.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -5.00] <- NA

 
#re-coding some of the categorical variables 
clusterdf_demo_MD_0 <- clusterdf_demo_MD_0 %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c("1 less hs") ~ 1,
                     mo_edu_wave0 %in% c("2 hs or equiv") ~ 2,
                     mo_edu_wave0 %in% c("3 some coll, tech") ~ 3,
                     mo_edu_wave0 %in% c("4 coll or grad") ~ 4)) %>% 
  mutate(mo_edu_wave1 =
           case_when(mo_edu_wave1 %in% c("1") ~ 1,
                     mo_edu_wave1 %in% c("2") ~ 2,
                     mo_edu_wave1 %in% c("3") ~ 3,
                     mo_edu_wave1 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave2 =
           case_when(mo_edu_wave2 %in% c("1") ~ 1,
                     mo_edu_wave2 %in% c("2") ~ 2,
                     mo_edu_wave2 %in% c("3") ~ 3,
                     mo_edu_wave2 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave3 =
           case_when(mo_edu_wave3 %in% c("1") ~ 1,
                     mo_edu_wave3 %in% c("2") ~ 2,
                     mo_edu_wave3 %in% c("3") ~ 3,
                     mo_edu_wave3 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave4 =
           case_when(mo_edu_wave4 %in% c("1") ~ 1,
                     mo_edu_wave4 %in% c("2") ~ 2,
                     mo_edu_wave4 %in% c("3") ~ 3,
                     mo_edu_wave4 %in% c("4") ~ 4)) 

clusterdf_demo_MD <- clusterdf_demo_MD_0

##IMPUTING SELECT MISSING DEMO DATA (only those that will be used in modeling)
#selecting variables to impute 
clusdf_select_MD <- bind_cols(clusterdf_demo_MD[4:7], clusterdf_demo_MD[9:12])

#imputing missing data for select demo/control variables
clusdf_select_MD_imp <- mice(data=clusdf_select_MD, m= 10, method = "pmm", 
                             print= F)

#examining imputed data
#head(complete(clusdf_select_MD_imp))

#creating an imputed data set
clusdf_select_MD_imp_comp <- complete(clusdf_select_MD_imp, "long", include = F)

#adding index for later grouping and generating avgs across imputed data sets
clusdf_select_MD_imp_comp$index <- rep(clusterdf_demo_MD$index, times= 10)

clusdf_select_MD_imp_comp <- clusdf_select_MD_imp_comp %>% 
  relocate(index, .before= .id)

#generating average value of imputed variables across the imputed data sets
demoMD_imp_avgs <- clusdf_select_MD_imp_comp %>% 
  group_by(index) %>% 
  summarise(round(mean(mo_edu_wave1)),
            round(mean(mo_edu_wave2)),
            round(mean(mo_edu_wave3)),
            round(mean(mo_edu_wave4)),
            round(mean(mo_hh_income_wave1)),
            round(mean(mo_hh_income_wave2)),
            round(mean(mo_hh_income_wave3)),
            round(mean(mo_hh_income_wave4)))
            
colnames(demoMD_imp_avgs) <- c("index","mo_edu_wave1", "mo_edu_wave2","mo_edu_wave3", 
                               "mo_edu_wave4", "mo_hh_income_wave1", "mo_hh_income_wave2",
                               "mo_hh_income_wave3", "mo_hh_income_wave4")

#creating new complete data set with imputed demographic/control variables
FF_MD_clus0 <- clusterdf_demo_MD %>% 
  subset(select = -c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                     mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                     mo_hh_income_wave4)) %>% 
  left_join(demoMD_imp_avgs, by= "index") 
  

#transforming education variable back to categorical and adding substantive labels 
FF_MD_clus <- FF_MD_clus0 %>% 
  mutate(mo_edu_wave0= case_when(mo_edu_wave0 %in% c(1) ~ "less hs",
                                 mo_edu_wave0 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave0 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave0 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave1= case_when(mo_edu_wave1 %in% c(1) ~ "less hs",
                                 mo_edu_wave1 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave1 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave1 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave2= case_when(mo_edu_wave2 %in% c(1) ~ "less hs",
                                 mo_edu_wave2 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave2 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave2 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave3= case_when(mo_edu_wave3 %in% c(1) ~ "less hs",
                                 mo_edu_wave3 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave3 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave3 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave4= case_when(mo_edu_wave4 %in% c(1) ~ "less hs",
                                 mo_edu_wave4 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave4 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave4 %in% c(4) ~ "coll or grad")) 

#logging hh income variable for modeling (adding one to address zeros)
FF_MD_clus <- FF_MD_clus %>% 
  mutate(hh_income_log= log(FF_MD_clus$mo_hh_income_wave0 +1)) 

#recoding education at baseline as ordinal factor for modeling
FF_MD_clus$mo_edu_wave0 <- factor(FF_MD_clus$mo_edu_wave0,
                                     levels=c("less hs",
                                              "hs or equiv",
                                              "some coll, tech",
                                              "coll or grad"))

#adding unordered version of cluster variables for multinomial regression & turning
#mother's race/ethnicity into unordered factor variable to set reference level
FF_MD_clus <- FF_MD_clus %>% 
  mutate(cluster_MD4_m= factor(FF_MD_clus$cluster_MD4, ordered = F)) %>%
  mutate(mo_race_eth= factor(FF_MD_clus$mo_race_eth, ordered = F))
```

### Generating Descriptive Table of Analytic Sample
```{r}
clusterdf_demo_MD_descrip <- clusterdf_demo_MD %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c(1) ~ "Less Than High School",
                     mo_edu_wave0 %in% c(2) ~ "High School or Equivalent",
                     mo_edu_wave0 %in% c(3) ~ "Some College/Technical School",
                     mo_edu_wave0 %in% c(4) ~ "College or Graduate School")) %>% 
  mutate(mo_race_eth =
           case_when(mo_race_eth %in% c("1 white, non-hispanic") ~ "White, Non-Hispanic",
                     mo_race_eth %in% c("2 black, non-hispanic") ~ "Black, Non-Hispanic",
                     mo_race_eth %in% c("3 hispanic") ~ "Hispanic",
                     mo_race_eth %in% c("4 other") ~ "Other Race/Ethnicity"))

descripMD <-  clusterdf_demo_MD_descrip %>% 
  dplyr::select(mo_race_eth, mo_edu_wave0, mo_hh_income_wave0, 
         mo_age_wave0, mo_married_wave0, mo_cohab_wave0)

descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "0"] <- "Not married"
descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "1"] <- "Married"

descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "0"] <- "Not Cohabitating"
descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "1"] <- "Cohabitating"

label(descripMD$mo_hh_income_wave0) <- "Mother's Annual Household Income at Baseline"
label(descripMD$mo_race_eth) <- "Race/Ethnicity"
label(descripMD$mo_edu_wave0) <- "Education at Baseline"
label(descripMD$mo_married_wave0) <- "Mother Married to Bio Dad at Baseline"
label(descripMD$mo_cohab_wave0) <- "Mother Cohabitating w/ Bio Dad at Baseline"
label(descripMD$mo_age_wave0) <- "Age at Birth of Focal Child"

descripMD_table <- table1(~mo_race_eth + 
                          mo_edu_wave0 + mo_age_wave0 + mo_hh_income_wave0 +
                          mo_married_wave0 + mo_cohab_wave0, 
                        data = descripMD)
descripMD_table
# png("Sample_Table.png", width = 550, height = 550)
# tableGrob(descripMD_table)
# dev.off()

# #png("Sample_Table.png", width = 550, height = 550)
# apa_table(descripMD_table)
# #dev.off()

```

### Modeling w/ IDCD Clusters (MULTINOMINAL)
```{r}
##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the very low adversity cluster [3 clusters]
FF_MD_clus$cluster_MD4_m <- relevel(FF_MD_clus$cluster_MD4_m,
                                      ref = "Consistently Very Low Adversity (0-1 Domains)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

## MODEL 1
# mother's race as sole predictor model
mod1_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD4)

z_mod1_MD4 <- summary(mod1_MD4)$coefficients/summary(mod1_MD4)$standard.errors
p_mod1_MD4 <- (1 - pnorm(abs(z_mod1_MD4), 0, 1)) * 2
p_mod1_MD4

## MODEL 2
# mother's race as predictor w/ education, income, and age of mother at focal child's
# birth as covariates
mod2_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth +
                                     hh_income_log + mo_edu_wave0 +
                                     mo_age_wave0,
                                   data = FF_MD_clus)

summary(mod2_MD4)

z_mod2_MD4 <- summary(mod2_MD4)$coefficients/summary(mod2_MD4)$standard.errors
p_mod2_MD4 <- (1 - pnorm(abs(z_mod2_MD4), 0, 1)) * 2
p_mod2_MD4
```

#### Multinomial Regression Table
```{r, results='asis', warning=FALSE}
stargazer(mod1_MD4, mod2_MD4,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          dep.var.labels = c("Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity",
                             "Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity"),
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Household Income (Logged)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "-10pt",
          notes.append = F,
          type = "html")
```


# SENSITIVITY CHECK: Imputation Where Highest Quartile Dropped Using PMM (m=10)
```{r}
set.seed(08540)
FF_adv_quart_with_predictors <- FF_adversity_FULL[,c(1:60)] %>% 
  dplyr::select(-c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                   mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                   mo_hh_income_wave4)) %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  right_join(data.frame(index= caselevel_na_quart$index), by= "index") 

FF_adv.comp_quart <- readRDS("FF_adv_imp_car_hou_socnet_3658_withpred_R%R#2.rds")

# #imputing missing data
# FF_adv_quart_with_predictors.imp <- mice(data = FF_adv_quart_with_predictors, m= 10,
#                                    method = "pmm", print= FALSE,
#                                    remove.collinear = FALSE)
# 
# #examining imputed data
# head(complete(FF_adv_quart_with_predictors.imp))
# 
# ##creating an imputed data set
# FF_adv.comp_quart <- complete(FF_adv_quart_with_predictors.imp, "long", include = F)
# 
# FF_adv_imp_car_hou_socnet_3658_with_predictors <- saveRDS(FF_adv.comp_quart, 
#                                           file = "FF_adv_imp_car_hou_socnet_3658_withpred_R%R#2.rds")

```

## [CARCERAL SYSTEM] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under carceral system domain
carceral_domain <- FF_adv.comp_quart %>% 
  dplyr::select(ends_with(c("fjail", "rjail","fprobs"))) %>% 
  mutate(imp=FF_adv.comp_quart$.imp) 

#wave 1
c_domain_w1 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

c_domain_w1_sums_FULL <- as.data.frame(rowSums(c_domain_w1[,c(2:4)]))

#wave 2
c_domain_w2 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

c_domain_w2_sums_FULL <- as.data.frame(rowSums(c_domain_w2[,c(2:4)]))

#wave 3
c_domain_w3 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

c_domain_w3_sums_FULL <- as.data.frame(rowSums(c_domain_w3[,c(2:4)]))

#wave 4
c_domain_w4 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

c_domain_w4_sums_FULL <- as.data.frame(rowSums(c_domain_w4[,c(2:4)]))

 
##creating a data set with the Summated scores  
c_dom_sums_FULL <- bind_cols(c_domain_w1_sums_FULL, c_domain_w2_sums_FULL, 
                             c_domain_w3_sums_FULL, c_domain_w4_sums_FULL) 

c_dom_sums_FULL$index <- rep(caselevel_na_quart$index, rep= 10)

colnames(c_dom_sums_FULL) <- c("wave1_cdom_sums_FULL", "wave2_cdom_sums_FULL",  
                               "wave3_cdom_sums_FULL", "wave4_cdom_sums_FULL", 
                               "index") 
 
c_dom_sums_FULL <- c_dom_sums_FULL %>%  
  relocate(index, .before= wave1_cdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_quart$.imp) %>%  
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
cdom_wave1avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave1_cdom_sums_FULL)")

cdom_wave2avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave2_cdom_sums_FULL)")

cdom_wave3avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave3_cdom_sums_FULL)")

cdom_wave4avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave4_cdom_sums_FULL)")

 
cdom_allwaves_avg_FULL <- bind_cols(caselevel_na_quart$index, cdom_wave1avg, cdom_wave2avg,  
                               cdom_wave3avg, cdom_wave4avg) 
 
colnames(cdom_allwaves_avg_FULL) <- c("index", "cdom_avg1", "cdom_avg2",  
                                      "cdom_avg3", "cdom_avg4") 
 
#converting into binary states 
cdom_allwaves_avg_cat_FULL <- cdom_allwaves_avg_FULL %>%  
  mutate(cdomw1_cat= case_when(cdom_avg1 == 0  ~ "carceral_no", 
                              cdom_avg1 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw2_cat= case_when(cdom_avg2 == 0  ~ "carceral_no",  
                              cdom_avg2 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw3_cat= case_when(cdom_avg3 == 0  ~ "carceral_no", 
                              cdom_avg3 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw4_cat= case_when(cdom_avg4 == 0  ~ "carceral_no", 
                              cdom_avg4 > 0 ~ "carceral_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
#wave 1
rel_c_domain_w1<- c_domain_w1 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(w1_fjail= mean(wave1_fjail),
            w1_fprobs= mean(wave1_fprobs),
            w1_feverjail= mean(wave1_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w1_fjail= ifelse(w1_fjail>0, 1, 0)) %>% 
  mutate(w1_fprobs= ifelse(w1_fprobs>0, 1, 0)) %>% 
  mutate(w1_feverjail= ifelse(w1_feverjail>0, 1, 0))

#wave 2
rel_c_domain_w2<- c_domain_w2 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(w2_fjail= mean(wave2_fjail),
            w2_fprobs= mean(wave2_fprobs),
            w2_feverjail= mean(wave2_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w2_fjail= ifelse(w2_fjail>0, 1, 0)) %>% 
  mutate(w2_fprobs= ifelse(w2_fprobs>0, 1, 0)) %>% 
  mutate(w2_feverjail= ifelse(w2_feverjail>0, 1, 0))

#wave 3
rel_c_domain_w3<- c_domain_w3 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(w3_fjail= mean(wave3_fjail),
            w3_fprobs= mean(wave3_fprobs),
            w3_feverjail= mean(wave3_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w3_fjail= ifelse(w3_fjail>0, 1, 0)) %>% 
  mutate(w3_fprobs= ifelse(w3_fprobs>0, 1, 0)) %>% 
  mutate(w3_feverjail= ifelse(w3_feverjail>0, 1, 0))

#wave 4
rel_c_domain_w4<- c_domain_w4 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(w4_fjail= mean(wave4_fjail),
            w4_fprobs= mean(wave4_fprobs),
            w4_feverjail= mean(wave4_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w4_fjail= ifelse(w4_fjail>0, 1, 0)) %>% 
  mutate(w4_fprobs= ifelse(w4_fprobs>0, 1, 0)) %>% 
  mutate(w4_feverjail= ifelse(w4_feverjail>0, 1, 0))


alpha_carceral_w1 <- data.frame(raw_alpha= alpha(rel_c_domain_w1)$total$raw_alpha) 
alpha_carceral_w2 <- data.frame(raw_alpha= alpha(rel_c_domain_w2)$total$raw_alpha)
alpha_carceral_w3 <- data.frame(raw_alpha= alpha(rel_c_domain_w3)$total$raw_alpha)
alpha_carceral_w4 <- data.frame(raw_alpha= alpha(rel_c_domain_w4)$total$raw_alpha)

alpha_carceral <- rbind(alpha_carceral_w1,
                      alpha_carceral_w2,
                      alpha_carceral_w3,
                      alpha_carceral_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")
```



## [HOUSING] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under housing system domain
housing_domain <- FF_adv.comp_quart %>% 
  dplyr::select(ends_with(c("evict", "nonreghouse", "moneymove",
                     "gaselec", "tele"))) %>%
  mutate(imp=FF_adv.comp_quart$.imp) 

#wave 1
ho_domain_w1 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

ho_domain_w1_sums_FULL <- as.data.frame(rowSums(ho_domain_w1[,c(2:6)]))

#wave 2
ho_domain_w2 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

ho_domain_w2_sums_FULL <- as.data.frame(rowSums(ho_domain_w2[,c(2:6)]))

#wave 3
ho_domain_w3 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

ho_domain_w3_sums_FULL <- as.data.frame(rowSums(ho_domain_w3[,c(2:6)]))

#wave 4
ho_domain_w4 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

ho_domain_w4_sums_FULL <- as.data.frame(rowSums(ho_domain_w4[,c(2:6)]))
 
##creating a data set with the Summatedd scores  
ho_dom_sums_FULL <- bind_cols(ho_domain_w1_sums_FULL, ho_domain_w2_sums_FULL, 
                             ho_domain_w3_sums_FULL, ho_domain_w4_sums_FULL)

ho_dom_sums_FULL$index <- rep(caselevel_na_quart$index, rep= 10) 
 
colnames(ho_dom_sums_FULL) <- c("wave1_hodom_sums_FULL", "wave2_hodom_sums_FULL",  
                               "wave3_hodom_sums_FULL", "wave4_hodom_sums_FULL", 
                               "index") 
 
ho_dom_sums_FULL <- ho_dom_sums_FULL %>%  
  relocate(index, .before= wave1_hodom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_quart$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
hodom_wave1avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_hodom_sums_FULL)") 
 
hodom_wave2avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_hodom_sums_FULL)") 
 
hodom_wave3avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_hodom_sums_FULL)") 
 
hodom_wave4avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_hodom_sums_FULL)") 
 
hodom_allwaves_avg_FULL <- bind_cols(caselevel_na_quart$index, hodom_wave1avg, hodom_wave2avg,  
                               hodom_wave3avg, hodom_wave4avg) 
 
colnames(hodom_allwaves_avg_FULL) <- c("index", "hodom_avg1", "hodom_avg2",  
                                      "hodom_avg3", "hodom_avg4") 
 
#converting into binary states 
hodom_allwaves_avg_cat_FULL <- hodom_allwaves_avg_FULL %>%  
  mutate(hodomw1_cat= case_when(hodom_avg1 == 0  ~ "house_no", 
                              hodom_avg1 > 0 ~ "house_yes")) %>%  
  mutate(hodomw2_cat= case_when(hodom_avg2 == 0  ~ "house_no",  
                              hodom_avg2 > 0 ~ "house_yes")) %>%  
  mutate(hodomw3_cat= case_when(hodom_avg3 == 0  ~ "house_no", 
                              hodom_avg3 > 0 ~ "house_yes")) %>%  
  mutate(hodomw4_cat= case_when(hodom_avg4 == 0  ~ "house_no", 
                              hodom_avg4 > 0 ~ "house_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_hou_domain_w1<- ho_domain_w1 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(wave1_evict= mean(wave1_evict),
            wave1_nonreghouse= mean(wave1_nonreghouse),
            wave1_moneymove= mean(wave1_moneymove),
            wave1_gaselec= mean(wave1_gaselec),
            wave1_tele= mean(wave1_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_evict= ifelse(wave1_evict>0, 1, 0)) %>% 
  mutate(wave1_nonreghouse= ifelse(wave1_nonreghouse>0, 1, 0)) %>% 
  mutate(wave1_moneymove= ifelse(wave1_moneymove>0, 1, 0)) %>% 
  mutate(wave1_gaselec= ifelse(wave1_gaselec>0, 1, 0)) %>% 
  mutate(wave1_tele= ifelse(wave1_tele>0, 1, 0))

rel_hou_domain_w2<- ho_domain_w2 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(wave2_evict= mean(wave2_evict),
            wave2_nonreghouse= mean(wave2_nonreghouse),
            wave2_moneymove= mean(wave2_moneymove),
            wave2_gaselec= mean(wave2_gaselec),
            wave2_tele= mean(wave2_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_evict= ifelse(wave2_evict>0, 1, 0)) %>% 
  mutate(wave2_nonreghouse= ifelse(wave2_nonreghouse>0, 1, 0)) %>% 
  mutate(wave2_moneymove= ifelse(wave2_moneymove>0, 1, 0)) %>% 
  mutate(wave2_gaselec= ifelse(wave2_gaselec>0, 1, 0)) %>% 
  mutate(wave2_tele= ifelse(wave2_tele>0, 1, 0))


rel_hou_domain_w3<- ho_domain_w3 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(wave3_evict= mean(wave3_evict),
            wave3_nonreghouse= mean(wave3_nonreghouse),
            wave3_moneymove= mean(wave3_moneymove),
            wave3_gaselec= mean(wave3_gaselec),
            wave3_tele= mean(wave3_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_evict= ifelse(wave3_evict>0, 1, 0)) %>% 
  mutate(wave3_nonreghouse= ifelse(wave3_nonreghouse>0, 1, 0)) %>% 
  mutate(wave3_moneymove= ifelse(wave3_moneymove>0, 1, 0)) %>% 
  mutate(wave3_gaselec= ifelse(wave3_gaselec>0, 1, 0)) %>% 
  mutate(wave3_tele= ifelse(wave3_tele>0, 1, 0))

rel_hou_domain_w4<- ho_domain_w4 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(wave4_evict= mean(wave4_evict),
            wave4_nonreghouse= mean(wave4_nonreghouse),
            wave4_moneymove= mean(wave4_moneymove),
            wave4_gaselec= mean(wave4_gaselec),
            wave4_tele= mean(wave4_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_evict= ifelse(wave4_evict>0, 1, 0)) %>% 
  mutate(wave4_nonreghouse= ifelse(wave4_nonreghouse>0, 1, 0)) %>% 
  mutate(wave4_moneymove= ifelse(wave4_moneymove>0, 1, 0)) %>% 
  mutate(wave4_gaselec= ifelse(wave4_gaselec>0, 1, 0)) %>% 
  mutate(wave4_tele= ifelse(wave4_tele>0, 1, 0))


alpha_hou_w1 <- data.frame(raw_alpha= alpha(rel_hou_domain_w1)$total$raw_alpha) 
alpha_hou_w2 <- data.frame(raw_alpha= alpha(rel_hou_domain_w2)$total$raw_alpha)
alpha_hou_w3 <- data.frame(raw_alpha= alpha(rel_hou_domain_w3)$total$raw_alpha)
alpha_hou_w4 <- data.frame(raw_alpha= alpha(rel_hou_domain_w4)$total$raw_alpha)

alpha_hou <- rbind(alpha_hou_w1,
                      alpha_hou_w2,
                      alpha_hou_w3,
                      alpha_hou_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```


## [SOCIAL NETWORK] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under social network domain
socnet_domain <- FF_adv.comp_quart %>% 
  dplyr::select(ends_with(c("emcare", "1kloan", "200loan",
                     "1kcosign"))) %>%
  mutate(imp=FF_adv.comp_quart$.imp) 

#wave 1
net_domain_w1 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

net_domain_w1_sums_FULL <- as.data.frame(rowSums(net_domain_w1[,c(2:5)]))

#wave 2
net_domain_w2 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

net_domain_w2_sums_FULL <- as.data.frame(rowSums(net_domain_w2[,c(2:5)]))

#wave 3
net_domain_w3 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

net_domain_w3_sums_FULL <- as.data.frame(rowSums(net_domain_w3[,c(2:5)]))

#wave 4
net_domain_w4 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

net_domain_w4_sums_FULL <- as.data.frame(rowSums(net_domain_w4[,c(2:5)]))

 
##creating a data set with the Summatedd scores  
net_dom_sums_FULL <- bind_cols(net_domain_w1_sums_FULL, net_domain_w2_sums_FULL, 
                             net_domain_w3_sums_FULL, net_domain_w4_sums_FULL) 
net_dom_sums_FULL$index <- rep(caselevel_na_quart$index, rep= 10) 
 
colnames(net_dom_sums_FULL) <- c("wave1_netdom_sums_FULL", "wave2_netdom_sums_FULL",  
                               "wave3_netdom_sums_FULL", "wave4_netdom_sums_FULL",  
                               "index") 
 
net_dom_sums_FULL <- net_dom_sums_FULL %>%  
  relocate(index, .before= wave1_netdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_quart$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
netdom_wave1avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_netdom_sums_FULL)") 
 
netdom_wave2avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_netdom_sums_FULL)") 
 
netdom_wave3avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_netdom_sums_FULL)") 
 
netdom_wave4avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_netdom_sums_FULL)") 
 
netdom_allwaves_avg_FULL <- bind_cols(caselevel_na_quart$index, netdom_wave1avg, netdom_wave2avg,  
                               netdom_wave3avg, netdom_wave4avg) 
 
colnames(netdom_allwaves_avg_FULL) <- c("index", "netdom_avg1", "netdom_avg2",  
                                      "netdom_avg3", "netdom_avg4") 
 
#converting into binary states 
netdom_allwaves_avg_cat_FULL <- netdom_allwaves_avg_FULL %>%  
  mutate(netdomw1_cat= case_when(netdom_avg1 == 0  ~ "socnetwork_no", 
                              netdom_avg1 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw2_cat= case_when(netdom_avg2 == 0  ~ "socnetwork_no",  
                              netdom_avg2 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw3_cat= case_when(netdom_avg3 == 0  ~ "socnetwork_no", 
                              netdom_avg3 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw4_cat= case_when(netdom_avg4 == 0  ~ "socnetwork_no", 
                              netdom_avg4 > 0 ~ "socnetwork_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_net_domain_w1<- net_domain_w1 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(wave1_emcare= mean(wave1_emcare),
            wave1_1kloan= mean(wave1_1kloan),
            wave1_200loan= mean(wave1_200loan),
            wave1_1kcosign= mean(wave1_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_emcare= ifelse(wave1_emcare>0, 1, 0)) %>% 
  mutate(wave1_1kloan= ifelse(wave1_1kloan>0, 1, 0)) %>% 
  mutate(wave1_200loan= ifelse(wave1_200loan>0, 1, 0)) %>% 
  mutate(wave1_1kcosign= ifelse(wave1_1kcosign>0, 1, 0)) 


rel_net_domain_w2<- net_domain_w2 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(wave2_emcare= mean(wave2_emcare),
            wave2_1kloan= mean(wave2_1kloan),
            wave2_200loan= mean(wave2_200loan),
            wave2_1kcosign= mean(wave2_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_emcare= ifelse(wave2_emcare>0, 1, 0)) %>% 
  mutate(wave2_1kloan= ifelse(wave2_1kloan>0, 1, 0)) %>% 
  mutate(wave2_200loan= ifelse(wave2_200loan>0, 1, 0)) %>% 
  mutate(wave2_1kcosign= ifelse(wave2_1kcosign>0, 1, 0)) 


rel_net_domain_w3<- net_domain_w3 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(wave3_emcare= mean(wave3_emcare),
            wave3_1kloan= mean(wave3_1kloan),
            wave3_200loan= mean(wave3_200loan),
            wave3_1kcosign= mean(wave3_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_emcare= ifelse(wave3_emcare>0, 1, 0)) %>% 
  mutate(wave3_1kloan= ifelse(wave3_1kloan>0, 1, 0)) %>% 
  mutate(wave3_200loan= ifelse(wave3_200loan>0, 1, 0)) %>% 
  mutate(wave3_1kcosign= ifelse(wave3_1kcosign>0, 1, 0)) 

rel_net_domain_w4<- net_domain_w4 %>% 
  mutate(index= caselevel_na_quart$index) %>% 
  group_by(index) %>%  
  summarise(wave4_emcare= mean(wave4_emcare),
            wave4_1kloan= mean(wave4_1kloan),
            wave4_200loan= mean(wave4_200loan),
            wave4_1kcosign= mean(wave4_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_emcare= ifelse(wave4_emcare>0, 1, 0)) %>% 
  mutate(wave4_1kloan= ifelse(wave4_1kloan>0, 1, 0)) %>% 
  mutate(wave4_200loan= ifelse(wave4_200loan>0, 1, 0)) %>% 
  mutate(wave4_1kcosign= ifelse(wave4_1kcosign>0, 1, 0)) 

# alpha(rel_net_domain_w1)
# alpha(rel_net_domain_w2)
# alpha(rel_net_domain_w3)
# alpha(rel_net_domain_w4)

alpha_net_w1 <- data.frame(raw_alpha= alpha(rel_net_domain_w1)$total$raw_alpha) 
alpha_net_w2 <- data.frame(raw_alpha= alpha(rel_net_domain_w2)$total$raw_alpha)
alpha_net_w3 <- data.frame(raw_alpha= alpha(rel_net_domain_w3)$total$raw_alpha)
alpha_net_w4 <- data.frame(raw_alpha= alpha(rel_net_domain_w4)$total$raw_alpha)

alpha_socnet <- rbind(alpha_net_w1,
                      alpha_net_w2,
                      alpha_net_w3,
                      alpha_net_w4) %>% 
  mutate(Wave= c("Wave 1(Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```

## Table of Alphas for All Three Domains
```{r}
alpha_all_domains <- cbind(alpha_carceral, alpha_hou$raw_alpha, alpha_socnet$raw_alpha) 

colnames(alpha_all_domains) <- c("Wave" ,"Carceral", "Housing", "Social Network")

alpha_all_domains %>% 
  summarise_all(mean)

alpha_all_domains <- alpha_all_domains %>% 
  mutate_if(is.numeric, round, digits= 2)

alpha_all_domains

# png("MD_alphas_table.png", width = 550, height = 550)  
# #dev.off() 

# kable(alpha_all_domains) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "alpha_all_domain.html")

```


## Creating Sequences with Composite Scores
```{r}
## cleaning dataframes for defining  
carceral_traj <- cdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("cdomw")) 

housing_traj <- hodom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("hodomw")) 
 
socnet_traj <- netdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("netdomw")) 
 
##defining sequence objects for each domain 
 
#carceral system 
cdom_alphabet <- c("carceral_yes", "carceral_no") 
cdom_labs <- c("carceral_yes", "carceral_no") 
 
colnames(carceral_traj)[1] <- "Wave 1 (Y1)" 
colnames(carceral_traj)[2] <- "Wave 2 (Y3)" 
colnames(carceral_traj)[3] <- "Wave 3 (Y5)" 
colnames(carceral_traj)[4] <- "Wave 4 (Y9)" 

seqcar <- seqdef(carceral_traj, 
                 var = 1:4, 
                 alphabet = cdom_alphabet, 
                 labels=cdom_labs, 
                 xstep= 1 ) 

#housing system 
hodom_alphabet <- c("house_yes", "house_no") 
hodom_labs <- c("house_yes", "house_no") 
 
colnames(housing_traj)[1] <- "Wave 1 (Y1)" 
colnames(housing_traj)[2] <- "Wave 2 (Y3)" 
colnames(housing_traj)[3] <- "Wave 3 (Y5)" 
colnames(housing_traj)[4] <- "Wave 4 (Y9)" 

seqhou <- seqdef(housing_traj, 
                 var = 1:4, 
                 alphabet = hodom_alphabet, 
                 labels=hodom_labs, 
                 xstep= 1) 
 
#social network 
netdom_alphabet <- c("socnetwork_yes", "socnetwork_no") 
netdom_labs <- c("socnetwork_yes", "socnetwork_no") 
 
colnames(socnet_traj)[1] <- "Wave 1 (Y1)" 
colnames(socnet_traj)[2] <- "Wave 2 (Y3)" 
colnames(socnet_traj)[3] <- "Wave 3 (Y5)" 
colnames(socnet_traj)[4] <- "Wave 4 (Y9)" 

seqsocnet <- seqdef(socnet_traj, 
                 var = 1:4, 
                 alphabet = netdom_alphabet, 
                 labels=netdom_labs, 
                 xstep= 1) 

 
## Calculating Distance/Dissimilarity Matrix [OM] 
 
#carceral system 
carceral_distOM <- seqdist(seqcar, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#housing 
housing_distOM <- seqdist(seqhou, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#social network 
socnet_distOM <- seqdist(seqsocnet, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
```


## Measuring Strength of Association at Domain & State Levels
```{r}
##at state level (testing whether CAT could be used) 
state_assoc <- seqdomassoc(list(seqcar, seqhou, seqsocnet), 
            rep.method = "overall", 
            assoc = "V", 
            p.value = T, 
            struct.zero = F, 
            cross.table = T, 
            with.missing = F, 
            weighted = F, 
            dnames = c("Carceral", "Housing", "Soc Network")) 
state_assoc

state_assoc_df <- state_assoc[,c(2, 3)] %>% 
  as.data.frame() 

 
##at sequence level (testing whether DAT could be used) 
dom_assoc <- dissdomassoc(list(carceral_distOM, housing_distOM, socnet_distOM), 
             what = "pearson", 
             dnames = c("Carceral", "Housing", "Soc Network")) 
dom_assoc$p.pearson

state_dom_assoc_table <- state_assoc_df %>% 
  mutate(`Pearson's r`= c(dom_assoc$Pearson[1,2], dom_assoc$Pearson[1,3],
                          dom_assoc$Pearson[3,2])) %>% 
  mutate(`p(r)`= c(dom_assoc$p.pearson[1,2], dom_assoc$p.pearson[1,3],
                          dom_assoc$p.pearson[3,2])) %>% 
  mutate_all(round, digits=3)%>% 
  rownames_to_column("Domain Pairs") %>% 
  mutate(`Domain Pairs` = c("Carceral with Housing", "Carceral with Social Network",
                            "Housing with Social Network"))

state_dom_assoc_table

# kable(state_dom_assoc_table) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "state_dom_assoc_table.html")


```


## Creating/Plotting Multidomain Sequences
```{r}
#creating MD sequence df (to ensure proper alphabet)
MDseq <- list(seqcar, seqhou, seqsocnet) %>% 
  as.data.frame() 

colnames(MDseq) <- c("wave1_car", "wave2_car", "wave3_car", "wave4_car",
                     "wave1_hou", "wave2_hou", "wave3_hou", "wave4_hou",
                     "wave1_socnet", "wave2_socnet", "wave3_socnet", "wave4_socnet")
  
MDseq$wave1 <- paste(MDseq$wave1_car, "+", MDseq$wave1_hou, "+", MDseq$wave1_socnet)
MDseq$wave2 <- paste(MDseq$wave2_car, "+", MDseq$wave2_hou, "+", MDseq$wave2_socnet)
MDseq$wave3 <- paste(MDseq$wave3_car, "+", MDseq$wave3_hou, "+", MDseq$wave3_socnet)
MDseq$wave4 <- paste(MDseq$wave4_car, "+", MDseq$wave4_hou, "+", MDseq$wave4_socnet)

MDseq <- MDseq[, c(13:16)]

MDseq <- seqdef(MDseq,
       alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"),
       xtstep = 1)
 
#png("basic_MD_plot_R&R.png", width = 2000, height = 2000, res = 600)
seq_plot_MD <- seqplot(MDseq, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"), ylab = NA, border = NA, cex.legend = .5)
#dev.off()
```


## Cluster Analysis (IDCD Approach)

### Clustering MD sequences
```{r}
# Setting MD Costs/Distances 
MD_dist <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELSLOG") 
 
# conducting hierarchical cluster analysis (ward-d2) 
MD_clus <- agnes(MD_dist, diss = T, method = "ward") 

# storing clustering solution
# MD_clus_car_hou_socnet_4877 <- saveRDS(MD_clus, 
#                                           file = "MD_clus_car_hou_socnet_4877_RR#2.rds")

# png("dendrogram_final.png", width=7000, height=4000, res = 800)
# plot(MD_clus)
# rect.hclust(MD_clus, k= 3)
# #dev.off()
```


### Determining Number of Clusters: Cluster Quality Metrics
```{r}
clus_quality_table <- as.clustrange(MD_clus, diss = MD_dist, ncluster = 6) 

#generating evaluation plot
# png("MD_Eval_plots.png",width=8000, height=5000, res = 800, pointsize = 14)
clus_plot <- plot(clus_quality_table, stat = c("ASW", "HC", "CH", "PBC"), 
     norm= "zscore", legendpos= "topright", lwd=2) 
abline(v= 4,col= "red")
# dev.off()
```

### Determining Number of Clusters: Visualizing Different Numbers of Clusters
```{r}
## FOR SIX GROUPS ##  
MD_cut6 <- cutree(MD_clus, k= 6)  
MD_cut_fac6 <- factor(MD_cut6, levels = c(3, 2, 5, 6, 1, 4),
                     labels = paste("Type", 1:6))
 
 
#png("MDcluster_plot6.png", width=7000, height=5000, res = 900, pointsize = 9)  
seqplot(MDseq, group = MD_cut6, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1.2, 
        rows = 2, 
        cols = 3)  
#dev.off()  
 
## FOR FIVE GROUPS ##  
MD_cut5 <- cutree(MD_clus, k= 5)  
MD_cut_fac5 <- factor(MD_cut5, levels = c(3, 2, 5, 1, 4), 
                      labels = paste("Type", 1:5))

 
#png("MDcluster_plot5.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut5, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8,
        rows = 2,
        cols = 3)  
#dev.off()  
 
## FOR FOUR GROUPS ##  
MD_cut4 <- cutree(MD_clus, k= 4)  
# MD_cut_fac4 <- factor(MD_cut4, labels = paste("Type", 1:4))  
MD_cut_fac4 <- factor(MD_cut4, levels = c(2, 3, 4, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"),
                                 ordered = TRUE)
 
 
#png("MDcluster_plot4.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut4, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8, rows = 2, cols = 4)  
#dev.off()  

## FOR THREE GROUPS ##  
MD_cut3 <- cutree(MD_clus, k= 3)  
#MD_cut_fac3 <- factor(MD_cut3, labels = paste("Type", 1:3))
MD_cut_fac3 <- factor(MD_cut3, levels= c(2, 3, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Progressively Worsening Adversity (1-2 Domains)",
                                 "Consistently Moderate to High Adversity (2-3 Domains)"),
                      ordered = TRUE)


 
#png("MDcluster_plot3.png", width = 6500, height = 4000, res = 800)  
seqplot(MDseq, group = MD_cut3, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1,
        rows = 1,
        cols = 3)  
#dev.off()   
```

### Cluster Visualization (4 clusters)
```{r}
##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_quart.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1.1,
        rows = 2,
        cols = 2)
dev.off()

#SEQUENCE INDEX PLOT
png("MDcluster_plot4_seqindex_quart.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="I",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()
```

## MODELING W/ MD CLUSTERS

### Data Cleaning, Imputing, and Wrangling
```{r}
set.seed(08540)
##PREPPING DATA
#creating outcome variable with the cluster assignments for each observation/sequence
clusterdf_MD <- data.frame(cluster_MD4= MD_cut_fac4) 

FF_adversity_quart <- FF_adversity_FULL[,c(49:64)] %>% 
  right_join(data.frame(index= caselevel_na_quart$index), by= "index") 
  
#adding demographic variables to data frame
clusterdf_demo_MD_0 <- bind_cols(clusterdf_MD, FF_adversity_quart)


#cleaning up new demo variables
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3 Missing"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9 Not in wave"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 Skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -1.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -2.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -5.00] <- NA

 
#re-coding some of the categorical variables 
clusterdf_demo_MD_0 <- clusterdf_demo_MD_0 %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c("1 less hs") ~ 1,
                     mo_edu_wave0 %in% c("2 hs or equiv") ~ 2,
                     mo_edu_wave0 %in% c("3 some coll, tech") ~ 3,
                     mo_edu_wave0 %in% c("4 coll or grad") ~ 4)) %>% 
  mutate(mo_edu_wave1 =
           case_when(mo_edu_wave1 %in% c("1") ~ 1,
                     mo_edu_wave1 %in% c("2") ~ 2,
                     mo_edu_wave1 %in% c("3") ~ 3,
                     mo_edu_wave1 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave2 =
           case_when(mo_edu_wave2 %in% c("1") ~ 1,
                     mo_edu_wave2 %in% c("2") ~ 2,
                     mo_edu_wave2 %in% c("3") ~ 3,
                     mo_edu_wave2 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave3 =
           case_when(mo_edu_wave3 %in% c("1") ~ 1,
                     mo_edu_wave3 %in% c("2") ~ 2,
                     mo_edu_wave3 %in% c("3") ~ 3,
                     mo_edu_wave3 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave4 =
           case_when(mo_edu_wave4 %in% c("1") ~ 1,
                     mo_edu_wave4 %in% c("2") ~ 2,
                     mo_edu_wave4 %in% c("3") ~ 3,
                     mo_edu_wave4 %in% c("4") ~ 4)) 

clusterdf_demo_MD <- clusterdf_demo_MD_0

##IMPUTING SELECT MISSING DEMO DATA (only those that will be used in modeling)
#selecting variables to impute 
clusdf_select_MD <- bind_cols(clusterdf_demo_MD[4:7], clusterdf_demo_MD[9:12])

#imputing missing data for select demo/control variables
clusdf_select_MD_imp <- mice(data=clusdf_select_MD, m= 10, method = "pmm", 
                             print= F)

#examining imputed data
#head(complete(clusdf_select_MD_imp))

#creating an imputed data set
clusdf_select_MD_imp_comp <- complete(clusdf_select_MD_imp, "long", include = F)

#adding index for later grouping and generating avgs across imputed data sets
clusdf_select_MD_imp_comp$index <- rep(clusterdf_demo_MD$index, times= 10)

clusdf_select_MD_imp_comp <- clusdf_select_MD_imp_comp %>% 
  relocate(index, .before= .id)

#generating average value of imputed variables across the imputed data sets
demoMD_imp_avgs <- clusdf_select_MD_imp_comp %>% 
  group_by(index) %>% 
  summarise(round(mean(mo_edu_wave1)),
            round(mean(mo_edu_wave2)),
            round(mean(mo_edu_wave3)),
            round(mean(mo_edu_wave4)),
            round(mean(mo_hh_income_wave1)),
            round(mean(mo_hh_income_wave2)),
            round(mean(mo_hh_income_wave3)),
            round(mean(mo_hh_income_wave4)))
            
colnames(demoMD_imp_avgs) <- c("index","mo_edu_wave1", "mo_edu_wave2","mo_edu_wave3", 
                               "mo_edu_wave4", "mo_hh_income_wave1", "mo_hh_income_wave2",
                               "mo_hh_income_wave3", "mo_hh_income_wave4")

#creating new complete data set with imputed demographic/control variables
FF_MD_clus0 <- clusterdf_demo_MD %>% 
  subset(select = -c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                     mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                     mo_hh_income_wave4)) %>% 
  left_join(demoMD_imp_avgs, by= "index") 
  

#transforming education variable back to categorical and adding substantive labels 
FF_MD_clus <- FF_MD_clus0 %>% 
  mutate(mo_edu_wave0= case_when(mo_edu_wave0 %in% c(1) ~ "less hs",
                                 mo_edu_wave0 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave0 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave0 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave1= case_when(mo_edu_wave1 %in% c(1) ~ "less hs",
                                 mo_edu_wave1 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave1 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave1 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave2= case_when(mo_edu_wave2 %in% c(1) ~ "less hs",
                                 mo_edu_wave2 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave2 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave2 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave3= case_when(mo_edu_wave3 %in% c(1) ~ "less hs",
                                 mo_edu_wave3 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave3 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave3 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave4= case_when(mo_edu_wave4 %in% c(1) ~ "less hs",
                                 mo_edu_wave4 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave4 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave4 %in% c(4) ~ "coll or grad")) 

#logging hh income variable for modeling (adding one to address zeros)
FF_MD_clus <- FF_MD_clus %>% 
  mutate(hh_income_log= log(FF_MD_clus$mo_hh_income_wave0 +1)) 

#recoding education at baseline as ordinal factor for modeling
FF_MD_clus$mo_edu_wave0 <- factor(FF_MD_clus$mo_edu_wave0,
                                     levels=c("less hs",
                                              "hs or equiv",
                                              "some coll, tech",
                                              "coll or grad"))

#adding unordered version of cluster variables for multinomial regression & turning
#mother's race/ethnicity into unordered factor variable to set reference level
FF_MD_clus <- FF_MD_clus %>% 
  mutate(cluster_MD4_m= factor(FF_MD_clus$cluster_MD4, ordered = F)) %>%
  mutate(mo_race_eth= factor(FF_MD_clus$mo_race_eth, ordered = F))
```

### Generating Descriptive Table of Analytic Sample
```{r}
clusterdf_demo_MD_descrip <- clusterdf_demo_MD %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c(1) ~ "Less Than High School",
                     mo_edu_wave0 %in% c(2) ~ "High School or Equivalent",
                     mo_edu_wave0 %in% c(3) ~ "Some College/Technical School",
                     mo_edu_wave0 %in% c(4) ~ "College or Graduate School")) %>% 
  mutate(mo_race_eth =
           case_when(mo_race_eth %in% c("1 white, non-hispanic") ~ "White, Non-Hispanic",
                     mo_race_eth %in% c("2 black, non-hispanic") ~ "Black, Non-Hispanic",
                     mo_race_eth %in% c("3 hispanic") ~ "Hispanic",
                     mo_race_eth %in% c("4 other") ~ "Other Race/Ethnicity"))

descripMD <-  clusterdf_demo_MD_descrip %>% 
  dplyr::select(mo_race_eth, mo_edu_wave0, mo_hh_income_wave0, 
         mo_age_wave0, mo_married_wave0, mo_cohab_wave0)

descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "0"] <- "Not married"
descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "1"] <- "Married"

descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "0"] <- "Not Cohabitating"
descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "1"] <- "Cohabitating"

label(descripMD$mo_hh_income_wave0) <- "Mother's Annual Household Income at Baseline"
label(descripMD$mo_race_eth) <- "Race/Ethnicity"
label(descripMD$mo_edu_wave0) <- "Education at Baseline"
label(descripMD$mo_married_wave0) <- "Mother Married to Bio Dad at Baseline"
label(descripMD$mo_cohab_wave0) <- "Mother Cohabitating w/ Bio Dad at Baseline"
label(descripMD$mo_age_wave0) <- "Age at Birth of Focal Child"

descripMD_table <- table1(~mo_race_eth + 
                          mo_edu_wave0 + mo_age_wave0 + mo_hh_income_wave0 +
                          mo_married_wave0 + mo_cohab_wave0, 
                        data = descripMD)
descripMD_table
# png("Sample_Table.png", width = 550, height = 550)
# tableGrob(descripMD_table)
# dev.off()

# #png("Sample_Table.png", width = 550, height = 550)
# apa_table(descripMD_table)
# #dev.off()

```

### Modeling w/ IDCD Clusters (MULTINOMINAL)
```{r}
##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the very low adversity cluster [3 clusters]
FF_MD_clus$cluster_MD4_m <- relevel(FF_MD_clus$cluster_MD4_m,
                                      ref = "Consistently Very Low Adversity (0-1 Domains)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

## MODEL 1
# mother's race as sole predictor model
mod1_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD4)

z_mod1_MD4 <- summary(mod1_MD4)$coefficients/summary(mod1_MD4)$standard.errors
p_mod1_MD4 <- (1 - pnorm(abs(z_mod1_MD4), 0, 1)) * 2
p_mod1_MD4

## MODEL 2
# mother's race as predictor w/ education, income, and age of mother at focal child's
# birth as covariates
mod2_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth +
                                     hh_income_log + mo_edu_wave0 +
                                     mo_age_wave0,
                                   data = FF_MD_clus)

summary(mod2_MD4)

z_mod2_MD4 <- summary(mod2_MD4)$coefficients/summary(mod2_MD4)$standard.errors
p_mod2_MD4 <- (1 - pnorm(abs(z_mod2_MD4), 0, 1)) * 2
p_mod2_MD4
```

#### Multinomial Regression Table
```{r, results='asis', warning=FALSE}
stargazer(mod1_MD4, mod2_MD4,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          dep.var.labels = c("Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity",
                             "Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity"),
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Household Income (Logged)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "-10pt",
          notes.append = F,
          type = "html")
```



# SENSITIVITY CHECK: Imputation Where Highest Quintile Dropped Using PMM (m=10)
```{r}
set.seed(08540)
FF_adv_quint_with_predictors <- FF_adversity_FULL[,c(1:60)] %>% 
  dplyr::select(-c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                   mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                   mo_hh_income_wave4)) %>% 
  mutate(index= FF_adversity_FULL$index) %>% 
  right_join(data.frame(index= caselevel_na_quint$index), by= "index") 

FF_adv.comp_quint <- readRDS("FF_adv_imp_car_hou_socnet_3902_withpred_R%R#2.rds")

# #imputing missing data
# FF_adv_quint_with_predictors.imp <- mice(data = FF_adv_quint_with_predictors, m= 10,
#                                    method = "pmm", print= FALSE,
#                                    remove.collinear = FALSE)
# 
# #examining imputed data
# head(complete(FF_adv_quint_with_predictors.imp))
# 
# ##creating an imputed data set
# FF_adv.comp_quint <- complete(FF_adv_quint_with_predictors.imp, "long", include = F)
# 
# FF_adv_imp_car_hou_socnet_3902_with_predictors <- saveRDS(FF_adv.comp_quint,
#                                           file = "FF_adv_imp_car_hou_socnet_3902_withpred_R%R#2.rds")

```

## [CARCERAL SYSTEM] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under carceral system domain
carceral_domain <- FF_adv.comp_quint %>% 
  dplyr::select(ends_with(c("fjail", "rjail","fprobs"))) %>% 
  mutate(imp=FF_adv.comp_quint$.imp) 

#wave 1
c_domain_w1 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

c_domain_w1_sums_FULL <- as.data.frame(rowSums(c_domain_w1[,c(2:4)]))

#wave 2
c_domain_w2 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

c_domain_w2_sums_FULL <- as.data.frame(rowSums(c_domain_w2[,c(2:4)]))

#wave 3
c_domain_w3 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

c_domain_w3_sums_FULL <- as.data.frame(rowSums(c_domain_w3[,c(2:4)]))

#wave 4
c_domain_w4 <- carceral_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

c_domain_w4_sums_FULL <- as.data.frame(rowSums(c_domain_w4[,c(2:4)]))

 
##creating a data set with the Summated scores  
c_dom_sums_FULL <- bind_cols(c_domain_w1_sums_FULL, c_domain_w2_sums_FULL, 
                             c_domain_w3_sums_FULL, c_domain_w4_sums_FULL) 

c_dom_sums_FULL$index <- rep(caselevel_na_quint$index, rep= 10)

colnames(c_dom_sums_FULL) <- c("wave1_cdom_sums_FULL", "wave2_cdom_sums_FULL",  
                               "wave3_cdom_sums_FULL", "wave4_cdom_sums_FULL", 
                               "index") 
 
c_dom_sums_FULL <- c_dom_sums_FULL %>%  
  relocate(index, .before= wave1_cdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_quint$.imp) %>%  
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
cdom_wave1avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave1_cdom_sums_FULL)")

cdom_wave2avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave2_cdom_sums_FULL)")

cdom_wave3avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave3_cdom_sums_FULL)")

cdom_wave4avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_cdom_sums_FULL)) %>% 
  dplyr::select("mean(wave4_cdom_sums_FULL)")

 
cdom_allwaves_avg_FULL <- bind_cols(caselevel_na_quint$index, cdom_wave1avg, cdom_wave2avg,  
                               cdom_wave3avg, cdom_wave4avg) 
 
colnames(cdom_allwaves_avg_FULL) <- c("index", "cdom_avg1", "cdom_avg2",  
                                      "cdom_avg3", "cdom_avg4") 
 
#converting into binary states 
cdom_allwaves_avg_cat_FULL <- cdom_allwaves_avg_FULL %>%  
  mutate(cdomw1_cat= case_when(cdom_avg1 == 0  ~ "carceral_no", 
                              cdom_avg1 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw2_cat= case_when(cdom_avg2 == 0  ~ "carceral_no",  
                              cdom_avg2 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw3_cat= case_when(cdom_avg3 == 0  ~ "carceral_no", 
                              cdom_avg3 > 0 ~ "carceral_yes")) %>%  
  mutate(cdomw4_cat= case_when(cdom_avg4 == 0  ~ "carceral_no", 
                              cdom_avg4 > 0 ~ "carceral_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
#wave 1
rel_c_domain_w1<- c_domain_w1 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(w1_fjail= mean(wave1_fjail),
            w1_fprobs= mean(wave1_fprobs),
            w1_feverjail= mean(wave1_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w1_fjail= ifelse(w1_fjail>0, 1, 0)) %>% 
  mutate(w1_fprobs= ifelse(w1_fprobs>0, 1, 0)) %>% 
  mutate(w1_feverjail= ifelse(w1_feverjail>0, 1, 0))

#wave 2
rel_c_domain_w2<- c_domain_w2 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(w2_fjail= mean(wave2_fjail),
            w2_fprobs= mean(wave2_fprobs),
            w2_feverjail= mean(wave2_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w2_fjail= ifelse(w2_fjail>0, 1, 0)) %>% 
  mutate(w2_fprobs= ifelse(w2_fprobs>0, 1, 0)) %>% 
  mutate(w2_feverjail= ifelse(w2_feverjail>0, 1, 0))

#wave 3
rel_c_domain_w3<- c_domain_w3 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(w3_fjail= mean(wave3_fjail),
            w3_fprobs= mean(wave3_fprobs),
            w3_feverjail= mean(wave3_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w3_fjail= ifelse(w3_fjail>0, 1, 0)) %>% 
  mutate(w3_fprobs= ifelse(w3_fprobs>0, 1, 0)) %>% 
  mutate(w3_feverjail= ifelse(w3_feverjail>0, 1, 0))

#wave 4
rel_c_domain_w4<- c_domain_w4 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(w4_fjail= mean(wave4_fjail),
            w4_fprobs= mean(wave4_fprobs),
            w4_feverjail= mean(wave4_feverjail)) %>% 
  subset(select = -c(index)) %>% 
  mutate(w4_fjail= ifelse(w4_fjail>0, 1, 0)) %>% 
  mutate(w4_fprobs= ifelse(w4_fprobs>0, 1, 0)) %>% 
  mutate(w4_feverjail= ifelse(w4_feverjail>0, 1, 0))


alpha_carceral_w1 <- data.frame(raw_alpha= alpha(rel_c_domain_w1)$total$raw_alpha) 
alpha_carceral_w2 <- data.frame(raw_alpha= alpha(rel_c_domain_w2)$total$raw_alpha)
alpha_carceral_w3 <- data.frame(raw_alpha= alpha(rel_c_domain_w3)$total$raw_alpha)
alpha_carceral_w4 <- data.frame(raw_alpha= alpha(rel_c_domain_w4)$total$raw_alpha)

alpha_carceral <- rbind(alpha_carceral_w1,
                      alpha_carceral_w2,
                      alpha_carceral_w3,
                      alpha_carceral_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")
```



## [HOUSING] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under housing system domain
housing_domain <- FF_adv.comp_quint %>% 
  dplyr::select(ends_with(c("evict", "nonreghouse", "moneymove",
                     "gaselec", "tele"))) %>%
  mutate(imp=FF_adv.comp_quint$.imp) 

#wave 1
ho_domain_w1 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

ho_domain_w1_sums_FULL <- as.data.frame(rowSums(ho_domain_w1[,c(2:6)]))

#wave 2
ho_domain_w2 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

ho_domain_w2_sums_FULL <- as.data.frame(rowSums(ho_domain_w2[,c(2:6)]))

#wave 3
ho_domain_w3 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

ho_domain_w3_sums_FULL <- as.data.frame(rowSums(ho_domain_w3[,c(2:6)]))

#wave 4
ho_domain_w4 <- housing_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

ho_domain_w4_sums_FULL <- as.data.frame(rowSums(ho_domain_w4[,c(2:6)]))
 
##creating a data set with the Summatedd scores  
ho_dom_sums_FULL <- bind_cols(ho_domain_w1_sums_FULL, ho_domain_w2_sums_FULL, 
                             ho_domain_w3_sums_FULL, ho_domain_w4_sums_FULL)

ho_dom_sums_FULL$index <- rep(caselevel_na_quint$index, rep= 10) 
 
colnames(ho_dom_sums_FULL) <- c("wave1_hodom_sums_FULL", "wave2_hodom_sums_FULL",  
                               "wave3_hodom_sums_FULL", "wave4_hodom_sums_FULL", 
                               "index") 
 
ho_dom_sums_FULL <- ho_dom_sums_FULL %>%  
  relocate(index, .before= wave1_hodom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_quint$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
hodom_wave1avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_hodom_sums_FULL)") 
 
hodom_wave2avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_hodom_sums_FULL)") 
 
hodom_wave3avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_hodom_sums_FULL)") 
 
hodom_wave4avg <- ho_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_hodom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_hodom_sums_FULL)") 
 
hodom_allwaves_avg_FULL <- bind_cols(caselevel_na_quint$index, hodom_wave1avg, hodom_wave2avg,  
                               hodom_wave3avg, hodom_wave4avg) 
 
colnames(hodom_allwaves_avg_FULL) <- c("index", "hodom_avg1", "hodom_avg2",  
                                      "hodom_avg3", "hodom_avg4") 
 
#converting into binary states 
hodom_allwaves_avg_cat_FULL <- hodom_allwaves_avg_FULL %>%  
  mutate(hodomw1_cat= case_when(hodom_avg1 == 0  ~ "house_no", 
                              hodom_avg1 > 0 ~ "house_yes")) %>%  
  mutate(hodomw2_cat= case_when(hodom_avg2 == 0  ~ "house_no",  
                              hodom_avg2 > 0 ~ "house_yes")) %>%  
  mutate(hodomw3_cat= case_when(hodom_avg3 == 0  ~ "house_no", 
                              hodom_avg3 > 0 ~ "house_yes")) %>%  
  mutate(hodomw4_cat= case_when(hodom_avg4 == 0  ~ "house_no", 
                              hodom_avg4 > 0 ~ "house_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_hou_domain_w1<- ho_domain_w1 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(wave1_evict= mean(wave1_evict),
            wave1_nonreghouse= mean(wave1_nonreghouse),
            wave1_moneymove= mean(wave1_moneymove),
            wave1_gaselec= mean(wave1_gaselec),
            wave1_tele= mean(wave1_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_evict= ifelse(wave1_evict>0, 1, 0)) %>% 
  mutate(wave1_nonreghouse= ifelse(wave1_nonreghouse>0, 1, 0)) %>% 
  mutate(wave1_moneymove= ifelse(wave1_moneymove>0, 1, 0)) %>% 
  mutate(wave1_gaselec= ifelse(wave1_gaselec>0, 1, 0)) %>% 
  mutate(wave1_tele= ifelse(wave1_tele>0, 1, 0))

rel_hou_domain_w2<- ho_domain_w2 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(wave2_evict= mean(wave2_evict),
            wave2_nonreghouse= mean(wave2_nonreghouse),
            wave2_moneymove= mean(wave2_moneymove),
            wave2_gaselec= mean(wave2_gaselec),
            wave2_tele= mean(wave2_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_evict= ifelse(wave2_evict>0, 1, 0)) %>% 
  mutate(wave2_nonreghouse= ifelse(wave2_nonreghouse>0, 1, 0)) %>% 
  mutate(wave2_moneymove= ifelse(wave2_moneymove>0, 1, 0)) %>% 
  mutate(wave2_gaselec= ifelse(wave2_gaselec>0, 1, 0)) %>% 
  mutate(wave2_tele= ifelse(wave2_tele>0, 1, 0))


rel_hou_domain_w3<- ho_domain_w3 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(wave3_evict= mean(wave3_evict),
            wave3_nonreghouse= mean(wave3_nonreghouse),
            wave3_moneymove= mean(wave3_moneymove),
            wave3_gaselec= mean(wave3_gaselec),
            wave3_tele= mean(wave3_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_evict= ifelse(wave3_evict>0, 1, 0)) %>% 
  mutate(wave3_nonreghouse= ifelse(wave3_nonreghouse>0, 1, 0)) %>% 
  mutate(wave3_moneymove= ifelse(wave3_moneymove>0, 1, 0)) %>% 
  mutate(wave3_gaselec= ifelse(wave3_gaselec>0, 1, 0)) %>% 
  mutate(wave3_tele= ifelse(wave3_tele>0, 1, 0))

rel_hou_domain_w4<- ho_domain_w4 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(wave4_evict= mean(wave4_evict),
            wave4_nonreghouse= mean(wave4_nonreghouse),
            wave4_moneymove= mean(wave4_moneymove),
            wave4_gaselec= mean(wave4_gaselec),
            wave4_tele= mean(wave4_tele)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_evict= ifelse(wave4_evict>0, 1, 0)) %>% 
  mutate(wave4_nonreghouse= ifelse(wave4_nonreghouse>0, 1, 0)) %>% 
  mutate(wave4_moneymove= ifelse(wave4_moneymove>0, 1, 0)) %>% 
  mutate(wave4_gaselec= ifelse(wave4_gaselec>0, 1, 0)) %>% 
  mutate(wave4_tele= ifelse(wave4_tele>0, 1, 0))


alpha_hou_w1 <- data.frame(raw_alpha= alpha(rel_hou_domain_w1)$total$raw_alpha) 
alpha_hou_w2 <- data.frame(raw_alpha= alpha(rel_hou_domain_w2)$total$raw_alpha)
alpha_hou_w3 <- data.frame(raw_alpha= alpha(rel_hou_domain_w3)$total$raw_alpha)
alpha_hou_w4 <- data.frame(raw_alpha= alpha(rel_hou_domain_w4)$total$raw_alpha)

alpha_hou <- rbind(alpha_hou_w1,
                      alpha_hou_w2,
                      alpha_hou_w3,
                      alpha_hou_w4) %>% 
  mutate(Wave= c("Wave 1 (Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```


## [SOCIAL NETWORK] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under social network domain
socnet_domain <- FF_adv.comp_quint %>% 
  dplyr::select(ends_with(c("emcare", "1kloan", "200loan",
                     "1kcosign"))) %>%
  mutate(imp=FF_adv.comp_quint$.imp) 

#wave 1
net_domain_w1 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave1"))

net_domain_w1_sums_FULL <- as.data.frame(rowSums(net_domain_w1[,c(2:5)]))

#wave 2
net_domain_w2 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave2"))

net_domain_w2_sums_FULL <- as.data.frame(rowSums(net_domain_w2[,c(2:5)]))

#wave 3
net_domain_w3 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave3"))

net_domain_w3_sums_FULL <- as.data.frame(rowSums(net_domain_w3[,c(2:5)]))

#wave 4
net_domain_w4 <- socnet_domain %>% 
  group_by(imp) %>% 
  dplyr::select(starts_with("wave4"))

net_domain_w4_sums_FULL <- as.data.frame(rowSums(net_domain_w4[,c(2:5)]))

 
##creating a data set with the Summatedd scores  
net_dom_sums_FULL <- bind_cols(net_domain_w1_sums_FULL, net_domain_w2_sums_FULL, 
                             net_domain_w3_sums_FULL, net_domain_w4_sums_FULL) 
net_dom_sums_FULL$index <- rep(caselevel_na_quint$index, rep= 10) 
 
colnames(net_dom_sums_FULL) <- c("wave1_netdom_sums_FULL", "wave2_netdom_sums_FULL",  
                               "wave3_netdom_sums_FULL", "wave4_netdom_sums_FULL",  
                               "index") 
 
net_dom_sums_FULL <- net_dom_sums_FULL %>%  
  relocate(index, .before= wave1_netdom_sums_FULL) %>%  
  mutate(imp= FF_adv.comp_quint$.imp) %>%  
  relocate(imp, .before= index) 
 
#getting average score for each observation across imputed data sets 
netdom_wave1avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave1_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave1_netdom_sums_FULL)") 
 
netdom_wave2avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave2_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave2_netdom_sums_FULL)") 
 
netdom_wave3avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave3_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave3_netdom_sums_FULL)") 
 
netdom_wave4avg <- net_dom_sums_FULL  %>%  
  group_by(index) %>%  
  summarise(mean(wave4_netdom_sums_FULL)) %>%  
  dplyr::select("mean(wave4_netdom_sums_FULL)") 
 
netdom_allwaves_avg_FULL <- bind_cols(caselevel_na_quint$index, netdom_wave1avg, netdom_wave2avg,  
                               netdom_wave3avg, netdom_wave4avg) 
 
colnames(netdom_allwaves_avg_FULL) <- c("index", "netdom_avg1", "netdom_avg2",  
                                      "netdom_avg3", "netdom_avg4") 
 
#converting into binary states 
netdom_allwaves_avg_cat_FULL <- netdom_allwaves_avg_FULL %>%  
  mutate(netdomw1_cat= case_when(netdom_avg1 == 0  ~ "socnetwork_no", 
                              netdom_avg1 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw2_cat= case_when(netdom_avg2 == 0  ~ "socnetwork_no",  
                              netdom_avg2 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw3_cat= case_when(netdom_avg3 == 0  ~ "socnetwork_no", 
                              netdom_avg3 > 0 ~ "socnetwork_yes")) %>%  
  mutate(netdomw4_cat= case_when(netdom_avg4 == 0  ~ "socnetwork_no", 
                              netdom_avg4 > 0 ~ "socnetwork_yes")) 
```

### Assessing Internal Consistency (i.e., w/ a Reliability Coefficient)
```{r}
rel_net_domain_w1<- net_domain_w1 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(wave1_emcare= mean(wave1_emcare),
            wave1_1kloan= mean(wave1_1kloan),
            wave1_200loan= mean(wave1_200loan),
            wave1_1kcosign= mean(wave1_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave1_emcare= ifelse(wave1_emcare>0, 1, 0)) %>% 
  mutate(wave1_1kloan= ifelse(wave1_1kloan>0, 1, 0)) %>% 
  mutate(wave1_200loan= ifelse(wave1_200loan>0, 1, 0)) %>% 
  mutate(wave1_1kcosign= ifelse(wave1_1kcosign>0, 1, 0)) 


rel_net_domain_w2<- net_domain_w2 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(wave2_emcare= mean(wave2_emcare),
            wave2_1kloan= mean(wave2_1kloan),
            wave2_200loan= mean(wave2_200loan),
            wave2_1kcosign= mean(wave2_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave2_emcare= ifelse(wave2_emcare>0, 1, 0)) %>% 
  mutate(wave2_1kloan= ifelse(wave2_1kloan>0, 1, 0)) %>% 
  mutate(wave2_200loan= ifelse(wave2_200loan>0, 1, 0)) %>% 
  mutate(wave2_1kcosign= ifelse(wave2_1kcosign>0, 1, 0)) 


rel_net_domain_w3<- net_domain_w3 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(wave3_emcare= mean(wave3_emcare),
            wave3_1kloan= mean(wave3_1kloan),
            wave3_200loan= mean(wave3_200loan),
            wave3_1kcosign= mean(wave3_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave3_emcare= ifelse(wave3_emcare>0, 1, 0)) %>% 
  mutate(wave3_1kloan= ifelse(wave3_1kloan>0, 1, 0)) %>% 
  mutate(wave3_200loan= ifelse(wave3_200loan>0, 1, 0)) %>% 
  mutate(wave3_1kcosign= ifelse(wave3_1kcosign>0, 1, 0)) 

rel_net_domain_w4<- net_domain_w4 %>% 
  mutate(index= caselevel_na_quint$index) %>% 
  group_by(index) %>%  
  summarise(wave4_emcare= mean(wave4_emcare),
            wave4_1kloan= mean(wave4_1kloan),
            wave4_200loan= mean(wave4_200loan),
            wave4_1kcosign= mean(wave4_1kcosign)) %>% 
  subset(select = -c(index)) %>% 
  mutate(wave4_emcare= ifelse(wave4_emcare>0, 1, 0)) %>% 
  mutate(wave4_1kloan= ifelse(wave4_1kloan>0, 1, 0)) %>% 
  mutate(wave4_200loan= ifelse(wave4_200loan>0, 1, 0)) %>% 
  mutate(wave4_1kcosign= ifelse(wave4_1kcosign>0, 1, 0)) 

# alpha(rel_net_domain_w1)
# alpha(rel_net_domain_w2)
# alpha(rel_net_domain_w3)
# alpha(rel_net_domain_w4)

alpha_net_w1 <- data.frame(raw_alpha= alpha(rel_net_domain_w1)$total$raw_alpha) 
alpha_net_w2 <- data.frame(raw_alpha= alpha(rel_net_domain_w2)$total$raw_alpha)
alpha_net_w3 <- data.frame(raw_alpha= alpha(rel_net_domain_w3)$total$raw_alpha)
alpha_net_w4 <- data.frame(raw_alpha= alpha(rel_net_domain_w4)$total$raw_alpha)

alpha_socnet <- rbind(alpha_net_w1,
                      alpha_net_w2,
                      alpha_net_w3,
                      alpha_net_w4) %>% 
  mutate(Wave= c("Wave 1(Y1)",
                 "Wave 2 (Y3)",
                 "Wave 3 (Y5)",
                 "Wave 4 (Y9)")) %>% 
  relocate(Wave, .before = "raw_alpha")

```

## Table of Alphas for All Three Domains
```{r}
alpha_all_domains <- cbind(alpha_carceral, alpha_hou$raw_alpha, alpha_socnet$raw_alpha) 

colnames(alpha_all_domains) <- c("Wave" ,"Carceral", "Housing", "Social Network")

alpha_all_domains %>% 
  summarise_all(mean)

alpha_all_domains <- alpha_all_domains %>% 
  mutate_if(is.numeric, round, digits= 2)

alpha_all_domains

# png("MD_alphas_table.png", width = 550, height = 550)  
# #dev.off() 

# kable(alpha_all_domains) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "alpha_all_domain.html")

```


## Creating Sequences with Composite Scores
```{r}
## cleaning dataframes for defining  
carceral_traj <- cdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("cdomw")) 

housing_traj <- hodom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("hodomw")) 
 
socnet_traj <- netdom_allwaves_avg_cat_FULL %>%  
  dplyr::select(starts_with("netdomw")) 
 
##defining sequence objects for each domain 
 
#carceral system 
cdom_alphabet <- c("carceral_yes", "carceral_no") 
cdom_labs <- c("carceral_yes", "carceral_no") 
 
colnames(carceral_traj)[1] <- "Wave 1 (Y1)" 
colnames(carceral_traj)[2] <- "Wave 2 (Y3)" 
colnames(carceral_traj)[3] <- "Wave 3 (Y5)" 
colnames(carceral_traj)[4] <- "Wave 4 (Y9)" 

seqcar <- seqdef(carceral_traj, 
                 var = 1:4, 
                 alphabet = cdom_alphabet, 
                 labels=cdom_labs, 
                 xstep= 1 ) 

#housing system 
hodom_alphabet <- c("house_yes", "house_no") 
hodom_labs <- c("house_yes", "house_no") 
 
colnames(housing_traj)[1] <- "Wave 1 (Y1)" 
colnames(housing_traj)[2] <- "Wave 2 (Y3)" 
colnames(housing_traj)[3] <- "Wave 3 (Y5)" 
colnames(housing_traj)[4] <- "Wave 4 (Y9)" 

seqhou <- seqdef(housing_traj, 
                 var = 1:4, 
                 alphabet = hodom_alphabet, 
                 labels=hodom_labs, 
                 xstep= 1) 
 
#social network 
netdom_alphabet <- c("socnetwork_yes", "socnetwork_no") 
netdom_labs <- c("socnetwork_yes", "socnetwork_no") 
 
colnames(socnet_traj)[1] <- "Wave 1 (Y1)" 
colnames(socnet_traj)[2] <- "Wave 2 (Y3)" 
colnames(socnet_traj)[3] <- "Wave 3 (Y5)" 
colnames(socnet_traj)[4] <- "Wave 4 (Y9)" 

seqsocnet <- seqdef(socnet_traj, 
                 var = 1:4, 
                 alphabet = netdom_alphabet, 
                 labels=netdom_labs, 
                 xstep= 1) 

 
## Calculating Distance/Dissimilarity Matrix [OM] 
 
#carceral system 
carceral_distOM <- seqdist(seqcar, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#housing 
housing_distOM <- seqdist(seqhou, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
#social network 
socnet_distOM <- seqdist(seqsocnet, 
                         method = "OM", 
                         indel = 1.0, 
                         sm = "INDELSLOG", 
                         with.missing = TRUE) 
 
```


## Measuring Strength of Association at Domain & State Levels
```{r}
##at state level (testing whether CAT could be used) 
state_assoc <- seqdomassoc(list(seqcar, seqhou, seqsocnet), 
            rep.method = "overall", 
            assoc = "V", 
            p.value = T, 
            struct.zero = F, 
            cross.table = T, 
            with.missing = F, 
            weighted = F, 
            dnames = c("Carceral", "Housing", "Soc Network")) 
state_assoc

state_assoc_df <- state_assoc[,c(2, 3)] %>% 
  as.data.frame() 

 
##at sequence level (testing whether DAT could be used) 
dom_assoc <- dissdomassoc(list(carceral_distOM, housing_distOM, socnet_distOM), 
             what = "pearson", 
             dnames = c("Carceral", "Housing", "Soc Network")) 
dom_assoc$p.pearson

state_dom_assoc_table <- state_assoc_df %>% 
  mutate(`Pearson's r`= c(dom_assoc$Pearson[1,2], dom_assoc$Pearson[1,3],
                          dom_assoc$Pearson[3,2])) %>% 
  mutate(`p(r)`= c(dom_assoc$p.pearson[1,2], dom_assoc$p.pearson[1,3],
                          dom_assoc$p.pearson[3,2])) %>% 
  mutate_all(round, digits=3)%>% 
  rownames_to_column("Domain Pairs") %>% 
  mutate(`Domain Pairs` = c("Carceral with Housing", "Carceral with Social Network",
                            "Housing with Social Network"))

state_dom_assoc_table

# kable(state_dom_assoc_table) %>%
#   kable_classic(full_width= F, html_font = "Times New Roman") %>%
#   save_kable(file = "state_dom_assoc_table.html")


```


## Creating/Plotting Multidomain Sequences
```{r}
#creating MD sequence df (to ensure proper alphabet)
MDseq <- list(seqcar, seqhou, seqsocnet) %>% 
  as.data.frame() 

colnames(MDseq) <- c("wave1_car", "wave2_car", "wave3_car", "wave4_car",
                     "wave1_hou", "wave2_hou", "wave3_hou", "wave4_hou",
                     "wave1_socnet", "wave2_socnet", "wave3_socnet", "wave4_socnet")
  
MDseq$wave1 <- paste(MDseq$wave1_car, "+", MDseq$wave1_hou, "+", MDseq$wave1_socnet)
MDseq$wave2 <- paste(MDseq$wave2_car, "+", MDseq$wave2_hou, "+", MDseq$wave2_socnet)
MDseq$wave3 <- paste(MDseq$wave3_car, "+", MDseq$wave3_hou, "+", MDseq$wave3_socnet)
MDseq$wave4 <- paste(MDseq$wave4_car, "+", MDseq$wave4_hou, "+", MDseq$wave4_socnet)

MDseq <- MDseq[, c(13:16)]

MDseq <- seqdef(MDseq,
       alphabet = c("carceral_no + house_no + socnetwork_no", "carceral_no + house_no + socnetwork_yes",
                    "carceral_no + house_yes + socnetwork_no", "carceral_yes + house_no + socnetwork_no",
                    "carceral_no + house_yes + socnetwork_yes", "carceral_yes + house_no + socnetwork_yes",
                     "carceral_yes + house_yes + socnetwork_no", "carceral_yes + house_yes + socnetwork_yes"),
       labels = c("carceral_no+house_no+socnetwork_no", "carceral_no+house_no+socnetwork_yes",
                    "carceral_no+house_yes+socnetwork_no", "carceral_yes+house_no+socnetwork_no",
                    "carceral_no+house_yes+socnetwork_yes", "carceral_yes+house_no+socnetwork_yes",
                     "carceral_yes+house_yes+socnetwork_no", "carceral_yes+house_yes+socnetwork_yes"),
       xtstep = 1)
 
#png("basic_MD_plot_R&R.png", width = 2000, height = 2000, res = 600)
seq_plot_MD <- seqplot(MDseq, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"), ylab = NA, border = NA, cex.legend = .5)
#dev.off()
```


## Cluster Analysis (IDCD Approach)

### Clustering MD sequences
```{r}
# Setting MD Costs/Distances 
MD_dist <- seqdistmc(list(seqcar, seqhou, seqsocnet), 
                     method= "OM", 
                     indel= 1, 
                     sm= "INDELSLOG") 
 
# conducting hierarchical cluster analysis (ward-d2) 
MD_clus <- agnes(MD_dist, diss = T, method = "ward") 

# storing clustering solution
# MD_clus_car_hou_socnet_4877 <- saveRDS(MD_clus, 
#                                           file = "MD_clus_car_hou_socnet_4877_RR#2.rds")

# png("dendrogram_final.png", width=7000, height=4000, res = 800)
# plot(MD_clus)
# rect.hclust(MD_clus, k= 3)
# #dev.off()
```


### Determining Number of Clusters: Cluster Quality Metrics
```{r}
clus_quality_table <- as.clustrange(MD_clus, diss = MD_dist, ncluster = 6) 

#generating evaluation plot
# png("MD_Eval_plots.png",width=8000, height=5000, res = 800, pointsize = 14)
clus_plot <- plot(clus_quality_table, stat = c("ASW", "HC", "CH", "PBC"), 
     norm= "zscore", legendpos= "topright", lwd=2) 
abline(v= 4,col= "red")
# dev.off()
```

### Determining Number of Clusters: Visualizing Different Numbers of Clusters
```{r}
## FOR SIX GROUPS ##  
MD_cut6 <- cutree(MD_clus, k= 6)  
MD_cut_fac6 <- factor(MD_cut6, levels = c(3, 2, 5, 6, 1, 4),
                     labels = paste("Type", 1:6))
 
 
#png("MDcluster_plot6.png", width=7000, height=5000, res = 900, pointsize = 9)  
seqplot(MDseq, group = MD_cut6, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1.2, 
        rows = 2, 
        cols = 3)  
#dev.off()  
 
## FOR FIVE GROUPS ##  
MD_cut5 <- cutree(MD_clus, k= 5)  
MD_cut_fac5 <- factor(MD_cut5, levels = c(3, 2, 5, 1, 4), 
                      labels = paste("Type", 1:5))

 
#png("MDcluster_plot5.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut5, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8,
        rows = 2,
        cols = 3)  
#dev.off()  
 
## FOR FOUR GROUPS ##  
MD_cut4 <- cutree(MD_clus, k= 4)  
# MD_cut_fac4 <- factor(MD_cut4, labels = paste("Type", 1:4))  
MD_cut_fac4 <- factor(MD_cut4, levels = c(3, 2, 4, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Enduring Material Social Network Adversity (1 Domain)",
                                 "Enduring Carceral Adversity (1-3 Domains)",
                                 "Consistently Very High Adversity (3 Domains)"),
                                 ordered = TRUE)
 
 
#png("MDcluster_plot4.png", width = 550, height = 550)  
seqplot(MDseq, group = MD_cut4, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = .8, rows = 2, cols = 4)  
#dev.off()  

## FOR THREE GROUPS ##  
MD_cut3 <- cutree(MD_clus, k= 3)  
#MD_cut_fac3 <- factor(MD_cut3, labels = paste("Type", 1:3))
MD_cut_fac3 <- factor(MD_cut3, levels= c(3, 2, 1),
                      labels = c("Consistently Very Low Adversity (0-1 Domains)",
                                 "Progressively Worsening Adversity (1-2 Domains)",
                                 "Consistently Moderate to High Adversity (2-3 Domains)"),
                      ordered = TRUE)


 
#png("MDcluster_plot3.png", width = 6500, height = 4000, res = 800)  
seqplot(MDseq, group = MD_cut3, type="d",   
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),  
        sortv = "from.start",   
        with.legend = T, border = NA, cex.legend = 1,
        rows = 1,
        cols = 3)  
#dev.off()  
```

### Cluster Visualization (4 clusters)
```{r}
##DISTRUBUTION PLOT
png("MDcluster_plot4_dist_quint.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="d",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1.1,
        rows = 2,
        cols = 2)
dev.off()

#SEQUENCE INDEX PLOT
png("MDcluster_plot4_seqindex_quint.png", width=4000, height=4000, res = 800, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac4, type="I",
        cpal= c("forestgreen","yellow", "yellow2", "yellow4", "orange","darkorange1",
                "orange4", "red"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        rows = 2,
        cols = 2)
dev.off()
```

## MODELING W/ MD CLUSTERS

### Data Cleaning, Imputing, and Wrangling
```{r}
set.seed(08540)
##PREPPING DATA
#creating outcome variable with the cluster assignments for each observation/sequence
clusterdf_MD <- data.frame(cluster_MD4= MD_cut_fac4) 

FF_adversity_quint <- FF_adversity_FULL[,c(49:64)] %>% 
  right_join(data.frame(index= caselevel_na_quint$index), by= "index") 
  
#adding demographic variables to data frame
clusterdf_demo_MD_0 <- bind_cols(clusterdf_MD, FF_adversity_quint)


#cleaning up new demo variables
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3 Missing"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-3"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9 Not in wave"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-9"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6 Skip"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == "-6"] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -1.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -2.00] <- NA
clusterdf_demo_MD_0[clusterdf_demo_MD_0 == -5.00] <- NA

 
#re-coding some of the categorical variables 
clusterdf_demo_MD_0 <- clusterdf_demo_MD_0 %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c("1 less hs") ~ 1,
                     mo_edu_wave0 %in% c("2 hs or equiv") ~ 2,
                     mo_edu_wave0 %in% c("3 some coll, tech") ~ 3,
                     mo_edu_wave0 %in% c("4 coll or grad") ~ 4)) %>% 
  mutate(mo_edu_wave1 =
           case_when(mo_edu_wave1 %in% c("1") ~ 1,
                     mo_edu_wave1 %in% c("2") ~ 2,
                     mo_edu_wave1 %in% c("3") ~ 3,
                     mo_edu_wave1 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave2 =
           case_when(mo_edu_wave2 %in% c("1") ~ 1,
                     mo_edu_wave2 %in% c("2") ~ 2,
                     mo_edu_wave2 %in% c("3") ~ 3,
                     mo_edu_wave2 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave3 =
           case_when(mo_edu_wave3 %in% c("1") ~ 1,
                     mo_edu_wave3 %in% c("2") ~ 2,
                     mo_edu_wave3 %in% c("3") ~ 3,
                     mo_edu_wave3 %in% c("4") ~ 4)) %>% 
  mutate(mo_edu_wave4 =
           case_when(mo_edu_wave4 %in% c("1") ~ 1,
                     mo_edu_wave4 %in% c("2") ~ 2,
                     mo_edu_wave4 %in% c("3") ~ 3,
                     mo_edu_wave4 %in% c("4") ~ 4)) 

clusterdf_demo_MD <- clusterdf_demo_MD_0

##IMPUTING SELECT MISSING DEMO DATA (only those that will be used in modeling)
#selecting variables to impute 
clusdf_select_MD <- bind_cols(clusterdf_demo_MD[4:7], clusterdf_demo_MD[9:12])

#imputing missing data for select demo/control variables
clusdf_select_MD_imp <- mice(data=clusdf_select_MD, m= 10, method = "pmm", 
                             print= F)

#examining imputed data
#head(complete(clusdf_select_MD_imp))

#creating an imputed data set
clusdf_select_MD_imp_comp <- complete(clusdf_select_MD_imp, "long", include = F)

#adding index for later grouping and generating avgs across imputed data sets
clusdf_select_MD_imp_comp$index <- rep(clusterdf_demo_MD$index, times= 10)

clusdf_select_MD_imp_comp <- clusdf_select_MD_imp_comp %>% 
  relocate(index, .before= .id)

#generating average value of imputed variables across the imputed data sets
demoMD_imp_avgs <- clusdf_select_MD_imp_comp %>% 
  group_by(index) %>% 
  summarise(round(mean(mo_edu_wave1)),
            round(mean(mo_edu_wave2)),
            round(mean(mo_edu_wave3)),
            round(mean(mo_edu_wave4)),
            round(mean(mo_hh_income_wave1)),
            round(mean(mo_hh_income_wave2)),
            round(mean(mo_hh_income_wave3)),
            round(mean(mo_hh_income_wave4)))
            
colnames(demoMD_imp_avgs) <- c("index","mo_edu_wave1", "mo_edu_wave2","mo_edu_wave3", 
                               "mo_edu_wave4", "mo_hh_income_wave1", "mo_hh_income_wave2",
                               "mo_hh_income_wave3", "mo_hh_income_wave4")

#creating new complete data set with imputed demographic/control variables
FF_MD_clus0 <- clusterdf_demo_MD %>% 
  subset(select = -c(mo_edu_wave1, mo_edu_wave2, mo_edu_wave3, mo_edu_wave4,
                     mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
                     mo_hh_income_wave4)) %>% 
  left_join(demoMD_imp_avgs, by= "index") 
  

#transforming education variable back to categorical and adding substantive labels 
FF_MD_clus <- FF_MD_clus0 %>% 
  mutate(mo_edu_wave0= case_when(mo_edu_wave0 %in% c(1) ~ "less hs",
                                 mo_edu_wave0 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave0 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave0 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave1= case_when(mo_edu_wave1 %in% c(1) ~ "less hs",
                                 mo_edu_wave1 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave1 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave1 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave2= case_when(mo_edu_wave2 %in% c(1) ~ "less hs",
                                 mo_edu_wave2 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave2 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave2 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave3= case_when(mo_edu_wave3 %in% c(1) ~ "less hs",
                                 mo_edu_wave3 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave3 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave3 %in% c(4) ~ "coll or grad")) %>% 
  mutate(mo_edu_wave4= case_when(mo_edu_wave4 %in% c(1) ~ "less hs",
                                 mo_edu_wave4 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave4 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave4 %in% c(4) ~ "coll or grad")) 

#logging hh income variable for modeling (adding one to address zeros)
FF_MD_clus <- FF_MD_clus %>% 
  mutate(hh_income_log= log(FF_MD_clus$mo_hh_income_wave0 +1)) 

#recoding education at baseline as ordinal factor for modeling
FF_MD_clus$mo_edu_wave0 <- factor(FF_MD_clus$mo_edu_wave0,
                                     levels=c("less hs",
                                              "hs or equiv",
                                              "some coll, tech",
                                              "coll or grad"))

#adding unordered version of cluster variables for multinomial regression & turning
#mother's race/ethnicity into unordered factor variable to set reference level
FF_MD_clus <- FF_MD_clus %>% 
  mutate(cluster_MD4_m= factor(FF_MD_clus$cluster_MD4, ordered = F)) %>%
  mutate(mo_race_eth= factor(FF_MD_clus$mo_race_eth, ordered = F))
```

### Generating Descriptive Table of Analytic Sample
```{r}
clusterdf_demo_MD_descrip <- clusterdf_demo_MD %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c(1) ~ "Less Than High School",
                     mo_edu_wave0 %in% c(2) ~ "High School or Equivalent",
                     mo_edu_wave0 %in% c(3) ~ "Some College/Technical School",
                     mo_edu_wave0 %in% c(4) ~ "College or Graduate School")) %>% 
  mutate(mo_race_eth =
           case_when(mo_race_eth %in% c("1 white, non-hispanic") ~ "White, Non-Hispanic",
                     mo_race_eth %in% c("2 black, non-hispanic") ~ "Black, Non-Hispanic",
                     mo_race_eth %in% c("3 hispanic") ~ "Hispanic",
                     mo_race_eth %in% c("4 other") ~ "Other Race/Ethnicity"))

descripMD <-  clusterdf_demo_MD_descrip %>% 
  dplyr::select(mo_race_eth, mo_edu_wave0, mo_hh_income_wave0, 
         mo_age_wave0, mo_married_wave0, mo_cohab_wave0)

descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "0"] <- "Not married"
descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "1"] <- "Married"

descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "0"] <- "Not Cohabitating"
descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "1"] <- "Cohabitating"

label(descripMD$mo_hh_income_wave0) <- "Mother's Annual Household Income at Baseline"
label(descripMD$mo_race_eth) <- "Race/Ethnicity"
label(descripMD$mo_edu_wave0) <- "Education at Baseline"
label(descripMD$mo_married_wave0) <- "Mother Married to Bio Dad at Baseline"
label(descripMD$mo_cohab_wave0) <- "Mother Cohabitating w/ Bio Dad at Baseline"
label(descripMD$mo_age_wave0) <- "Age at Birth of Focal Child"

descripMD_table <- table1(~mo_race_eth + 
                          mo_edu_wave0 + mo_age_wave0 + mo_hh_income_wave0 +
                          mo_married_wave0 + mo_cohab_wave0, 
                        data = descripMD)
descripMD_table
# png("Sample_Table.png", width = 550, height = 550)
# tableGrob(descripMD_table)
# dev.off()

# #png("Sample_Table.png", width = 550, height = 550)
# apa_table(descripMD_table)
# #dev.off()

```

### Modeling w/ IDCD Clusters (MULTINOMINAL)
```{r}
##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the very low adversity cluster [3 clusters]
FF_MD_clus$cluster_MD4_m <- relevel(FF_MD_clus$cluster_MD4_m,
                                      ref = "Consistently Very Low Adversity (0-1 Domains)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

## MODEL 1
# mother's race as sole predictor model
mod1_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD4)

z_mod1_MD4 <- summary(mod1_MD4)$coefficients/summary(mod1_MD4)$standard.errors
p_mod1_MD4 <- (1 - pnorm(abs(z_mod1_MD4), 0, 1)) * 2
p_mod1_MD4

## MODEL 2
# mother's race as predictor w/ education, income, and age of mother at focal child's
# birth as covariates
mod2_MD4 <- multinom(formula = cluster_MD4_m ~ mo_race_eth +
                                     hh_income_log + mo_edu_wave0 +
                                     mo_age_wave0,
                                   data = FF_MD_clus)

summary(mod2_MD4)

z_mod2_MD4 <- summary(mod2_MD4)$coefficients/summary(mod2_MD4)$standard.errors
p_mod2_MD4 <- (1 - pnorm(abs(z_mod2_MD4), 0, 1)) * 2
p_mod2_MD4
```

#### Multinomial Regression Table
```{r, results='asis', warning=FALSE}
stargazer(mod1_MD4, mod2_MD4,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          dep.var.labels = c("Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity",
                             "Enduring Social Network Adversity",
                             "Enduring Carceral Adversity",
                             "Consistently Very High Adversity"),
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Household Income (Logged)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "-10pt",
          notes.append = F,
          type = "html")
```
