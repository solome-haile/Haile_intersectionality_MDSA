---
title: "Intersec_MD_Analysis_Final"
author: "Solome Haile"
date: "2024-09-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(labelled)
library(tidyverse)
library(stargazer)
library(haven)
library(rsample)
library(readstata13)
library(naniar)
library(Amelia)
library(cluster)
library(dplyr)
library(ggplot2)
library(reshape)
library(reshape2)
library(stats)
library(TraMineR)
library(TraMineRextras)
library(mice)
library(VGAM)
library(factoextra)
library(cluster)
library(gridExtra)
library(nnet)
library(foreign)
library(table1)
library(kableExtra)
library(RColorBrewer)
library(seqhandbook)
library(seqHMM)
library(WeightedCluster)
library(modelsummary)
library(webshot2)
library(DescTools)
set.seed(08540)
#setting working directory
#setwd("/Users/solomonaberash/Desktop/Graduate School/Intersec Paper:F22 Research App/Intersec_Haile")
```

# LOADING DATA

```{r, warning=FALSE}
FF <- read.dta13("FF_allwaves_2020v2.dta")

FF<- rowid_to_column(FF, "index")
```

# SEQUENCE ANALYSIS OF AGGREGATE MEASURE OF ADVERSITY

## Data Cleaning and Wrangling
```{r, warning=FALSE}
#subsetting data
FF_adversity_FULL <- FF %>% 
  subset(select = c(cm1ethrace, #race/ethnicity of mothers
                    m1h2, #whether mother born in U.S.
                    #mother's education (base-Y9; ordered categorical)
                    cm1edu,cm2edu, cm3edu, cm4edu, cm5edu, 
                    #how much mother earned before taxes (Y1-Y9, continuous)
                    m2k10a, m3k13, m4k13, m5i13, 
                    #whether father was in jail at time of interview (Y1-Y9)
                    cm2finjail,cm3finjail, cm4finjail, cm5finjail, 
                    #whether evicted in past year (Y1-Y9)
                    m2h19e, m3i23c, m4i23e, m5f23d, 
                    #whether they live in a public housing proj (Y1-Y9)
                    m2h5, m3i5, m4i5, m5f5,
                    #whether child was separated & lived with foster parents (Y1-Y9); 
                    #too much missingness in Y5 so removed from data set
                    #m2b15a5, m3b3b_5, m4b3b_5, m5a3a1_4,
                    #whether mom meets depression criteria (conserv) (Y1-Y9)
                    cm2md_case_con, cm3md_case_con, cm4md_case_con, cm5md_case_con, 
                    #whether mom had emergency care-giving (Y1-Y9)
                    m2g6c, m3h5, m4h5, m5e5, 
                    #whether work schedule causes extra stress for mom and child (Y1-Y9); 
                    #too much missingness so removed
                    #m2k13a, m3k16a,m4k16a, m5i16a, 
                    #whether mom was stopped by police but not arrested (Y3-Y9)
                    #m3i24, m4i24, m5f24, #did not have all 4 waves so removed
                    #whether current partner has spent time in jail/prison (Y1-Y9)
                    m2e10, m3e25, m4e25, m5d23, 
                    #whether lived in non-reg housing in past yr (Y1-Y9)
                    m2h19k, m3i23g, m4i23j, m5f23i, 
                    #whether moved bc of financial problems (Y1-Y9)
                    m2h19j, m3i23f, m4i23i, m5f23h, 
                    #whether someone in hh did not see doc/go to hosp bc of cost (Y3-Y9)
                    #m3i23h, m4i23k, m5f23j,  #did not have all 4 waves so removed
                    #whether they went hungry bc could not afford food (Y1-Y9)
                    m2h19c, p3d6, m4i23b, m5f23b, 
                    #whether telephone disconnected bc not enough money in past yr (Y1-Y9)
                    m2h19h, m3i6a, m4i23n, m5f23k,
                    #whether received free food/meals in past yr (Y1-Y9)
                    m2h19a, m3i23a, m4i23a, m5f23a, 
                    #whether of father of focal child has problems (i.e. job, 
                    #relationships) bc drugs (Y1-Y9)
                    m2c35, m3c44, m4c39, m5b32,
                    #whether gas/electric shut off bc lack of money (Y1-Y9)
                    m2h19g, m3i6f, m4i23g, m5f23f,
                    #whether sold drugs/engaged in sex work/side hustles in past yr (Y1-Y9)
                    m2k19a, m3k26a, m4k25a, m5i25a,
                    #whether father have problems keeping job/getting along 
                    #because of drugs/alcohol (Y1-Y9)
                    #m2c35, m3c44, m4c39, m5b32,#too much missingness 
                    #whether mother could count on someone to loan $1000 in the 
                    #next year (Y1-Y9)
                    m2g6a1, m3h3a, m4h3a, m5e3a,
                    #whether mother could count on someone to loan $200 in the 
                    #next year (Y1-Y9)
                    m2g6a, m3h3, m4h3, m5e3,
                    #whether mother could count on someone to co-sign a $1000 
                    #loan in the next year (Y1-Y9)
                    m2g6d, m3h6, m4h6, m5e6,
                    #whether mother could count on someone to co-sign a $5000 
                    #loan in the next year (Y1-Y9)
                    m2g6d1, m3h6a, m4h6a, m5e6a,
                    ##ADDING ADDITIONAL DEMOG VARIABLES
                    #household income at baseline
                    cm1hhinc,
                    #mother's age at birth of focal child
                    cm1age,
                    #number of previous biological children born prior to focal kid
                    m1a12a,
                    #mother's income at baseline interview
                    m1i2b,
                    # #adding index
                    # index
                    #whether mother was married to bio dad (baseline)
                    cm1marf,
                    #whether mother is cohabitating with bio dad (baseline)
                    cm1cohf)) 

#renaming columns
colnames(FF_adversity_FULL)[12:15]<- c("wave1_fjail","wave2_fjail","wave3_fjail",
                                  "wave4_fjail")
colnames(FF_adversity_FULL)[16:19]<- c("wave1_evict","wave2_evict","wave3_evict",
                                  "wave4_evict")
colnames(FF_adversity_FULL)[20:23]<- c("wave1_pub","wave2_pub","wave3_pub","wave4_pub")
colnames(FF_adversity_FULL)[24:27]<- c("wave1_dep","wave2_dep","wave3_dep","wave4_dep")
colnames(FF_adversity_FULL)[28:31]<- c("wave1_emcare","wave2_emcare","wave3_emcare",
                                  "wave4_emcare")
colnames(FF_adversity_FULL)[32:35]<- c("wave1_pjail","wave2_pjail","wave3_pjail","wave4_pjail")
colnames(FF_adversity_FULL)[36:39]<- c("wave1_nonreghouse","wave2_nonreghouse",
                                  "wave3_nonreghouse","wave4_nonreghouse")
colnames(FF_adversity_FULL)[40:43]<- c("wave1_moneymove","wave2_moneymove","wave3_moneymove",
                                  "wave4_moneymove")
colnames(FF_adversity_FULL)[44:47]<- c("wave1_hungry","wave2_hungry","wave3_hungry",
                                  "wave4_hungry")
colnames(FF_adversity_FULL)[48:51]<- c("wave1_tele","wave2_tele","wave3_tele","wave4_tele")
colnames(FF_adversity_FULL)[52:55]<- c("wave1_freemeal","wave2_freemeal","wave3_freemeal",
                                  "wave4_freemeal")
colnames(FF_adversity_FULL)[56:59]<- c("wave1_fprobs","wave2_fprobs","wave3_fprobs",
                                  "wave4_fprobs")
colnames(FF_adversity_FULL)[60:63]<- c("wave1_gaselec","wave2_gaselec","wave3_gaselec",
                                  "wave4_gaselec")
colnames(FF_adversity_FULL)[64:67]<- c("wave1_sidehust","wave2_sidehust","wave3_sidehust",
                                  "wave4_sidehust")
colnames(FF_adversity_FULL)[68:71]<- c("wave1_1kloan","wave2_1kloan","wave3_1kloan",
                                  "wave4_1kloan")
colnames(FF_adversity_FULL)[72:75]<- c("wave1_200loan","wave2_200loan","wave3_200loan",
                                  "wave4_200loan")
colnames(FF_adversity_FULL)[76:79]<- c("wave1_1kcosign","wave2_1kcosign","wave3_1kcosign",
                                  "wave4_1kcosign")
colnames(FF_adversity_FULL)[80:83]<- c("wave1_5kcosign","wave2_5kcosign","wave3_5kcosign",
                                  "wave4_5kcosign")


#previewing data
# head(FF_adversity_FULL)

#cleaning missing data
FF_adversity_FULL[FF_adversity_FULL == "-3 Missing"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-3"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-9 Not in wave"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-9"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-6 skip"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-6 Skip"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-6"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-2 Don't know"] <- NA
FF_adversity_FULL[FF_adversity_FULL == "-10 no child(ren)/ no need for care"] <- NA

#changing class of variables for recoding
for(i in 12:83){
  FF_adversity_FULL[,i] <- to_character(FF_adversity_FULL[,i])
}

for(i in 88:89){
  FF_adversity_FULL[,i] <- to_character(FF_adversity_FULL[,i])
}


##recoding variables
#first recoding variables where adversity is "reversed" (where yes= no adversity,
#want to change it to where the affirmative indicates adversity to match other vars)
FF_adversity_FULL <- FF_adversity_FULL %>% 
  mutate(wave1_emcare=
           case_when(wave1_emcare %in% c("1 Yes") ~ 0,
                     wave1_emcare %in% c("2 No") ~ 1)) %>% 
  mutate(wave2_emcare=
           case_when(wave2_emcare %in% c("1 Yes") ~ 0,
                     wave2_emcare %in% c("2 No") ~ 1)) %>% 
  mutate(wave3_emcare=
           case_when(wave3_emcare %in% c("1 Yes") ~ 0,
                     wave3_emcare %in% c("2 No") ~ 1)) %>% 
  mutate(wave4_emcare=
           case_when(wave4_emcare %in% c("1 yes") ~ 0,
                     wave4_emcare %in% c("2 no") ~ 1)) %>% 
  mutate(wave1_1kloan=
           case_when(wave1_1kloan %in% c("1 yes") ~ 0,
                     wave1_1kloan %in% c("2 no") ~ 1,
                     wave1_1kloan %in% c("1 Yes") ~ 0,
                     wave1_1kloan %in% c("2 No") ~ 1)) %>% 
  mutate(wave2_1kloan=
           case_when(wave2_1kloan %in% c("1 yes") ~ 0,
                     wave2_1kloan %in% c("2 no") ~ 1,
                     wave2_1kloan %in% c("1 Yes") ~ 0,
                     wave2_1kloan %in% c("2 No") ~ 1)) %>% 
  mutate(wave3_1kloan=
           case_when(wave3_1kloan %in% c("1 yes") ~ 0,
                     wave3_1kloan %in% c("2 no") ~ 1,
                     wave3_1kloan %in% c("1 Yes") ~ 0,
                     wave3_1kloan %in% c("2 No") ~ 1)) %>% 
  mutate(wave4_1kloan=
           case_when(wave4_1kloan %in% c("1 yes") ~ 0,
                     wave4_1kloan %in% c("2 no") ~ 1,
                     wave4_1kloan %in% c("1 Yes") ~ 0,
                     wave4_1kloan %in% c("2 No") ~ 1)) %>% 
  mutate(wave1_200loan=
           case_when(wave1_200loan %in% c("1 yes") ~ 0,
                     wave1_200loan %in% c("2 no") ~ 1,
                     wave1_200loan %in% c("1 Yes") ~ 0,
                     wave1_200loan %in% c("2 No") ~ 1)) %>% 
  mutate(wave2_200loan=
           case_when(wave2_200loan %in% c("1 yes") ~ 0,
                     wave2_200loan %in% c("2 no") ~ 1,
                     wave2_200loan %in% c("1 Yes") ~ 0,
                     wave2_200loan %in% c("2 No") ~ 1)) %>% 
  mutate(wave3_200loan=
           case_when(wave3_200loan %in% c("1 yes") ~ 0,
                     wave3_200loan %in% c("2 no") ~ 1,
                     wave3_200loan %in% c("1 Yes") ~ 0,
                     wave3_200loan %in% c("2 No") ~ 1)) %>% 
  mutate(wave4_200loan=
           case_when(wave4_200loan %in% c("1 yes") ~ 0,
                     wave4_200loan %in% c("2 no") ~ 1,
                     wave4_200loan %in% c("1 Yes") ~ 0,
                     wave4_200loan %in% c("2 No") ~ 1)) %>% 
  mutate(wave1_1kcosign=
           case_when(wave1_1kcosign %in% c("1 yes") ~ 0,
                     wave1_1kcosign %in% c("2 no") ~ 1,
                     wave1_1kcosign %in% c("1 Yes") ~ 0,
                     wave1_1kcosign %in% c("2 No") ~ 1)) %>% 
  mutate(wave2_1kcosign=
           case_when(wave2_1kcosign %in% c("1 yes") ~ 0,
                     wave2_1kcosign %in% c("2 no") ~ 1,
                     wave2_1kcosign %in% c("1 Yes") ~ 0,
                     wave2_1kcosign %in% c("2 No") ~ 1)) %>% 
  mutate(wave3_1kcosign=
           case_when(wave3_1kcosign %in% c("1 yes") ~ 0,
                     wave3_1kcosign %in% c("2 no") ~ 1,
                     wave3_1kcosign %in% c("1 Yes") ~ 0,
                     wave3_1kcosign %in% c("2 No") ~ 1)) %>% 
  mutate(wave4_1kcosign=
           case_when(wave4_1kcosign %in% c("1 yes") ~ 0,
                     wave4_1kcosign %in% c("2 no") ~ 1,
                     wave4_1kcosign %in% c("1 Yes") ~ 0,
                     wave4_1kcosign %in% c("2 No") ~ 1)) %>% 
  mutate(wave1_5kcosign=
           case_when(wave1_5kcosign %in% c("1 yes") ~ 0,
                     wave1_5kcosign %in% c("2 no") ~ 1,
                     wave1_5kcosign %in% c("1 Yes") ~ 0,
                     wave1_5kcosign %in% c("2 No") ~ 1)) %>% 
  mutate(wave2_5kcosign=
           case_when(wave2_5kcosign %in% c("1 yes") ~ 0,
                     wave2_5kcosign %in% c("2 no") ~ 1,
                     wave2_5kcosign %in% c("1 Yes") ~ 0,
                     wave2_5kcosign %in% c("2 No") ~ 1)) %>% 
  mutate(wave3_5kcosign=
           case_when(wave3_5kcosign %in% c("1 yes") ~ 0,
                     wave3_5kcosign %in% c("2 no") ~ 1,
                     wave3_5kcosign %in% c("1 Yes") ~ 0,
                     wave3_5kcosign %in% c("2 No") ~ 1)) %>% 
  mutate(wave4_5kcosign=
           case_when(wave4_5kcosign %in% c("1 yes") ~ 0,
                     wave4_5kcosign %in% c("2 no") ~ 1,
                     wave4_5kcosign %in% c("1 Yes") ~ 0,
                     wave4_5kcosign %in% c("2 No") ~ 1))

#recoding all variables
FF_adversity_FULL[FF_adversity_FULL == "0 No"] <- "0"
FF_adversity_FULL[FF_adversity_FULL == "1 Yes"] <- "1"
FF_adversity_FULL[FF_adversity_FULL == "1 yes"] <- "1"
FF_adversity_FULL[FF_adversity_FULL == "2 No"] <- "0"
FF_adversity_FULL[FF_adversity_FULL == "2 no"] <- "0"

#changing class into numeric to make summative adversity score
for(i in 12:83){
  FF_adversity_FULL[,i] <- as.numeric(FF_adversity_FULL[,i])
}
```

## Imputing Missing Data
```{r, warning=FALSE}
set.seed(08540)
#determining average number of missing-- necessary? could guide m value
#making data frame of just adversity values (no demographic values)
FF_adv_only_FULL <- FF_adversity_FULL[,c(12:83)]

#imputing missing data
FF_adversity_FULL_imp <- mice(data=FF_adv_only_FULL, m= 5, method = "pmm")

#examining imputed data
# head(complete(FF_adversity_FULL_imp))

##creating an imputed data set
FF_adv.comp_FULL <- complete(FF_adversity_FULL_imp, "long", include = F)
```


## [CARCERAL SYSTEM] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under carceral system domain
carceral_domain <- FF_adv.comp_FULL %>% 
  select(ends_with(c("jail", "fprobs", "sidehust"))) %>% 
  mutate(imp=FF_adv.comp_FULL$.imp) 

#wave 1
c_domain_w1 <- carceral_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave1"))

c_domain_w1_sums_FULL <- as.data.frame(rowSums(c_domain_w1[,c(2:5)]))

#wave 2
c_domain_w2 <- carceral_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave2"))

c_domain_w2_sums_FULL <- as.data.frame(rowSums(c_domain_w2[,c(2:5)]))

#wave 3
c_domain_w3 <- carceral_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave3"))

c_domain_w3_sums_FULL <- as.data.frame(rowSums(c_domain_w3[,c(2:5)]))

#wave 4
c_domain_w4 <- carceral_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave4"))

c_domain_w4_sums_FULL <- as.data.frame(rowSums(c_domain_w4[,c(2:5)]))

##creating a data set with the Summatedd scores 
c_dom_sums_FULL <- bind_cols(c_domain_w1_sums_FULL, c_domain_w2_sums_FULL,
                             c_domain_w3_sums_FULL, c_domain_w4_sums_FULL)
c_dom_sums_FULL$index <- rep(FF$index, rep= 5)

colnames(c_dom_sums_FULL) <- c("wave1_cdom_sums_FULL", "wave2_cdom_sums_FULL", 
                               "wave3_cdom_sums_FULL", "wave4_cdom_sums_FULL", 
                               "index")

c_dom_sums_FULL <- c_dom_sums_FULL %>% 
  relocate(index, .before= wave1_cdom_sums_FULL) %>% 
  mutate(imp= FF_adv.comp_FULL$.imp) %>% 
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
cdom_wave1avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_cdom_sums_FULL)) %>% 
  select("mean(wave1_cdom_sums_FULL)")

cdom_wave2avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_cdom_sums_FULL)) %>% 
  select("mean(wave2_cdom_sums_FULL)")

cdom_wave3avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_cdom_sums_FULL)) %>% 
  select("mean(wave3_cdom_sums_FULL)")

cdom_wave4avg <- c_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_cdom_sums_FULL)) %>% 
  select("mean(wave4_cdom_sums_FULL)")

cdom_allwaves_avg_FULL <- bind_cols(FF$index, cdom_wave1avg, cdom_wave2avg, 
                               cdom_wave3avg, cdom_wave4avg)

colnames(cdom_allwaves_avg_FULL) <- c("index", "cdom_avg1", "cdom_avg2", 
                                      "cdom_avg3", "cdom_avg4")

#converting into binary states
cdom_allwaves_avg_cat_FULL <- cdom_allwaves_avg_FULL %>% 
  mutate(cdomw1_cat= case_when(cdom_avg1 == 0  ~ "CN",
                              cdom_avg1 > 0 ~ "CY")) %>% 
  mutate(cdomw2_cat= case_when(cdom_avg2 == 0  ~ "CN", 
                              cdom_avg2 > 0 ~ "CY")) %>% 
  mutate(cdomw3_cat= case_when(cdom_avg3 == 0  ~ "CN",
                              cdom_avg3 > 0 ~ "CY")) %>% 
  mutate(cdomw4_cat= case_when(cdom_avg4 == 0  ~ "CN",
                              cdom_avg4 > 0 ~ "CY"))

  
```


## [HOUSING] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under housing system domain
housing_domain <- FF_adv.comp_FULL %>% 
  select(ends_with(c("evict", "pub", "nonreghouse", "moneymove",
                     "tele", "gaselec"))) %>%
  mutate(imp=FF_adv.comp_FULL$.imp) 

#wave 1
ho_domain_w1 <- housing_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave1"))

ho_domain_w1_sums_FULL <- as.data.frame(rowSums(ho_domain_w1[,c(2:7)]))

#wave 2
ho_domain_w2 <- housing_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave2"))

ho_domain_w2_sums_FULL <- as.data.frame(rowSums(ho_domain_w2[,c(2:7)]))

#wave 3
ho_domain_w3 <- housing_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave3"))

ho_domain_w3_sums_FULL <- as.data.frame(rowSums(ho_domain_w3[,c(2:7)]))

#wave 4
ho_domain_w4 <- housing_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave4"))

ho_domain_w4_sums_FULL <- as.data.frame(rowSums(ho_domain_w4[,c(2:7)]))

##creating a data set with the Summatedd scores 
ho_dom_sums_FULL <- bind_cols(ho_domain_w1_sums_FULL, ho_domain_w2_sums_FULL,
                             ho_domain_w3_sums_FULL, ho_domain_w4_sums_FULL)
ho_dom_sums_FULL$index <- rep(FF$index, rep= 5)

colnames(ho_dom_sums_FULL) <- c("wave1_hodom_sums_FULL", "wave2_hodom_sums_FULL", 
                               "wave3_hodom_sums_FULL", "wave4_hodom_sums_FULL", 
                               "index")

ho_dom_sums_FULL <- ho_dom_sums_FULL %>% 
  relocate(index, .before= wave1_hodom_sums_FULL) %>% 
  mutate(imp= FF_adv.comp_FULL$.imp) %>% 
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
hodom_wave1avg <- ho_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_hodom_sums_FULL)) %>% 
  select("mean(wave1_hodom_sums_FULL)")

hodom_wave2avg <- ho_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_hodom_sums_FULL)) %>% 
  select("mean(wave2_hodom_sums_FULL)")

hodom_wave3avg <- ho_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_hodom_sums_FULL)) %>% 
  select("mean(wave3_hodom_sums_FULL)")

hodom_wave4avg <- ho_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_hodom_sums_FULL)) %>% 
  select("mean(wave4_hodom_sums_FULL)")

hodom_allwaves_avg_FULL <- bind_cols(FF$index, hodom_wave1avg, hodom_wave2avg, 
                               hodom_wave3avg, hodom_wave4avg)

colnames(hodom_allwaves_avg_FULL) <- c("index", "hodom_avg1", "hodom_avg2", 
                                      "hodom_avg3", "hodom_avg4")

#converting into binary states
hodom_allwaves_avg_cat_FULL <- hodom_allwaves_avg_FULL %>% 
  mutate(hodomw1_cat= case_when(hodom_avg1 == 0  ~ "HON",
                              hodom_avg1 > 0 ~ "HOY")) %>% 
  mutate(hodomw2_cat= case_when(hodom_avg2 == 0  ~ "HON", 
                              hodom_avg2 > 0 ~ "HOY")) %>% 
  mutate(hodomw3_cat= case_when(hodom_avg3 == 0  ~ "HON",
                              hodom_avg3 > 0 ~ "HOY")) %>% 
  mutate(hodomw4_cat= case_when(hodom_avg4 == 0  ~ "HON",
                              hodom_avg4 > 0 ~ "HOY"))
```


## [HEALTH] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under health domain
health_domain <- FF_adv.comp_FULL %>% 
  select(ends_with(c("dep", "hungry", "freemeal"))) %>%
  mutate(imp=FF_adv.comp_FULL$.imp) 

#wave 1
he_domain_w1 <- health_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave1"))

he_domain_w1_sums_FULL <- as.data.frame(rowSums(he_domain_w1[,c(2:4)]))

#wave 2
he_domain_w2 <- health_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave2"))

he_domain_w2_sums_FULL <- as.data.frame(rowSums(he_domain_w2[,c(2:4)]))

#wave 3
he_domain_w3 <- health_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave3"))

he_domain_w3_sums_FULL <- as.data.frame(rowSums(he_domain_w3[,c(2:4)]))

#wave 4
he_domain_w4 <- health_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave4"))

he_domain_w4_sums_FULL <- as.data.frame(rowSums(he_domain_w4[,c(2:4)]))

##creating a data set with the Summatedd scores 
he_dom_sums_FULL <- bind_cols(he_domain_w1_sums_FULL, he_domain_w2_sums_FULL,
                             he_domain_w3_sums_FULL, he_domain_w4_sums_FULL)
he_dom_sums_FULL$index <- rep(FF$index, rep= 5)

colnames(he_dom_sums_FULL) <- c("wave1_hedom_sums_FULL", "wave2_hedom_sums_FULL", 
                               "wave3_hedom_sums_FULL", "wave4_hedom_sums_FULL", 
                               "index")

he_dom_sums_FULL <- he_dom_sums_FULL %>% 
  relocate(index, .before= wave1_hedom_sums_FULL) %>% 
  mutate(imp= FF_adv.comp_FULL$.imp) %>% 
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
hedom_wave1avg <- he_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_hedom_sums_FULL)) %>% 
  select("mean(wave1_hedom_sums_FULL)")

hedom_wave2avg <- he_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_hedom_sums_FULL)) %>% 
  select("mean(wave2_hedom_sums_FULL)")

hedom_wave3avg <- he_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_hedom_sums_FULL)) %>% 
  select("mean(wave3_hedom_sums_FULL)")

hedom_wave4avg <- he_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_hedom_sums_FULL)) %>% 
  select("mean(wave4_hedom_sums_FULL)")

hedom_allwaves_avg_FULL <- bind_cols(FF$index, hedom_wave1avg, hedom_wave2avg, 
                               hedom_wave3avg, hedom_wave4avg)

colnames(hedom_allwaves_avg_FULL) <- c("index", "hedom_avg1", "hedom_avg2", 
                                      "hedom_avg3", "hedom_avg4")

#converting into binary states
hedom_allwaves_avg_cat_FULL <- hedom_allwaves_avg_FULL %>% 
  mutate(hedomw1_cat= case_when(hedom_avg1 == 0  ~ "HEN",
                              hedom_avg1 > 0 ~ "HEY")) %>% 
  mutate(hedomw2_cat= case_when(hedom_avg2 == 0  ~ "HEN", 
                              hedom_avg2 > 0 ~ "HEY")) %>% 
  mutate(hedomw3_cat= case_when(hedom_avg3 == 0  ~ "HEN",
                              hedom_avg3 > 0 ~ "HEY")) %>% 
  mutate(hedomw4_cat= case_when(hedom_avg4 == 0  ~ "HEN",
                              hedom_avg4 > 0 ~ "HEY"))
```


## [SOCIAL NETWORK] Creating Summated Adversity Scores 
```{r}
##selecting adverse events that fall under social network domain
socnet_domain <- FF_adv.comp_FULL %>% 
  select(ends_with(c("emcare", "1kloan", "200loan",
                     "1kcosign", "5kcosign"))) %>%
  mutate(imp=FF_adv.comp_FULL$.imp) 

#wave 1
net_domain_w1 <- socnet_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave1"))

net_domain_w1_sums_FULL <- as.data.frame(rowSums(net_domain_w1[,c(2:6)]))

#wave 2
net_domain_w2 <- socnet_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave2"))

net_domain_w2_sums_FULL <- as.data.frame(rowSums(net_domain_w2[,c(2:6)]))

#wave 3
net_domain_w3 <- socnet_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave3"))

net_domain_w3_sums_FULL <- as.data.frame(rowSums(net_domain_w3[,c(2:6)]))

#wave 4
net_domain_w4 <- socnet_domain %>% 
  group_by(imp) %>% 
  select(starts_with("wave4"))

net_domain_w4_sums_FULL <- as.data.frame(rowSums(net_domain_w4[,c(2:6)]))

##creating a data set with the Summatedd scores 
net_dom_sums_FULL <- bind_cols(net_domain_w1_sums_FULL, net_domain_w2_sums_FULL,
                             net_domain_w3_sums_FULL, net_domain_w4_sums_FULL)
net_dom_sums_FULL$index <- rep(FF$index, rep= 5)

colnames(net_dom_sums_FULL) <- c("wave1_netdom_sums_FULL", "wave2_netdom_sums_FULL", 
                               "wave3_netdom_sums_FULL", "wave4_netdom_sums_FULL", 
                               "index")

net_dom_sums_FULL <- net_dom_sums_FULL %>% 
  relocate(index, .before= wave1_netdom_sums_FULL) %>% 
  mutate(imp= FF_adv.comp_FULL$.imp) %>% 
  relocate(imp, .before= index)

#getting average score for each observation across imputed data sets
netdom_wave1avg <- net_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave1_netdom_sums_FULL)) %>% 
  select("mean(wave1_netdom_sums_FULL)")

netdom_wave2avg <- net_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave2_netdom_sums_FULL)) %>% 
  select("mean(wave2_netdom_sums_FULL)")

netdom_wave3avg <- net_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave3_netdom_sums_FULL)) %>% 
  select("mean(wave3_netdom_sums_FULL)")

netdom_wave4avg <- net_dom_sums_FULL  %>% 
  group_by(index) %>% 
  summarise(mean(wave4_netdom_sums_FULL)) %>% 
  select("mean(wave4_netdom_sums_FULL)")

netdom_allwaves_avg_FULL <- bind_cols(FF$index, netdom_wave1avg, netdom_wave2avg, 
                               netdom_wave3avg, netdom_wave4avg)

colnames(netdom_allwaves_avg_FULL) <- c("index", "netdom_avg1", "netdom_avg2", 
                                      "netdom_avg3", "netdom_avg4")

#converting into binary states
netdom_allwaves_avg_cat_FULL <- netdom_allwaves_avg_FULL %>% 
  mutate(netdomw1_cat= case_when(netdom_avg1 == 0  ~ "NN",
                              netdom_avg1 > 0 ~ "NY")) %>% 
  mutate(netdomw2_cat= case_when(netdom_avg2 == 0  ~ "NN", 
                              netdom_avg2 > 0 ~ "NY")) %>% 
  mutate(netdomw3_cat= case_when(netdom_avg3 == 0  ~ "NN",
                              netdom_avg3 > 0 ~ "NY")) %>% 
  mutate(netdomw4_cat= case_when(netdom_avg4 == 0  ~ "NN",
                              netdom_avg4 > 0 ~ "NY"))
```


## Creating Sequences with Composite Scores
```{r}
## cleaning dataframes for defining 
carceral_traj <- cdom_allwaves_avg_cat_FULL %>% 
  select(starts_with("cdomw"))

housing_traj <- hodom_allwaves_avg_cat_FULL %>% 
  select(starts_with("hodomw"))

health_traj <- hedom_allwaves_avg_cat_FULL %>% 
  select(starts_with("hedomw"))

socnet_traj <- netdom_allwaves_avg_cat_FULL %>% 
  select(starts_with("netdomw"))

##defining sequence objects for each domain

#carceral system
cdom_alphabet <- c("CY", "CN")
cdom_labs <- c("carceral_yes", "carceral_no")

colnames(carceral_traj)[1] <- "Wave 1 (Y1)"
colnames(carceral_traj)[2] <- "Wave 2 (Y3)"
colnames(carceral_traj)[3] <- "Wave 3 (Y5)"
colnames(carceral_traj)[4] <- "Wave 4 (Y9)"

seqcar <- seqdef(carceral_traj,
                 var = 1:4,
                 alphabet = cdom_alphabet,
                 labels=cdom_labs,
                 xstep= 1 )

#housing system
hodom_alphabet <- c("HOY", "HON")
hodom_labs <- c("house_yes", "house_no")

colnames(housing_traj)[1] <- "Wave 1 (Y1)"
colnames(housing_traj)[2] <- "Wave 2 (Y3)"
colnames(housing_traj)[3] <- "Wave 3 (Y5)"
colnames(housing_traj)[4] <- "Wave 4 (Y9)"

seqhou <- seqdef(housing_traj,
                 var = 1:4,
                 alphabet = hodom_alphabet,
                 labels=hodom_labs,
                 xstep= 1)

#health
hedom_alphabet <- c("HEY", "HEN")
hedom_labs <- c("health_yes", "health_no")

colnames(health_traj)[1] <- "Wave 1 (Y1)"
colnames(health_traj)[2] <- "Wave 2 (Y3)"
colnames(health_traj)[3] <- "Wave 3 (Y5)"
colnames(health_traj)[4] <- "Wave 4 (Y9)"

seqhealth <- seqdef(health_traj,
                 var = 1:4,
                 alphabet = hedom_alphabet,
                 labels=hedom_labs,
                 xstep= 1)

#social network
netdom_alphabet <- c("NY", "NN")
netdom_labs <- c("socnetwork_yes", "socnetwork_no")

colnames(socnet_traj)[1] <- "Wave 1 (Y1)"
colnames(socnet_traj)[2] <- "Wave 2 (Y3)"
colnames(socnet_traj)[3] <- "Wave 3 (Y5)"
colnames(socnet_traj)[4] <- "Wave 4 (Y9)"

seqsocnet <- seqdef(socnet_traj,
                 var = 1:4,
                 alphabet = netdom_alphabet,
                 labels=netdom_labs,
                 xstep= 1)


## Calculating Distance/Dissimilarity Matrix [OM]

#carceral system
carceral_distOM <- seqdist(seqcar,
                         method = "OM",
                         indel = 1.0,
                         sm = "INDELSLOG",
                         with.missing = TRUE)

#housing
housing_distOM <- seqdist(seqhou,
                         method = "OM",
                         indel = 1.0,
                         sm = "INDELSLOG",
                         with.missing = TRUE)
#health
health_distOM <- seqdist(seqhealth,
                         method = "OM",
                         indel = 1.0,
                         sm = "INDELSLOG",
                         with.missing = TRUE)
#social network
socnet_distOM <- seqdist(seqsocnet,
                         method = "OM",
                         indel = 1.0,
                         sm = "INDELSLOG",
                         with.missing = TRUE)

```


## Measuring Strength of Association b/w Domains
```{r}
##at state level (testing whether CAT could be used)
seqdomassoc(list(seqcar, seqhou, seqhealth, seqsocnet),
            rep.method = "overall",
            assoc = "V",
            p.value = T,
            struct.zero = F,
            cross.table = T,
            with.missing = F,
            weighted = F,
            dnames = c("Carceral Sys", "Housing", "Health", "Soc Network"))

##at sequence level (testing whether DAT could be used)
dissdomassoc(list(carceral_distOM, housing_distOM, health_distOM, socnet_distOM),
             what = "pearson",
             dnames = c("Carceral Sys", "Housing", "Health", "Soc Network"))
```


## Creating/Plotting Multidomain Sequences
```{r}
MD_alphabet <- c("CN+HON+HEN+NN","CN+HON+HEN+NY", "CN+HON+HEY+NN", "CN+HOY+HEN+NN","CY+HON+HEN+NN",
                 "CN+HON+HEY+NY", "CN+HOY+HEN+NY", "CN+HOY+HEY+NN", "CY+HON+HEN+NY", "CY+HOY+HEN+NN",
                 "CY+HON+HEY+NN","CN+HOY+HEY+NY","CY+HON+HEY+NY",  "CY+HOY+HEN+NY", "CY+HOY+HEY+NN",
                 "CY+HOY+HEY+NY")

##making MD sequence (w/ expanded alphabet)
MDseq <- seqMD(list(seqcar, seqhou, seqhealth, seqsocnet))
alphabet(MDseq) <- c("CN+HON+HEN+NN","CN+HON+HEN+NY", "CN+HON+HEY+NN", "CN+HOY+HEN+NN","CY+HON+HEN+NN",
                 "CN+HON+HEY+NY", "CN+HOY+HEN+NY", "CN+HOY+HEY+NN", "CY+HON+HEN+NY", "CY+HOY+HEN+NN",
                 "CY+HON+HEY+NN","CN+HOY+HEY+NY","CY+HON+HEY+NY",  "CY+HOY+HEN+NY", "CY+HOY+HEY+NN",
                 "CY+HOY+HEY+NY")

##Setting MD Costs/Distances
MD_dist <- seqdistmc(list(seqcar, seqhou, seqhealth, seqsocnet),
                     method= "OM",
                     indel= 1,
                     sm= "INDELSLOG")

##plotting

#setting sequence color scheme
cpal(seqcar) <- c("slateblue4", "yellow1")
cpal(seqhou) <- c("palevioletred4", "palegoldenrod")
cpal(seqhealth) <- c("tomato3", "thistle1")
cpal(seqsocnet) <- c("springgreen4", "honeydew")

#plotting each domain
seqplot(seqcar, type = "I", with.legend = "right", 
        title = "Carceral System")

seqplot(seqhou, type = "I", with.legend = "right", 
        title = "Housing")

seqplot(seqhealth, type = "I", with.legend = "right", 
        title = "Health")

seqplot(seqsocnet, type = "I", with.legend = "right", 
        title = "Social Network")

#plotting MD sequences 
#alphabet is split by number of domains with adversity: green= 0-1 domains, 
#yellow=2 domains, pink=3-4 domains
seqplot(MDseq, type= "i", with.legend = "right",
        cpal= c("forestgreen","palegreen4", "olivedrab4", "olivedrab3","olivedrab",
                "goldenrod2","goldenrod","darkgoldenrod","gold2", "gold1", "gold",
                "maroon2", "hotpink2","violetred", "palevioletred","deeppink1"),
        title = "MD Sequences (Expanded Alphabet)", cex.legend = .5)

#plotting all sequences (MD and 4 domains)
seqplotMD(list(seqcar, seqhou, seqhealth, seqsocnet, MDseq),
          type = "I",
          with.legend = "right",
          dnames = c("Carceral Sys", "Housing", "Health", "Soc Network", "MD"))
```

## Cluster Analysis (IDCD Approach)
```{r}
#conducting hierarchical cluster analysis (ward)
MD_clus <- agnes(MD_dist, diss = T, method = "ward")
plot(MD_clus)
rect.hclust(MD_clus, k= 4)

#### FOR FOUR GROUPS ##### (conducted to determine best # of clusters)
MD_cut4 <- cutree(MD_clus, k= 4)
MD_cut_fac <- factor(MD_cut4, labels = paste("Type", 1:4))
MD_cut_fac4 <- factor(MD_cut4, labels = c("High Adversity (3+ Domains)",
                                        "Very Mixed (?)",
                                        "Low Adversity (0-1 Domains)",
                                        "Medium Adversity (2 domains)"))

# alphabet(MDseq)
#plotting [entire alphabet]

#png("MDcluster_plot4.png", width = 550, height = 550)
seqplot(MDseq, group = MD_cut4, type="I", 
        cpal= c("forestgreen","palegreen4", "olivedrab4", "olivedrab3","olivedrab",
                "goldenrod2","goldenrod","darkgoldenrod","gold2", "gold1", "gold",
                "maroon2", "hotpink2","violetred", "palevioletred","deeppink1"),
        sortv = "from.start", 
        with.legend = T, border = NA, cex.legend = .8)
#dev.off()

#evaluating cluster quality
sil_MD <- silhouette(x= MD_cut4, dmatrix = MD_dist) 
mean(as.data.frame(sil_MD)$sil_width)


#### FOR THREE GROUPS ##### 
MD_cut3 <- cutree(MD_clus, k= 3)
MD_cut_fac3 <- factor(MD_cut3, levels = c(2, 3, 1),
                      labels = c("Low-Medium Adversity (0-1 Domains)",
                                 "Medium Adversity (2 domains)",
                                 "High Adversity (3+ Domains)"))

#plotting [entire alphabet]
#png("MDcluster_plot3.png", width = 550, height = 550)
seqplot(MDseq, group = MD_cut_fac3, type="I", 
        cpal= c("forestgreen","palegreen4", "olivedrab4", "olivedrab3","olivedrab",
                "goldenrod2","goldenrod","darkgoldenrod","gold2", "gold1", "gold",
                "maroon2", "hotpink2","violetred", "palevioletred","deeppink1"),
        sortv = "from.start", 
        with.legend = T, border = NA, cex.legend = .7)
#dev.off()

#evaluating cluster quality
sil_MD3 <- silhouette(x= MD_cut3, dmatrix = MD_dist) 
mean(as.data.frame(sil_MD3)$sil_width)

#plotting w/ *stark* contrast between the three main groupings of the alphabet
#(0-1 domains of adversity, 2 domains of adversity, and 3+ domains of adversity)
#png("clus_STARK3.png", width = 550, height = 550)
seqplot(MDseq, group = MD_cut_fac3, type="I", 
        cpal= c("forestgreen","forestgreen", "forestgreen", "forestgreen","forestgreen",
                "gold1","gold1","gold1","gold1", "gold1", "gold1",
                "deeppink", "deeppink", "deeppink", "deeppink","deeppink"),
        sortv = "from.start", 
        with.legend = T, border = NA, cex.legend = .7)
#dev.off()

```


## Additional Visualization/Plotting for Analysis


```{r}
###DISTRIBUTION PLOTS####
#3 clusters
#png("MDcluster_plot3_dist.png", width=3000, height=1800, res = 600, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac3, type="d", 
        cpal= c("forestgreen","palegreen4", "olivedrab4", "olivedrab3","olivedrab",
                "goldenrod2","goldenrod","darkgoldenrod","gold2", "gold1", "gold",
                "maroon2", "hotpink2","violetred", "palevioletred","deeppink1"),
        with.legend = T, border = NA, cex.legend = .9,
        rows = 1,
        cols = 3)
#dev.off()

#plotting w/ *stark* contrast between the three main groupings of the alphabet
#(0-1 domains of adversity, 2 domains of adversity, and 3+ domains of adversity)
##png("clus_STARK3_dist.png", width=3000, height=1800, res = 600, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac3, type="d", 
        cpal= c("forestgreen","forestgreen", "forestgreen", "forestgreen","forestgreen",
                "gold1","gold1","gold1","gold1", "gold1", "gold1",
                "deeppink", "deeppink", "deeppink", "deeppink","deeppink"),
        sortv = "from.start", 
        with.legend = T, border = NA, cex.legend = .9,
        rows = 1,
        cols = 3)
##dev.off()
```


```{r}
####REPRESENTATIVE PLOTS####

### FREQUENCY ###

#3 clusters
#png("MDcluster_plot3_rep-freq.30.png", width=4000, height=1800, res = 600, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac3, type="r",
        cpal= c("forestgreen","palegreen4", "olivedrab4", "olivedrab3","olivedrab",
                "goldenrod2","goldenrod","darkgoldenrod","gold2", "gold1","gold",
                "maroon2", "hotpink2", "violetred", "palevioletred","deeppink1"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        diss= MD_dist,
        criterion= "freq",
        coverage= .30,
        rows = 1,
        cols = 3)
#dev.off()

### NEIGHBORHOOD DENSITY ###

#3 clusters
#png("MDcluster_plot3_rep-neigh.png", width=4000, height=1800, res = 600, pointsize = 7)
seqplot(MDseq, group = MD_cut_fac3, type="r",
        cpal= c("forestgreen","palegreen4", "olivedrab4", "olivedrab3","olivedrab",
                "goldenrod2","goldenrod","darkgoldenrod","gold2", "gold1","gold",
                "maroon2", "hotpink2", "violetred", "palevioletred","deeppink1"),
        sortv = "from.start",
        with.legend = T, border = NA, cex.legend = 1,
        diss= MD_dist,
        criterion= "density",
        pradius= 0.2,
        coverage= .30,
        rows = 1,
        cols = 3)
#dev.off()
```


# MODELING W/ MD CLUSTERS

## Data Cleaning, Imputing, and Wrangling
```{r}
set.seed(08540)
##PREPPING DATA
#creating outcome variable with the cluster assignments for each observation/sequence
clusterdf_MD <- as.data.frame(cdom_allwaves_avg_FULL$index) %>% 
  mutate(cluster_MD3= MD_cut3) %>% 
  mutate(cluster_MD4= MD_cut4) 
  #add CombT cluster assignments once I get it to work

colnames(clusterdf_MD)[1] <- "index"

#adding demographic variables to data frame
clusterdf_demo_MD <- bind_cols(clusterdf_MD, FF_adversity_FULL[1:11])
#adding additional demo/control variables
clusterdf_demo_MD <- bind_cols(clusterdf_demo_MD, FF_adversity_FULL[84:89],
                               FF$cm2hhinc, FF$cm3hhinc, FF$cm4hhinc, FF$cm5hhinc)

#converting race into character type
clusterdf_demo_MD <- clusterdf_demo_MD %>% 
  mutate(cm1ethrace= as.character(clusterdf_demo_MD$cm1ethrace))


#cleaning up new demo variables
clusterdf_demo_MD[clusterdf_demo_MD == "-3 Missing"] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == "-3"] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == "-9 Not in wave"] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == "-9"] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == "-6 skip"] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == "-6 Skip"] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == "-6"] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == -1.00] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == -2.00] <- NA
clusterdf_demo_MD[clusterdf_demo_MD == -5.00] <- NA

clusterdf_demo_MD <- clusterdf_demo_MD %>% 
  relocate(m1i2b, .before = m2k10a)

#renaming variables (col 14 to 31)
colnames(clusterdf_demo_MD)[4]<- c("mo_race_eth")
colnames(clusterdf_demo_MD)[5]<- c("mo_bornUS")
colnames(clusterdf_demo_MD)[6:10]<- c("mo_edu_wave0", "mo_edu_wave1", "mo_edu_wave2",
                                        "mo_edu_wave3", "mo_edu_wave4")
colnames(clusterdf_demo_MD)[11:15]<- c("mo_income_wave0", "mo_income_wave1", 
                                        "mo_income_wave2","mo_income_wave3", 
                                        "mo_income_wave4")
colnames(clusterdf_demo_MD)[16]<- c("mo_hh_income_wave0")
colnames(clusterdf_demo_MD)[17]<- c("mo_age_wave0")
colnames(clusterdf_demo_MD)[18]<- c("mo_prev_kids_wave0")
colnames(clusterdf_demo_MD)[19]<- c("mo_married_wave0")
colnames(clusterdf_demo_MD)[20]<- c("mo_cohab_wave0")
colnames(clusterdf_demo_MD)[21:24]<- c("mo_hh_income_wave1", 
                                        "mo_hh_income_wave2","mo_hh_income_wave3", 
                                        "mo_hh_income_wave4")


#checking distribution of variables I will impute prior to imputation 
# hist(clusterdf_demo_MD$mo_income_wave0)
# hist(clusterdf_demo_MD$mo_income_wave1)
# hist(clusterdf_demo_MD$mo_income_wave2)
# hist(clusterdf_demo_MD$mo_income_wave3)
# hist(clusterdf_demo_MD$mo_income_wave4)

#hist(clusterdf_demo_MD$mo_age_wave0)

#recoding some of the categorical variables
clusterdf_demo_MD <- clusterdf_demo_MD %>% 
  mutate(mo_edu_wave0 =
           case_when(mo_edu_wave0 %in% c("1 less hs") ~ 1,
                     mo_edu_wave0 %in% c("2 hs or equiv") ~ 2,
                     mo_edu_wave0 %in% c("3 some coll, tech") ~ 3,
                     mo_edu_wave0 %in% c("4 coll or grad") ~ 4))


##IMPUTING SELECT MISSING DEMO DATA
#selecting variables to impute
clusdf_select_MD <- bind_cols(clusterdf_demo_MD[6:15], clusterdf_demo_MD[17],
                              clusterdf_demo_MD[21:24])

colnames(clusdf_select_MD)

#imputing missing data for select demo/control variables
clusdf_select_MD_imp <- mice(data=clusdf_select_MD, m= 5, method = "pmm")

#examining imputed data
#head(complete(clusdf_select_MD_imp))

#creating an imputed data set
clusdf_select_MD_imp_comp <- complete(clusdf_select_MD_imp, "long", include = F)

#adding index for later grouping and generating avgs across imputed data sets
clusdf_select_MD_imp_comp$index <- rep(FF$index, times= 5)

clusdf_select_MD_imp_comp <- clusdf_select_MD_imp_comp %>% 
  relocate(index, .before= .id)

#generating average value of imputed variables across the imputed data sets
demoMD_imp_avgs <- clusdf_select_MD_imp_comp %>% 
  group_by(index) %>% 
  summarise(mean(mo_edu_wave0),
            mean(mo_edu_wave1),
            mean(mo_edu_wave2),
            mean(mo_edu_wave3),
            mean(mo_edu_wave4),
            mean(mo_income_wave0),
            mean(mo_income_wave1),
            mean(mo_income_wave2),
            mean(mo_income_wave3),
            mean(mo_income_wave4),
            mean(mo_age_wave0),
            mean(mo_hh_income_wave1),
            mean(mo_hh_income_wave2),
            mean(mo_hh_income_wave3),
            mean(mo_hh_income_wave4))

#creating new complete data set with imputed demographic/control variables
FF_MD_clus0 <- clusterdf_demo_MD %>% 
  mutate(mo_income_wave0= demoMD_imp_avgs$`mean(mo_income_wave0)`) %>%
  mutate(mo_income_wave1= demoMD_imp_avgs$`mean(mo_income_wave1)`) %>% 
  mutate(mo_income_wave2= demoMD_imp_avgs$`mean(mo_income_wave2)`) %>% 
  mutate(mo_income_wave3= demoMD_imp_avgs$`mean(mo_income_wave3)`) %>% 
  mutate(mo_income_wave4= demoMD_imp_avgs$`mean(mo_income_wave4)`) %>% 
  mutate(mo_age_wave0= demoMD_imp_avgs$`mean(mo_age_wave0)`) %>% 
  mutate(mo_hh_income_wave1= demoMD_imp_avgs$`mean(mo_hh_income_wave1)`) %>% 
  mutate(mo_hh_income_wave2= demoMD_imp_avgs$`mean(mo_hh_income_wave2)`) %>% 
  mutate(mo_hh_income_wave3= demoMD_imp_avgs$`mean(mo_hh_income_wave3)`) %>% 
  mutate(mo_hh_income_wave4= demoMD_imp_avgs$`mean(mo_hh_income_wave4)`)

#transforming education variable back to categorical, dropping values w/o edu in wave 0, 
#and adding substantive labels (removes 6 observations)
FF_MD_clus1 <- FF_MD_clus0 %>% 
  drop_na(mo_edu_wave0)  %>%
  mutate(mo_edu_wave0= case_when(mo_edu_wave0 %in% c(1) ~ "less hs",
                                 mo_edu_wave0 %in% c(2) ~ "hs or equiv",
                                 mo_edu_wave0 %in% c(3) ~ "some coll, tech",
                                 mo_edu_wave0 %in% c(4) ~ "coll or grad"))

#removing observations where the race/ethnicity of mother is missing (removes 11 observations)
FF_MD_clus <- FF_MD_clus1 %>% 
  drop_na(mo_race_eth)

#standardizing hh income variable for modeling
FF_MD_clus <- FF_MD_clus %>% 
  mutate(hh_income_stand= scale(mo_hh_income_wave0))

mean(FF_MD_clus$mo_hh_income_wave0)
hist(FF_MD_clus$mo_hh_income_wave0)

sum(is.na(FF_MD_clus$mo_hh_income_wave0))

# #Examining marginal distribution of average income at baseline and age
# #of mother at birth of focal child to ensure imputation worked properly
# hist(FF_MD_clus$mo_income_wave0) #income at baseline
# hist(FF_MD_clus$mo_age_wave0) #age of mother at baseline
  
#recoding clusters variable with substantive labels
FF_MD_clus <- FF_MD_clus %>%
  mutate(cluster_MD3_nom = case_when(cluster_MD3 %in% c(1) ~ "high (3+dom)",
                                 cluster_MD3 %in% c(2) ~ "low-med (0-1 dom)",
                                 cluster_MD3 %in% c(3) ~ "med (2 dom)")) %>%
  mutate(cluster_MD4_nom = case_when(cluster_MD4 %in% c(1) ~ "high (3+dom)",
                                 cluster_MD4 %in% c(2) ~ "mixed (?)",
                                 cluster_MD4 %in% c(3) ~ "low (0-1 dom)",
                                 cluster_MD4 %in% c(4) ~ "med (2 dom)")) 

#recoding race, clusters, and education at baseline as factors for modeling
FF_MD_clus$cluster_MD3_nom <- as.factor(FF_MD_clus$cluster_MD3_nom)
FF_MD_clus$cluster_MD4_nom <- as.factor(FF_MD_clus$cluster_MD4_nom)
FF_MD_clus$mo_race_eth <- as.factor(FF_MD_clus$mo_race_eth)
FF_MD_clus$mo_edu_wave0 <- as.factor(FF_MD_clus$mo_edu_wave0)
```

```{r}
#####checking to make sure education and income variables stay largely the same over time####
FF_MD_clus0_edu <- clusterdf_demo_MD %>% 
  mutate(mo_edu_wave0= round(demoMD_imp_avgs$`mean(mo_edu_wave0)`)) %>%
  mutate(mo_edu_wave1= round(demoMD_imp_avgs$`mean(mo_edu_wave1)`)) %>% 
  mutate(mo_edu_wave2= round(demoMD_imp_avgs$`mean(mo_edu_wave2)`)) %>% 
  mutate(mo_edu_wave3= round(demoMD_imp_avgs$`mean(mo_edu_wave3)`)) %>% 
  mutate(mo_edu_wave4= round(demoMD_imp_avgs$`mean(mo_edu_wave4)`)) %>%
  mutate(mo_income_wave0= demoMD_imp_avgs$`mean(mo_income_wave0)`) %>%
  mutate(mo_income_wave1= demoMD_imp_avgs$`mean(mo_income_wave1)`) %>% 
  mutate(mo_income_wave2= demoMD_imp_avgs$`mean(mo_income_wave2)`) %>% 
  mutate(mo_income_wave3= demoMD_imp_avgs$`mean(mo_income_wave3)`) %>% 
  mutate(mo_income_wave4= demoMD_imp_avgs$`mean(mo_income_wave4)`) %>% 
  mutate(mo_age_wave0= demoMD_imp_avgs$`mean(mo_age_wave0)`) %>% 
  mutate(mo_hh_income_wave1= demoMD_imp_avgs$`mean(mo_hh_income_wave1)`) %>% 
  mutate(mo_hh_income_wave2= demoMD_imp_avgs$`mean(mo_hh_income_wave2)`) %>% 
  mutate(mo_hh_income_wave3= demoMD_imp_avgs$`mean(mo_hh_income_wave3)`) %>% 
  mutate(mo_hh_income_wave4= demoMD_imp_avgs$`mean(mo_hh_income_wave4)`)

#png("education_dist_overwaves.png", width=4000, height=2000, res = 600, pointsize = 7)
FF_MD_clus0_edu %>% 
  select(mo_edu_wave0, mo_edu_wave1,mo_edu_wave2, mo_edu_wave3, mo_edu_wave4) %>%
  sapply(FUN = as.factor) %>% 
  as.data.frame() %>% 
  pivot_longer(cols = everything(), names_to = c("wave"), 
               values_to = "edu_level") %>% 
  ggplot(aes(x= wave, fill=edu_level)) +
  geom_bar(position = "dodge") +
  theme(axis.text= element_text(size = 10, colour = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  scale_fill_manual(name= "Education Level",
                    values = c("#b3de69","#8dd3c7", "#bebada", "#80b1d3"),
                    labels= c("Less than High School", "High School or Equiv", 
                              "Some College/Technical School",
                             "College or Graduate School")) +
  labs(x= "wave", y= "count") +
  scale_x_discrete(labels= c("baseline" ,"wave 1", "wave 2", "wave 3", "wave 4"))
#dev.off()



#png("hhincome_dist_overwaves.png", width=4000, height=2000, res = 600, pointsize = 7)
FF_MD_clus0 %>% 
  drop_na(mo_race_eth) %>% 
  select(mo_hh_income_wave0, mo_hh_income_wave1, mo_hh_income_wave2, mo_hh_income_wave3,
         mo_hh_income_wave4) %>%
  pivot_longer(cols = everything(), names_to = c("wave"), 
               values_to = "hh_income") %>% 
  ggplot(aes(y= hh_income, x=wave)) +
  geom_jitter(aes(color=wave), show.legend = F)+
  theme(axis.text= element_text(size = 10, colour = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  scale_x_discrete(labels= c("baseline" ,"wave 1", "wave 2", "wave 3", "wave 4")) +
  labs(y= "household income (dollars)")+
  ylim(0,750000)
#dev.off()
```

## Modeling w/ IDCD Clusters
```{r}
##SETTING REFERENCE LEVELS
#setting reference level as the white
FF_MD_clus$mo_race_eth <- relevel(FF_MD_clus$mo_race_eth, ref = "1 white, non-hispanic")

#setting reference level as the low adversity cluster 
FF_MD_clus$cluster_MD3_nom <- relevel(FF_MD_clus$cluster_MD3_nom, 
                                      ref = "low-med (0-1 dom)")
FF_MD_clus$cluster_MD4_nom <- relevel(FF_MD_clus$cluster_MD4_nom, 
                                      ref = "low (0-1 dom)")

#setting reference level as less than hs for education variable
FF_MD_clus$mo_edu_wave0 <- relevel(FF_MD_clus$mo_edu_wave0, ref = "less hs")

##MODELING W/ THREE CLUSTERS
## MODEL 1
# mother's race as sole predictor model 
mod1_MD3 <- multinom(formula = cluster_MD3_nom ~ mo_race_eth, data = FF_MD_clus)

summary(mod1_MD3)

z_mod1_MD3 <- summary(mod1_MD3)$coefficients/summary(mod1_MD3)$standard.errors
p_mod1_MD3 <- (1 - pnorm(abs(z_mod1_MD3), 0, 1)) * 2
p_mod1_MD3 

## MODEL 2
# mother's race as predictor w/ education and income of mother at focal child's 
# birth as covariates 
mod2_MD3 <- multinom(formula = cluster_MD3_nom ~ mo_race_eth + 
                                     mo_edu_wave0 + hh_income_stand, 
                                   data = FF_MD_clus)
summary(mod2_MD3)

z_mod2_MD3 <- summary(mod2_MD3)$coefficients/summary(mod2_MD3)$standard.errors
p_mod2_MD3 <- (1 - pnorm(abs(z_mod2_MD3), 0, 1)) * 2
p_mod2_MD3 

## MODEL 3
# mother's race as predictor w/ education, income, and age of mother at focal child's 
# birth as covariates 
mod3_MD3 <- multinom(formula = cluster_MD3_nom ~ mo_race_eth + 
                                     hh_income_stand + mo_edu_wave0 +
                                     mo_age_wave0, 
                                   data = FF_MD_clus)

summary(mod3_MD3)

z_mod3_MD3 <- summary(mod3_MD3)$coefficients/summary(mod3_MD3)$standard.errors
p_mod3_MD3 <- (1 - pnorm(abs(z_mod3_MD3), 0, 1)) * 2
p_mod3_MD3 
```


```{r, results='asis'}
stargazer(mod1_MD3, mod3_MD3,
          star.cutoffs = c(0.05, 0.01, 0.001),
          model.numbers = F,
          column.labels = c("Model 1", "Model 2"),
          column.separate = c(2, 2),
          dep.var.caption = "Cluster Assignment",
          covariate.labels = c("Black Non-Hispanic",
                               "Hispanic",
                               "Other Race/Ethnicity",
                               "High School or Equiv",
                               "Some College, Technical School",
                               "College or Graduate School",
                               "Income (Standardized)",
                               "Mother's Age at Birth of Focal Child",
                               "Constant"),
          header = F,
          keep.stat = c("all"),
          font.size= "small",
          order= c(1, 2, 3, 6, 7, 5, 4,8, 9),
          column.sep.width = "3pt",
          notes.append = F)
```


# EXAMINING WHAT IS DRIVING THE CLUSTERING PATTERNS & MODEL RESULTS

## Examining Clusters Against Conventional Poverty Measure

```{r}
#extracting relevant variables 
FF_MD_POV <- FF %>% 
  subset(select= c(index,
                   cm1povca, cm2povca, cm3povca, cm4povca, cm5povca))

#renaming to more intutive variable names
colnames(FF_MD_POV)[2:6] <- c("mo_pov_wave0","mo_pov_wave1","mo_pov_wave2", 
                            "mo_pov_wave3", "mo_pov_wave4")

#cleaning missing data
FF_MD_POV[FF_MD_POV == "-3 Missing"] <- NA
FF_MD_POV[FF_MD_POV == "-3"] <- NA
FF_MD_POV[FF_MD_POV == "-9 Not in wave"] <- NA
FF_MD_POV[FF_MD_POV == "-9"] <- NA
FF_MD_POV[FF_MD_POV == "-6 skip"] <- NA
FF_MD_POV[FF_MD_POV == "-6 Skip"] <- NA
FF_MD_POV[FF_MD_POV == "-6"] <- NA
FF_MD_POV[FF_MD_POV == "-2 Don't know"] <- NA
FF_MD_POV[FF_MD_POV == "-10 no child(ren)/ no need for care"] <- NA

#changing class of variables for recoding
for(i in 2:6){
  FF_MD_POV[,i] <- to_character(FF_MD_POV[,i])
}

#recording variables
FF_MD_POV <- FF_MD_POV %>% 
  mutate(mo_pov_wave0=
           case_when(mo_pov_wave0 %in% c("1 0-49%") ~ 1,
                     mo_pov_wave0 %in% c("2 50-99%") ~ 2,
                     mo_pov_wave0 %in% c("3 100-199%") ~ 3,
                     mo_pov_wave0 %in% c("4 200-299%") ~ 4,
                     mo_pov_wave0 %in% c("300%+") ~ 5)) %>%
  mutate(mo_pov_wave1=
           case_when(mo_pov_wave1 %in% c("1 0-49%") ~ 1,
                     mo_pov_wave1 %in% c("2 50-99%") ~ 2,
                     mo_pov_wave1 %in% c("3 100-199%") ~ 3,
                     mo_pov_wave1 %in% c("4 200-299%") ~ 4,
                     mo_pov_wave1 %in% c("5 300%+") ~ 5)) %>% 
  mutate(mo_pov_wave2=
           case_when(mo_pov_wave2 %in% c("1 0-49%") ~ 1,
                     mo_pov_wave2 %in% c("2 50-99%") ~ 2,
                     mo_pov_wave2 %in% c("3 100-199%") ~ 3,
                     mo_pov_wave2 %in% c("4 200-299%") ~ 4,
                     mo_pov_wave2 %in% c("5 300%+") ~ 5)) %>% 
  mutate(mo_pov_wave3=
           case_when(mo_pov_wave3 %in% c("1 0-49%") ~ 1,
                     mo_pov_wave3 %in% c("2 50-99%") ~ 2,
                     mo_pov_wave3 %in% c("3 100-199%") ~ 3,
                     mo_pov_wave3 %in% c("4 200-299%") ~ 4,
                     mo_pov_wave3 %in% c("5 300%+") ~ 5))
#changing class into numeric for imputation
for(i in 6){
  FF_MD_POV[,i] <- as.numeric(FF_MD_POV[,i])
}
```

```{r, warning=FALSE}
#### IMPUTING MISSING DATA ####
set.seed(08540)
#determining average number of missing-- necessary? could guide m value
#making data frame of just poverty values (no demographic values)
FF_MD_POV_ONLY <- FF_MD_POV[,c(2:6)]

#imputing missing data
FF_MD_POV_ONLY_imp <- mice(data=FF_MD_POV_ONLY, m= 5, method = "pmm")

#creating imputed data set
FF_MD_POV_comp <- complete(FF_MD_POV_ONLY_imp) %>% 
  mutate(index= FF_MD_POV$index) %>% 
  relocate(index, .before = mo_pov_wave0)
```


```{r}
#recoding poverty variables into three levels (0-99%=3 // 100%-199$=2 // 200%+=1)
FF_MD_POV_base0 <- FF_MD_POV_comp %>% 
  mutate(mo_pov_wave0=
           case_when(mo_pov_wave0 %in% c(1,2) ~ 3,
                     mo_pov_wave0 %in% c(3) ~ 2,
                     mo_pov_wave0 %in% c(4, 5) ~ 1)) 

#removing mothers with missing demographic data (race & basline wave of edu)
FF_MD_POV_base <- FF_MD_POV_base0 %>% 
  mutate(mo_race_eth= FF_MD_clus0$mo_race_eth ) %>% 
  mutate(edu0= FF_MD_clus0$mo_edu_wave0) %>% 
  drop_na(edu0) %>% 
  drop_na(mo_race_eth)

#getting poverty distribution of sample
FF_MD_POV_counts <-FF_MD_POV_base %>% 
  select(mo_pov_wave0) %>% 
  count(mo_pov_wave0) %>% 
  mutate(mo_pov_wave0= c("200%+ pov level", "100%-199% pov level", 
                         "<100% pov level"))

FF_MD_clus <- FF_MD_clus %>% 
  mutate(mo_pov_wave0= FF_MD_POV_base$mo_pov_wave0) %>% 
  mutate(mo_pov_wave0= 
           case_when(mo_pov_wave0 %in% c(3) ~ "<100% pov level",
                     mo_pov_wave0 %in% c(2) ~ "100%-199% pov level",
                     mo_pov_wave0 %in% c(1) ~ "200%+ pov level"))

FF_MD_clus_select_pov <- FF_MD_clus %>% 
  select(cluster_MD3_nom, mo_pov_wave0) %>% 
  count(mo_pov_wave0, cluster_MD3_nom) %>% 
  group_by(mo_pov_wave0, cluster_MD3_nom) %>% 
  summarise(count= sum(n)) %>% 
  ungroup %>% 
  mutate(total= case_when(mo_pov_wave0 %in% c("<100% pov level") ~ 1761,
                          mo_pov_wave0 %in% c("100%-199% pov level") ~ 1258,
                          mo_pov_wave0 %in% c("200%+ pov level") ~ 1862)) %>% 
  mutate(prop_clus= round(count/total, digits = 3)) 



FF_MD_clus_select_pov$cluster_MD3_nom <- factor(FF_MD_clus_select_pov$cluster_MD3_nom,
                                                levels = c("low-med (0-1 dom)",
                                                            "med (2 dom)",
                                                            "high (3+dom)"),
                                                labels = c("Low-Medium (0-1 Domains)",
                                                            "Medium (2 Domains)",
                                                            "High (3+ Domains)"))

#plotting as bar graph--proportions
MD_clus_pov_bar_prop <- ggplot(FF_MD_clus_select_pov, aes(x= mo_pov_wave0, 
                                                           y= prop_clus, 
                                                           fill= cluster_MD3_nom,
                                                           label = prop_clus)) +
  geom_col() +
  labs(title = "Distribution of MD Clusters by Poverty Status by Proportion (n=4,881)",
       x= "Poverty Status",
       y= "Proportion of Mothers of that Poverty Status")+
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  scale_fill_manual(name= "Cluster Assigment", 
                    values= c("#1b9e77","#7570b3","#d95f02")) +
  coord_flip() 
MD_clus_pov_bar_prop

##ggsave(file="Dist_MD_clus_pov_bar_prop.png", MD_clus_pov_bar_prop, width = 8, height = 5.43, units = "in")

#Plotting w/ Clusters on y-axis
FF_MD_POV_counts_y <- FF_MD_POV_base %>% 
  mutate(cluster_MD3_nom = FF_MD_clus$cluster_MD3_nom) %>% 
  select(cluster_MD3_nom) %>% 
  count(cluster_MD3_nom) 

FF_MD_clus_select_pov_y <- FF_MD_clus %>% 
  select(cluster_MD3_nom, mo_pov_wave0) %>% 
  count(mo_pov_wave0, cluster_MD3_nom) %>% 
  group_by(mo_pov_wave0, cluster_MD3_nom) %>% 
  summarise(count= sum(n)) %>% 
  ungroup %>% 
  mutate(total= case_when(cluster_MD3_nom %in% c("low-med (0-1 dom)") ~ 1450,
                          cluster_MD3_nom %in% c("high (3+dom)") ~ 2270,
                          cluster_MD3_nom %in% c("med (2 dom)") ~ 1161)) %>% 
  mutate(prop_clus= round(count/total, digits = 3)) 

FF_MD_clus_select_pov_y$cluster_MD3_nom <- factor(FF_MD_clus_select_pov_y$cluster_MD3_nom,
                                                levels = c("low-med (0-1 dom)",
                                                            "med (2 dom)",
                                                            "high (3+dom)"),
                                                labels = c("Low-Medium (0-1 Domains)",
                                                            "Medium (2 Domains)",
                                                            "High (3+ Domains)"))

#plotting as bar graph--proportions
MD_clus_pov_bar_prop_y <- ggplot(FF_MD_clus_select_pov_y, aes(x= prop_clus, 
                                                       y= cluster_MD3_nom, 
                                                 fill= mo_pov_wave0,
                                                 label = prop_clus)) +
  geom_col() +
  labs(x= "Proportion of Mothers of that Cluster",
       y= "Cluster Assignment")+
  geom_text(size = 4, position = position_stack(vjust = 0.5), color= "white") +
  theme(axis.text= element_text(size = 10, colour = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  scale_fill_manual(name= "Cluster Assigment", 
                    values= c("#d95f02","#7570b3","#1b9e77"))
MD_clus_pov_bar_prop_y

##ggsave(file="Dist_MD_clus_pov_bar_prop-y.png", MD_clus_pov_bar_prop_y,width = 10, height = 5.43, units = "in", dpi = 600)

```

## Examining Cluster Distributions 

## By Race
```{r}
FF_MD_clus_race_counts <- FF_MD_clus %>% 
  select(mo_race_eth) %>% 
  drop_na(mo_race_eth) %>% 
  count(mo_race_eth) %>% 
  mutate(mo_race_eth= c("White, Non-Hispanic", "Black, Non-Hispanic",
                        "Hispanic", "Other"))


FF_MD_clus_select_race <- FF_MD_clus %>% 
  select(cluster_MD3_nom, mo_race_eth) %>% 
  count(mo_race_eth, cluster_MD3_nom) %>% 
  group_by(mo_race_eth, cluster_MD3_nom) %>% 
  summarise(count= sum(n)) %>% 
  ungroup %>% 
  mutate(total= case_when(mo_race_eth %in% c("1 white, non-hispanic") ~ 1030,
                          mo_race_eth %in% c("2 black, non-hispanic") ~ 2324,
                          mo_race_eth %in% c("3 hispanic") ~ 1334,
                          mo_race_eth %in% c("4 other") ~ 193)) %>% 
  mutate(prop_clus= round(count/total, digits = 2)) 


FF_MD_clus_select_race$cluster_MD3_nom <- factor(FF_MD_clus_select_race$cluster_MD3_nom,
                                                levels = c("low-med (0-1 dom)",
                                                            "med (2 dom)",
                                                            "high (3+dom)"),
                                                labels = c("Low-Medium (0-1 Domains)",
                                                            "Medium (2 Domains)",
                                                            "High (3+ Domains)"))

##plotting proportions##
MD_clus_race_bar_prop <- ggplot(FF_MD_clus_select_race, aes(x= mo_race_eth, y= prop_clus, 
                                                 fill= cluster_MD3_nom,
                                                 label = prop_clus)) +
  geom_col() +
  labs(x= "Mothers' Race/Ethnicity",
       y= "Proportion of Mothers of that Race/Ethnicity")+
  geom_text(size = 4, position = position_stack(vjust = 0.5), color= "white") +
  theme(axis.text= element_text(size = 10, colour = "black"),
        axis.title = element_text(color = "black", face = "bold")) +
  coord_flip() +
  scale_x_discrete(labels= c("White, Non-Hispanic (n=1030)", "Black, Non-Hispanic (n=2324)",
                             "Hispanic (n=1334)", "Other Race/Ethnicity (n=193)")) +
  scale_fill_manual(name= "Cluster Assignment",
                    values = c("#4daf4a", "#984ea3","#e41a1c")) 

##ggsave(file="Dist_MD_Clus_Race_prop.png", MD_clus_race_bar_prop, width = 10, height = 5.43, units = "in", dpi = 600)
MD_clus_race_bar_prop

```

## By Education (at baseline)
```{r}
FF_MD_clus_edu_counts <- FF_MD_clus %>% 
  select(mo_edu_wave0) %>% 
  count(mo_edu_wave0) %>% 
  mutate(mo_edu_wave0= c("less hs", "coll or grad",
                        "hs or equiv", "some coll, tech"))


FF_MD_clus_select_edu <- FF_MD_clus %>% 
  select(cluster_MD3_nom, mo_edu_wave0) %>% 
  count(mo_edu_wave0, cluster_MD3_nom) %>% 
  group_by(mo_edu_wave0, cluster_MD3_nom) %>% 
  summarise(count= sum(n)) %>% 
  ungroup() %>% 
  mutate(total= case_when(mo_edu_wave0 %in% c("less hs") ~ 1697,
                          mo_edu_wave0 %in% c("coll or grad") ~ 524,
                          mo_edu_wave0 %in% c("hs or equiv") ~ 1475,
                          mo_edu_wave0 %in% c("some coll, tech") ~ 1185)) %>% 
  mutate(prop_clus= round(count/total, digits = 2))

FF_MD_clus_select_edu$cluster_MD3_nom <- factor(FF_MD_clus_select_edu$cluster_MD3_nom,
                                                levels = c("low-med (0-1 dom)",
                                                            "med (2 dom)",
                                                            "high (3+dom)"),
                                                labels = c("Low-Medium (0-1 Domains)",
                                                            "Medium (2 Domains)",
                                                            "High (3+ Domains)"))


#plotting by proportions
Dist_MD_Clus_Edu_Prop <- ggplot(FF_MD_clus_select_edu, aes(x= mo_edu_wave0, y= prop_clus, 
                                  fill= cluster_MD3_nom,
                                  label= prop_clus)) +
  geom_col() +
  labs(title = "Distribution of MD Clusters by Baseline Education of Mother 
       by Proportion (n=4,881)",
       x= "Cluster Type",
       y= "Proportion of Mothers of that Education Level")+
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  theme_bw()+
  coord_flip() +
  scale_x_discrete(labels= c("less hs", "hs or equiv", "some coll, tech",
                             "coll or grad")) +
  scale_fill_manual(name= "Cluster Assignment",
                    values = c("#b3de69","#bebada", "#fb8072"))

##ggsave(file="Dist_MD_Clus_Edu_Prop.png", Dist_MD_Clus_Edu_Prop, width = 8, height = 5.43, units = "in")
Dist_MD_Clus_Edu_Prop
```

# LOOKING CLOSER INTO EACH CLUSTER BY DEMOGRAPHIC GROUPS

## Examining Cummulative Adversity Scores by Race/Cluster 
```{r}
#wrangling/cleaning data
FF_adv.comp_FULL$index <- rep(FF$index, times= 5)

col_names_FF <- colnames(FF_adv.comp_FULL)[3:74]

FF_test <- FF_adv.comp_FULL %>% 
  relocate(index, .before = wave1_fjail) %>% 
  subset(select = -c(.imp, .id)) %>% 
  group_by(index) %>% 
  summarise_all(mean) 


FF_MD_adv <- as.data.frame(ifelse(FF_test[2:73] >0, 1, 0)) %>% 
  mutate(index= FF_test$index,
       mo_race_eth= clusterdf_demo_MD$mo_race_eth,
       cluster_assign= clusterdf_demo_MD$cluster_MD3) %>% 
  relocate(c(index, cluster_assign, mo_race_eth), .before = wave1_fjail) 

#getting cumulative adversity scores for each mother for each wave
w1_sums_all <- FF_MD_adv %>% 
  select(starts_with("wave1")) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "wave1_sums"))

w2_sums_all <- FF_MD_adv %>% 
  select(starts_with("wave2")) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "wave2_sums"))

w3_sums_all <- FF_MD_adv %>% 
  select(starts_with("wave3")) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "wave3_sums"))

w4_sums_all <- FF_MD_adv %>% 
  select(starts_with("wave4")) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "wave4_sums"))

#getting cumulative adversity across all four waves for each mother
all_waves_sums <- cbind(w1_sums_all , w2_sums_all,w3_sums_all ,w4_sums_all) %>% 
  rowSums() %>% 
  as.data.frame() %>% 
  rename(c('.'= "allwaves_sums"))

#creating a data frame with all five cummulative adversity scores (total & each wave)
sums_df <-cbind(w1_sums_all , w2_sums_all,w3_sums_all ,w4_sums_all, all_waves_sums) %>%  
  mutate(index= FF_MD_adv$index,
         mo_race_eth= FF_MD_adv$mo_race_eth,
         cluster_assign = FF_MD_adv$cluster_assign) %>% 
  relocate(c(index, mo_race_eth, cluster_assign), .before = everything()) 

#re-labeling variables for plotting
sums_df_factor <- sums_df

sums_df_factor$mo_race_eth <- factor(sums_df_factor$mo_race_eth,
                                     levels = c("1 white, non-hispanic", 
                                                   "2 black, non-hispanic",
                                                   "3 hispanic", "4 other"),
                                     labels = c("White, Non-Hispanic", 
                                                   "Black, Non-Hispanic",
                                                   "Hispanic", "Other Race/Ethnicity"))

sums_df_factor$cluster_assign <- factor(sums_df_factor$cluster_assign,
                                        levels = c(1, 3, 2),
                                        labels = c("High (3-4 Domains)",
                                                   "Medium (2 Domains)",
                                                   "Low-Medium (0-1 Domains)"))

#plotting cummulative adversity scores across all four waves faceted by cluster and race

#png("all_adv_sums_hist_bycluster_race.png", width=5000, height=3500, res = 600, pointsize = 7)
sums_df_factor %>%
  drop_na(mo_race_eth) %>%
  ggplot(aes(x=allwaves_sums, fill=mo_race_eth)) +
  geom_histogram(position = "identity", col=I("black"), bins = 20) +
  # geom_vline(aes(xintercept=15), color="black", linetype="dashed") + 
  scale_fill_manual(values = c("#e41a1c","#4daf4a", "#984ea3","#e6ab02"),
                    guide= "none")+
  facet_wrap(~ cluster_assign + mo_race_eth,
             nrow= 3) +
  labs(x= "Total Number of Adverse Experiences", y= "Number of Mothers")+
  theme(strip.text.x = element_text(
        size = 9, color = "black"),
        strip.background.x = element_rect(linetype = "solid", fill = "white",
                                          linewidth = 1, color = "black"),
        panel.background = element_rect(fill = "white"),
        axis.title = element_text(colour = "black", face = "bold"))
#dev.off

```

## Examining Clusters at Individual Adverse Event Level 

### High Adversity Cluster 

```{r}
#black high cluster mothers
MD_adv_long_high_black <- FF_MD_adv %>% 
  filter(cluster_assign== 1,
         mo_race_eth== "2 black, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_black= round(num_yes/1204, digits = 2))

#hispanic high cluster mothers
MD_adv_long_high_hisp <- FF_MD_adv %>% 
  filter(cluster_assign== 1,
         mo_race_eth== "3 hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_hisp= round(num_yes/654, digits = 2))

#'other' high cluster mothers
MD_adv_long_high_other <- FF_MD_adv %>% 
  filter(cluster_assign== 1,
         mo_race_eth== "4 other") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_other= round(num_yes/77, digits = 2))

#white high cluster mothers
MD_adv_long_high_white <- FF_MD_adv %>% 
  filter(cluster_assign== 1,
         mo_race_eth== "1 white, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_white= round(num_yes/339, digits = 2))

#all mothers (full data set)
MD_adv_long_high <- FF_MD_adv %>% 
  filter(cluster_assign== 1) %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_all= round(num_yes/2281, digits = 2)) %>% 
  mutate(prop_black = MD_adv_long_high_black$prop_black) %>% 
  mutate(prop_hispanic = MD_adv_long_high_hisp$prop_hisp) %>%
  mutate(prop_other = MD_adv_long_high_other$prop_other) %>% 
  mutate(prop_white = MD_adv_long_high_white$prop_white) 

MD_longer_high <- MD_adv_long_high %>% 
  pivot_longer(cols = c(prop_black, prop_hispanic, prop_other, prop_white), names_to = c("category"), 
               values_to = "props") %>% 
  mutate(category= case_when(category== "prop_black" ~ "Black, non-Hispanic",
                             category== "prop_hispanic" ~ "Hispanic",
                             category== "prop_other" ~ "Other",
                             category== "prop_white" ~ "White"))
```

```{r, fig.height=9, fig.width=9}
#plotting 
w1_MD <-MD_longer_high %>% 
  filter(str_detect(adversity, "wave1")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x=props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL, title = "Wave 1 (Y1)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c"))  +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w2_MD <-MD_longer_high %>% 
  filter(str_detect(adversity, "wave2")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 2 (Y3)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w3_MD <-MD_longer_high %>% 
  filter(str_detect(adversity, "wave3")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 3 (Y5)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w4_MD <-MD_longer_high %>% 
  filter(str_detect(adversity, "wave4")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 4 (Y9)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

prop_grid <- grid.arrange(w1_MD, w2_MD, w3_MD, w4_MD,
                          left= "Adverse Event",
                          bottom= "Proportion of Racial/Ethnic Group")


##ggsave(file="Bar_Adv_Prop_byRace_High.png", prop_grid, width = 10, height = 5.43, units = "in", dpi = 600)

```

### Medium Adversity Cluster 

```{r}
#black medium cluster mothers
MD_adv_long_medium_black <- FF_MD_adv %>% 
  filter(cluster_assign== 3,
         mo_race_eth== "2 black, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_black= round(num_yes/630, digits = 2))

#hispanic medium cluster mothers
MD_adv_long_medium_hisp <- FF_MD_adv %>% 
  filter(cluster_assign== 3,
         mo_race_eth== "3 hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_hisp= round(num_yes/336, digits = 2))

#'other' medium cluster mothers
MD_adv_long_medium_other <- FF_MD_adv %>% 
  filter(cluster_assign== 3,
         mo_race_eth== "4 other") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_other= round(num_yes/42, digits = 2))

#white medium cluster mothers
MD_adv_long_medium_white <- FF_MD_adv %>% 
  filter(cluster_assign== 3,
         mo_race_eth== "1 white, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_white= round(num_yes/154, digits = 2))

#all mothers (full data set)
MD_adv_long_medium <- FF_MD_adv %>% 
  filter(cluster_assign== 3) %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_all= round(num_yes/1164, digits = 2)) %>% 
  mutate(prop_black = MD_adv_long_medium_black$prop_black) %>% 
  mutate(prop_hispanic = MD_adv_long_medium_hisp$prop_hisp) %>%
  mutate(prop_other = MD_adv_long_medium_other$prop_other) %>% 
  mutate(prop_white = MD_adv_long_medium_white$prop_white) 

MD_longer_medium <- MD_adv_long_medium %>% 
  pivot_longer(cols = c(prop_black, prop_hispanic, prop_other, prop_white), names_to = c("category"), 
               values_to = "props") %>% 
  mutate(category= case_when(category== "prop_black" ~ "Black, non-Hispanic",
                             category== "prop_hispanic" ~ "Hispanic",
                             category== "prop_other" ~ "Other",
                             category== "prop_white" ~ "White"))
```

```{r, fig.height=9, fig.width=9}
#plotting 
w1_MD <-MD_longer_medium %>% 
  filter(str_detect(adversity, "wave1")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x=props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL, title = "Wave 1 (Y1)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))


w2_MD <-MD_longer_medium %>% 
  filter(str_detect(adversity, "wave2")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 2 (Y3)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w3_MD <-MD_longer_medium %>% 
  filter(str_detect(adversity, "wave3")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 3 (Y5)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w4_MD <-MD_longer_medium %>% 
  filter(str_detect(adversity, "wave4")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 4 (Y9)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

prop_grid <- grid.arrange(w1_MD, w2_MD, w3_MD, w4_MD,
                          left= "Adverse Event",
                          bottom= "Proportion of Racial/Ethnic Group")

##ggsave(file="Bar_Adv_Prop_byRace_Medium.png", prop_grid, width = 10, height = 5.43, units = "in")

```

### Low-Medium Adversity Cluster 

```{r}
#black low-med cluster mothers
MD_adv_long_low_med_black <- FF_MD_adv %>% 
  filter(cluster_assign== 2,
         mo_race_eth== "2 black, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_black= round(num_yes/492, digits = 2))

#hispanic low-med cluster mothers
MD_adv_long_low_med_hisp <- FF_MD_adv %>% 
  filter(cluster_assign== 2,
         mo_race_eth== "3 hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_hisp= round(num_yes/346, digits = 2))

#'other' low-med cluster mothers
MD_adv_long_low_med_other <- FF_MD_adv %>% 
  filter(cluster_assign== 2,
         mo_race_eth== "4 other") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_other= round(num_yes/75, digits = 2))

#white low-med cluster mothers
MD_adv_long_low_med_white <- FF_MD_adv %>% 
  filter(cluster_assign== 2,
         mo_race_eth== "1 white, non-hispanic") %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_white= round(num_yes/537, digits = 2))

#all mothers (full data set)
MD_adv_long_low_med <- FF_MD_adv %>% 
  filter(cluster_assign== 2) %>% 
  subset(select= -c(index, mo_race_eth, cluster_assign)) %>% 
  summarise_all(sum) %>% 
  pivot_longer(cols = everything(), names_to = c("adversity"), 
               values_to = "num_yes") %>% 
  mutate(prop_all= round(num_yes/2281, digits = 2)) %>% 
  mutate(prop_black = MD_adv_long_low_med_black$prop_black) %>% 
  mutate(prop_hispanic = MD_adv_long_low_med_hisp$prop_hisp) %>%
  mutate(prop_other = MD_adv_long_low_med_other$prop_other) %>% 
  mutate(prop_white = MD_adv_long_low_med_white$prop_white) 

MD_longer_low_med <- MD_adv_long_low_med %>% 
  pivot_longer(cols = c(prop_black, prop_hispanic, prop_other, prop_white), names_to = c("category"), 
               values_to = "props") %>% 
  mutate(category= case_when(category== "prop_black" ~ "Black, non-Hispanic",
                             category== "prop_hispanic" ~ "Hispanic",
                             category== "prop_other" ~ "Other",
                             category== "prop_white" ~ "White"))
```

```{r, fig.height=9, fig.width=9}
#plotting 
w1_MD <-MD_longer_low_med %>% 
  filter(str_detect(adversity, "wave1")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x=props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL, title = "Wave 1 (Y1)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w2_MD <-MD_longer_low_med %>% 
  filter(str_detect(adversity, "wave2")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 2 (Y3)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w3_MD <-MD_longer_low_med %>% 
  filter(str_detect(adversity, "wave3")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 3 (Y5)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

w4_MD <-MD_longer_low_med %>% 
  filter(str_detect(adversity, "wave4")) %>% 
  ggplot() +
  geom_col(mapping = aes(y= adversity, x= props, fill= category), position = "dodge") +
  labs(x= NULL, y= NULL,title = "Wave 4 (Y9)") +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_discrete(labels=c("$1k cosign",
                            "$1k loan",
                            "$200 loan",
                            "$5k cosign",
                            "depressed",
                            "lack of emergency care",
                            "evicted",
                            "father jailed",
                            "father issues",
                            "need food assist",
                            "utilities cut",
                            "gone hungry",
                            "forced move",
                            "houselessness",
                            "partner jail",
                            "public housing",
                            "side hustle",
                            "tele disconnect")) +
  scale_fill_manual(name= "Racial/Ethnic Group",
                    values = c("#4daf4a", "#984ea3","#e6ab02","#e41a1c")) +
  theme(axis.text= element_text(size = 9, colour = "black"),
        axis.title = element_text(colour = "black", face = "bold"))

prop_grid <- grid.arrange(w1_MD, w2_MD, w3_MD, w4_MD,
                          left= "Adverse Event",
                          bottom= "Proportion of Racial/Ethnic Group")

# ?grid.arrange

##ggsave(file="Bar_Adv_Prop_byRace_low-med.png", prop_grid, width = 10, height = 5.43, units = "in")

```


# GETTING DESCRIPTIVE TABLE OF ANALYTIC SAMPLE

```{r}
descripMD <- FF_MD_clus %>% 
  select(mo_race_eth, mo_edu_wave0, mo_hh_income_wave0, 
         mo_age_wave0, mo_prev_kids_wave0, mo_married_wave0, mo_cohab_wave0)

descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "0"] <- "Not married"
descripMD$mo_married_wave0[descripMD$mo_married_wave0 == "1"] <- "Married"

descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "0"] <- "Not Cohabitating"
descripMD$mo_cohab_wave0[descripMD$mo_cohab_wave0 == "1"] <- "Cohabitating"

label(descripMD$mo_hh_income_wave0) <- "Mother's Household Income at Baseline (per year)"
label(descripMD$mo_race_eth) <- "Race/Ethnicity"
label(descripMD$mo_edu_wave0) <- "Education at Baseline"
label(descripMD$mo_married_wave0) <- "Mother Married to Bio Dad at Baseline"
label(descripMD$mo_cohab_wave0) <- "Mother Cohabitating w/ Bio Dad at Baseline"
label(descripMD$mo_age_wave0) <- "Age at Birth of Focal Child"
label(descripMD$mo_prev_kids_wave0) <- "Number of Prev Kids at Birth of Focal Child"

descripMD_table <- table1(~mo_hh_income_wave0 + mo_race_eth + 
                          mo_edu_wave0 + mo_age_wave0 + mo_prev_kids_wave0 +
                          mo_married_wave0 + mo_cohab_wave0, 
                        data = descripMD)

descripMD_table

# #png("Sample_Table.png", width = 550, height = 550)
# apa_table(descripMD_table)
# #dev.off()

median(descripMD$mo_hh_income_wave0)
```

```{r}
descrip_clus_MD <- FF_MD_clus %>% 
  select(cluster_MD3_nom)

label(descrip_clus_MD$cluster_MD3_nom) <- "Cluster Assignment"


descrip_table_clus_MD <- table1(~cluster_MD3_nom, 
                        data = descrip_clus_MD)

descrip_table_clus_MD
#knitr::kable(descrip_table_clus_MD)

#png("Sample_Table.png", width = 550, height = 550)
#table1(~cluster_MD3_nom, data = descrip_clus_MD)
#dev.off()
```

